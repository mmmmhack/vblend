<html>
<head>
<link rel="stylesheet" type="text/css" href="css/style.css"/>
<script src="js/script.js"></script>
<title>devlog - wknight - vblend</title>
</head>
<body onload="main()">
<h1>devlog - wknight - vblend</h1>

<h2>2011-07-02</h2>

<p>
This is a project that aims to provide a vim-like interface to a blender-like 3D graphics editor.
Since freeglut is borked on my macbook, I'll start out with the glfw library to provide the main
window. Will also look through my other projects for C code to render text using bitmaps in
an opengl window - pretty sure the cbots project did that.
</p>

<p>
Read through my devlog for cbots project. Will use the font-rendering code in there, but
will use glfw instead of sdl for window management. glfw looks pretty clean and simple.
</p>

<p>
Got the howdy glfw window app to build and run. glfw is VERY clean and good. It has the 
simplest and most transparent build framework for a Mac OSX OpenGL app that I have ever seen.
It puts the ludicrously complex XCode framework utterly to shame.
</p>

<h2>2011-07-06</h2>

<p>
Up normal time, just a little time to code.
</p>

<p>
I spend most of it getting idutils running on cbots and then finding my project scripts to
remind me how to show osx apps:
</p>
<pre>
mhackslab:find $ find ~/proj -type f -perm +111 | xargs file | grep text | awk -F ':' '{print $1}' | xargs grep -i "osa"
/Users/williamknight/proj/game/irrlicht/cl_terrain_test/rr.sh:osascript -e 'tell application "terrain_test" to activate'
/Users/williamknight/proj/mirabai/timer/rr:osascript -e 'tell application "Python" to activate'
/Users/williamknight/proj/modwest/biochem/barbwright/mfg-1.2/src/mfg/a:osascript -e 'tell application "mfg" to activate'
/Users/williamknight/proj/modwest/biochem/barbwright/mfg-1.2/src/mfg/d:#osascript -e 'tell application "mfg" to activate'
/Users/williamknight/proj/modwest/biochem/barbwright/mfg-1.2/src/mfg/r:osascript -e 'tell application "mfg" to activate'
/Users/williamknight/proj/modwest/biochem/barbwright/src/mfg/a:osascript -e 'tell application "mfg" to activate'
/Users/williamknight/proj/modwest/biochem/barbwright/src/mfg/d:#osascript -e 'tell application "mfg" to activate'
/Users/williamknight/proj/modwest/biochem/barbwright/src/mfg/r:osascript -e 'tell application "mfg" to activate'
/Users/williamknight/proj/test/python/tkinter/sclient/rr:osascript -e 'tell application "Python" to activate'
/Users/williamknight/proj/test/qt/glterrain/a:osascript -e 'tell application "main" to activate'
/Users/williamknight/proj/test/qt/glterrain/r:osascript -e 'tell application "main" to activate'
/Users/williamknight/proj/test/qt/howdy/r:osascript -e 'tell app "howdy" to activate'
/Users/williamknight/proj/test/qt/linux-crash/r:osascript -e 'tell app "main" to activate'
/Users/williamknight/proj/test/qt/manual-stretch/r:osascript -e 'tell application "main" to activate'
/Users/williamknight/proj/test/qt/menu/r:osascript -e 'tell app "menu" to activate'
/Users/williamknight/proj/test/qt/menu2/r:osascript -e 'tell app "menu" to activate'
/Users/williamknight/proj/test/qt/mfg-menu-test/bad/r:osascript -e 'tell application "mfg-menu-test" to activate'
/Users/williamknight/proj/test/qt/mfg-menu-test/r:osascript -e 'tell app "mfg-menu-test" to activate'
/Users/williamknight/proj/test/qt/mfg2/r:osascript -e 'tell app "fart" to activate'
</pre>

<h2>2011-07-17</h2>

<p>
Back from a beautiful vacation to Seattle and the Olympic Peninsula. One more day of vacay left, will
do a little programming today.
</p>

<h2>2011-07-18</h2>

<p>
Created test_font app, adding project to svn.
</p>

<h2>2011-07-20</h2>

<p>
Created font_map app, to investigate performance issues from previous font_lines app,
which really dropped the fps rate down. I note that the plib font code only provides
96 font chars. For the first time, I take note of how many chars are on the standard
keyboard layout: 4 rows:
</p>

<pre>
row 0: 13 keys * 2 = 26
row 1: 13 keys * 2 = 26
row 2: 11 keys * 2 = 22
row 3: 10 keys * 2 = 20
                    ___
                     94
</pre>

<p>
Hmm, where are the other 2? Ah, those 2 spots are blank in the 16x6 output image, good.
</p>

<h2>2011-07-24</h2>

<p>
Progress very slow these days. Thinking about where to head next to achieve the immediate
goal, which is high-performance text rendering in an opengl graphics window. In my continual
drive to understand the fundamentals, combined with tendencies of dilettantism, I re-visited
tinygl. I was able to build and run it on my mac, but the display of the gears app was
a little messed up, some kind of double image. So that started me reading a bit about X-Window
coding. Also been learning more about fonts through reading about fontforge and Tex. Downloaded
some bitmap fonts. Read a little this morning about font rendering using glBitmap() in
the OpenGL redbook.
</p>

<p>
After all this, my plan is to reproduce the simple rendering of the letter 'F' using the glBitmap()
example in the OpenGL book. Then I'm going to try to use/adapt the bitmap data from the glut
GLUT_BITMAP_9_BY_15font to render text.
</p>

<p>
Creating test app 'bitmap_letter'.
</p>

<p>
Done, it works. Next up: use the glut bitmap defs.
</p>

<p>
Working on that, don't have it yet. Here is the def for the letter 'F' in glut Fixed9x15_Character_70[]:
</p>
<pre>
static const GLubyte Fixed9x15_Character_070[] = {  
  9,  0,  
  0,  0,  
  0,  0,  
  0,  0,  
  0, 32,  
  0, 32,  
  0, 32,  
  0, 32,  
  0, 32,  
  0, 60,  
  0, 32,  
  0, 32,  
  0, 32,  
  0,127,  
  0,  0,  
  0,  0,  
  0
};
</pre>

<p>
Need to look at the code I guess... ah, ok, off by 1 at least, first char is bitmap width.
</p>

<p>
Yes! It's working. Finally, I'm thinking I have a simple but fast font-drawing solution for 
OpenGL.
</p>

<h2>2011-07-25</h2>

<p>
Little hacking before work, I found that it's necessary to add the glPixelStore2i() call
in the font code, otherwise, the font chars can be truncated. 
</p>

<p>
Sadly, the fps rate of the new font code seems just as slow as the old one ... very strange.
I'm going to have to do some detailed timings to see where it's slowing down.
</p>

<p>
Next: make an easier way to add apps to Makefile, add a 'console fps' app.
</p>

<h2>2011-07-26</h2>

<p>
Only a little time before work, I need a better test Makefile solution. Should I create
a separate subdir for Mac builds? They have some extra steps.
</p>

<p>
Re-organized the osx Makefile, looked easy enough, then make started doing some weird
implicit build command:
</p>
<pre>
mhackslab:test $ m
"building for mac os Darwin"
gcc   howdy.o howdy.app/Contents/MacOS/howdy   -o howdy
ld: in howdy.app/Contents/MacOS/howdy, can't link with a main executable
collect2: ld returned 1 exit status
make: *** [howdy] Error 1
mhackslab:test $ 
</pre>

<p>
Fixed it, just needed to add an action for the new howdy target, which is the symlink to
the mac osx exe.
</p>

<p>
Ok, reorganized makefiles work. It's about time I started using includes more.
</p>

<p>
Well, time for work already. Next time I'll create the script for adding new targets
to the Makefiles.
</p>

<h2>2011-07-27</h2>

<p>
Ridiculously little time this morning, and my back hurts. Will get started on project
creation script though.
</p>

<p>
Did it, it works.
</p>

<h2>2011-07-28</h2>

<p>
A little time to program before work this morning. Back still hurts a little. It's time
to start cranking out little test apps.
</p>

<p>
Created and ran cl_fps app, something looks wacked with current fps calc:
</p>
<pre>
    3.898484 secs: frame: 9006540, fps:  4060143
    3.898499 secs: frame: 9006600, fps:  4001107
</pre>

<p>
That's 60 frames in 16us, 3.75 frames/us = 3,750,000 fps, hmmm... it's in the ballpark,
but still a sig diff. Perhaps it's because the main-loop timestamp is called after
the call to fps_calc(). Will try calling it before, and will put the 'cur_time' call
in fps_calc() at top of loop, so caller and fps will have as close as possible 'cur_time'
value...
</p>

<p>
Interesting, it significantly drops the frame-rate, probably because sys_float_time()
is called every time now at top of fps_calc(), but that's ok, I'm fine with a more-consistent
fps_calc even with higher overhead. Let's check the calc though:
</p>
<pre>
    7.495249 secs: frame: 13577760, fps:  2681586
    7.495270 secs: frame: 13577820, fps:  2798467
    7.495293 secs: frame: 13577880, fps:  2671478
    7.495314 secs: frame: 13577940, fps:  2916686
    7.495336 secs: frame: 13578000, fps:  2779005
</pre>

<p>
Gah, gotta get to work...
60 frames in 23 usecs = 2.608696 frames/usec = 2,608,696 fps compared to 2,671,478.
A lot closer, cool. I'm thinking that's within the range of function call/return and
instruction exec times.
</p>

<h2>2011-07-30</h2>

<p>
Saturday morning, after a beautiful long night's sleep. My back doesn't hurt anymore.
Today, I want to develop a flexible method for recording, averaging and displaying
time intervals for various chunks of code.
</p>

<p>
Created perf.c. To implement 'perf_mark()' function, I'll need to use a hash library.
I've already used one before, what was it called? And where did I put it? My memory
is like a sieve these days. At some point, I'll need to start working on search projects
and tools.
</p>

<p>
strmap, in ~/swtools/misc. keywords: 'hash library'. Hmm, but that isn't going to
work, because what I need in this case is a str-to-int map. strmap is a str-to-str
map.
</p>

<h2>2011-08-04</h2>

<p>
Finished initial implementation of StrIntMap for perf module, also added checking
of keyboard input to cl_fps, something just crushed the previous performance:
</p>
<pre>
    6.256347 secs: frame: 005700, fps:  668
    6.311799 secs: frame: 005760, fps:  1082
    6.362357 secs: frame: 005820, fps:  1186
    6.437873 secs: frame: 005880, fps:  794
    6.488454 secs: frame: 005940, fps:  1186
    6.578598 secs: frame: 006000, fps:  665
    6.629268 secs: frame: 006060, fps:  1184
</pre>

<p>
Got rid of the key input, not much better:
</p>
<pre>
    3.229764 secs: frame: 003840, fps:  2187
    3.258421 secs: frame: 003900, fps:  2093
    3.279498 secs: frame: 003960, fps:  2846
    3.302289 secs: frame: 004020, fps:  2632
    3.344143 secs: frame: 004080, fps:  1433
</pre>

<p>
Next: identify the cause of the overhead. It's not perf_mark(), which is good.
</p>

<p>
Getting rid of glfwSwapBuffers() makes a big diff:
</p>
<pre>
    4.486396 secs: frame: 015540, fps:  12828
    4.487845 secs: frame: 015600, fps:  41401
    4.489283 secs: frame: 015660, fps:  41721
    4.490756 secs: frame: 015720, fps:  40733
</pre>

<p>
And bypassing glClear() accounts for most of the rest:
</p>
<pre>
    4.239728 secs: frame: 6996720, fps:  2381461
    4.239751 secs: frame: 6996780, fps:  2617545
    4.239774 secs: frame: 6996840, fps:  2604838
    4.239797 secs: frame: 6996900, fps:  2592254
</pre>

<p>
Here is the overhead with just perf_mark(), which is somewhat significant:
</p>
<pre>
    2.043821 secs: frame: 1365840, fps:  908939
    2.043893 secs: frame: 1365900, fps:  833691
    2.043960 secs: frame: 1365960, fps:  895968
    2.044033 secs: frame: 1366020, fps:  822244
</pre>

<p>
Lunch at Butterfly, thinking about how to finish up initial perf implementation,
lots of potential options. At first, thought I would just accumulate all records
and write them out to file at the end. But I prefer to have periodic output and
so now my plan is to just accumulate (sum) and output the average every output
interval, with a default rate of 1Hz, pretty much like the current fps works.
</p>

<h2>2011-08-05</h2>

<p>
Up good and early this morning (3:30 am), I got to sleep at 9:00 am last night,
so it's not too bad. Last night when I tried to work a little more on the existing
perf code, I realized there was a problem in calculating the delta time from the
previous perf mark. This morning, after considering various schemes, I decided to
try to keep each perf time interval separate from any others, requiring an explicit
'perf_mark_beg()' and 'perf_mark_end()' call around every desired interval. This little
extra work is fine because then I can time multiple sections of code that are
not part of the same loop, as is the current case.
</p>

<p>
Got a couple more hours sleep, which was good. Finished initial implementation of
new perf version. Getting report output, but the times are all 0, don't think
I can use float for times, may need to use timevals instead.
</p>

<p>
I need to find my code that did subtraction of timevals, where was it?
Ah, it was in gstep. Thank God for find/grep.
</p>

<h2>2011-08-07</h2>

<p>
Changing perf record timestamp type to timeval.
</p>

<p>
Debugging some time conversion code, timeval t.tv_sec MUST be converted
to (unsigned long) before doing any conversion to usec:
</p>

<pre>
(gdb) p cur_time.tv_sec
$21 = 1312746228
(gdb) p ((long)cur_time.tv_sec) * 1000000L
$18 = -1936087808
(gdb) p ((unsigned long)cur_time.tv_sec) * 1000000L
$19 = 2358879488
(gdb) 
</pre>

<p>
I don't quite understand why, as long should hold a max value
of 0x7fffffffffffffffL which is 9223372036854775807,
9,223,372,036,854,775,807 = 9e18
</p>

<p>
Even with the conversion to unsigned long, the multiplication
(at least in gdb) still isn't right. The correct answer should be:
</p>

<pre>
(gdb) p (float)cur_time.tv_sec * 1e6
$23 = 1312746240000000
(gdb) 
</pre>

<p>
Well, actually the correct answer should be 1312746228000000. wtf.
Need to go back to remedial computing I guess.
</p>

<p>
Ok, mystery solved, I just wrote a simple c test program and found
that LONG_MAX is only 2^32:
</p>
<pre>
LONG_MAX: 2147483647
ULONG_MAX: 4294967295
ULLONG_MAX: 18446744073709551615
mhackslab:long $ 
</pre>

<p>
Can't believe this whole time I never really realized this.
</p>

<p>
Fixed that, next running in to a problem where the 1us resolution isn't small
enough, I think I need to go to nanosec resolution instead, but there is no
good function for that in stdlib? Strangely, there is only the nanosleep()
time, which sleeps, it doesn't return a current timestamp. However, nanosecond
resolution isn't even guaranteed here, will just stick with usec resolution.
</p>

<p>
No, I want high-resolution! That's the whole point of this perf code, to understand
where the cycles are being consumed. Stackoverflow mentions clock_gettime() as a
stdlib function, but I don't see it in my libc.txt file. Will search /usr/include/
</p>

<p>
Nope, it's not there, so that's out. Searching SO, found: "In effect, it seems not to be implemented for MacOs."
LAME.
</p>

<p>
But also found this:
</p>
<pre>
struct timespec ts;

#ifdef __MACH__ // OS X does not have clock_gettime, use clock_get_time
clock_serv_t cclock;
mach_timespec_t mts;
host_get_clock_service(mach_host_self(), CALENDAR_CLOCK, &amp;cclock);
clock_get_time(cclock, &amp;mts);
mach_port_deallocate(mach_task_self(), cclock);
ts.tv_sec = mts.tv_sec;
ts.tv_nsec = mts.tv_nsec;

#else
clock_gettime(CLOCK_REALTIME, &amp;ts);
#endif
</pre>

<p>
Added the code, it compiled. Now I need to create a bunch of time functions with timespec
instead of timeval.
</p>

<h2>2011-08-09</h2>

<p>
Up fairly early, have some time to program. Will implement the timespec functions.
</p>

<p>
Did it, looks like it's working:
</p>
<pre>
mhackslab:test $ r
  1.175901: perf report: 1 perf records
  avg:   0.000011503, min:   0.000011000, max:   0.000578000, total:   0.496011000, num_intervals:  43120, fps_calc
    1.824177 secs: frame: 078579, fps:  43288
  2.175918: perf report: 1 perf records
  avg:   0.000011510, min:   0.000011000, max:   0.000885000, total:   0.495408000, num_intervals:  43039, fps_calc
    2.824192 secs: frame: 121593, fps:  43764
  3.175928: perf report: 1 perf records
  avg:   0.000011513, min:   0.000011000, max:   0.000175000, total:   0.495348000, num_intervals:  43022, fps_calc
    3.824198 secs: frame: 164595, fps:  43478
  4.175937: perf report: 1 perf records
  avg:   0.000011548, min:   0.000011000, max:   0.002065000, total:   0.496490000, num_intervals:  42992, fps_calc
    4.824204 secs: frame: 207789, fps:  43546
  5.175955: perf report: 1 perf records
  avg:   0.000011471, min:   0.000011000, max:   0.000051000, total:   0.495403000, num_intervals:  43185, fps_calc
    5.824208 secs: frame: 250921, fps:  44015
</pre>

<p>
Unfortunately, there seems to be a large overhead for empty sequence perf calcs:
</p>
<pre>
mhackslab:test $ r
  1.694077: perf report: 1 perf records
  avg:   0.000011361, min:   0.000011000, max:   0.000201000, total:   0.488736000, num_intervals:  43015, empty1

mhackslab:test $ r
  1.745358: perf report: 5 perf records
  avg:   0.000011080, min:   0.000010000, max:   0.000079000, total:   0.098392000, num_intervals:   8880, empty1
  avg:   0.000011081, min:   0.000010000, max:   0.000050000, total:   0.098408000, num_intervals:   8880, empty2
  avg:   0.000011077, min:   0.000010000, max:   0.000064000, total:   0.098370000, num_intervals:   8880, empty3
  avg:   0.000011071, min:   0.000010000, max:   0.000078000, total:   0.098317000, num_intervals:   8880, empty4
  avg:   0.000011068, min:   0.000010000, max:   0.000064000, total:   0.098285000, num_intervals:   8880, empty5
</pre>

<p>
So the current implementation has a granularity of around 11usec, which doesn't sound great but
will still help for longer ops such as glfwSwapBuffers:
</p>
<pre>
 2.532043: perf report: 6 perf records
   avg:   0.000028791, min:   0.000011000, max:   0.000087000, total:   0.048542000, num_intervals:   1686, empty1
   avg:   0.000028532, min:   0.000011000, max:   0.000085000, total:   0.048106000, num_intervals:   1686, empty2
   avg:   0.000028048, min:   0.000011000, max:   0.000104000, total:   0.047289000, num_intervals:   1686, empty3
   avg:   0.000027341, min:   0.000011000, max:   0.000100000, total:   0.046097000, num_intervals:   1686, empty4
   avg:   0.000016664, min:   0.000011000, max:   0.000050000, total:   0.028096000, num_intervals:   1686, empty5
   avg:   0.000303794, min:   0.000052000, max:   0.014260000, total:   0.512198000, num_intervals:   1686, glfwSwapBuffers
</pre>

<p>
Of course, when you consider that processes are continually interrupted by the OS, this large
overhead is to be expected.
</p>

<p>
Hmm, I'm still seeing a lot of inconsistency though when I look at the average times of
glfwSwapBuffers computed with various combinations of 'empty' intervals.
</p>

<p>
I suspect that time interval aliasing might have something to do with it.
</p>

<p>
Ah, wait, I made an important observation: when the graphics window is in the foreground,
the swapbuf time avg is 300us but when in background, it's only 50us. That explains
the variation I'm seeing.
</p>

<p>
Well, only some of the variation. When there are only 2 empty perf calls, the fg swapbuf
time increases inexplicably to 370us, and with only 1 empty perf call, it is around 470us.
That still doesn't make sense to me. Perhaps multiple calls to the perf code result in
some kind of cacheing in the OS or CPU?
</p>

<p>
Well, the bottom line is that I have a workable metric for calculating relative times
for the operations I'm trying to optimize:
</p>
<pre>
 42.118797: perf report: 5 perf records
   avg:   0.000050460, min:   0.000035000, max:   0.000160000, total:   0.052277000, num_intervals:   1036, glClear
   avg:   0.000015119, min:   0.000012000, max:   0.000040000, total:   0.015664000, num_intervals:   1036, fps_calc
   avg:   0.000443398, min:   0.000395000, max:   0.000601000, total:   0.459361000, num_intervals:   1036, font_draw
   avg:   0.000349133, min:   0.000067000, max:   0.016284000, total:   0.361702000, num_intervals:   1036, glfwSwapBuffers
   avg:   0.000021726, min:   0.000011000, max:   0.000078000, total:   0.022509000, num_intervals:   1036, glfwGetKey
</pre>

<p>
So, success so far.
</p>

<h2>2011-08-11</h2>

<p>
Next, I'm going to make a new app that does timing of  the current font drawing code, 'font_perf'.
</p>

<h2>2011-08-12</h2>
<p>
It's Friday, yay. A tiny bit more work before work. Currently there are some extranneous pixels 
being drawn in the font_perf app, must find out why. Ah, I see, was using slightly larger
dimensions of the font bitmap in font9x15.
</p>

<p>
perf for drawing 1 letter:
</p>
<pre>
  3.666303: perf report: 4 perf records
  avg:   0.000060814, min:   0.000036000, max:   0.000319000, total:   0.073585000, num_intervals:   1210, glClear
  avg:   0.000015704, min:   0.000011000, max:   0.000051000, total:   0.019003000, num_intervals:   1210, ortho
  avg:   0.000076574, min:   0.000061000, max:   0.000189000, total:   0.092655000, num_intervals:   1210, draw_letter
  avg:   0.000607246, min:   0.000202000, max:   0.004581000, total:   0.734768000, num_intervals:   1210, swap
</pre>

<p>
perf for drawing 50 letters:
</p>
<pre>
  5.691817: perf report: 4 perf records
  avg:   0.000037167, min:   0.000035000, max:   0.000075000, total:   0.014867000, num_intervals:    400, glClear
  avg:   0.000012010, min:   0.000011000, max:   0.000025000, total:   0.004804000, num_intervals:    400, ortho
  avg:   0.002124922, min:   0.002052000, max:   0.002684000, total:   0.849969000, num_intervals:    400, draw_letter
  avg:   0.000274527, min:   0.000067000, max:   0.003956000, total:   0.109811000, num_intervals:    400, swap
</pre>

<p>
Inside draw_letter:
</p>
<pre>
  4.341854: perf report: 7 perf records
  avg:   0.000056601, min:   0.000036000, max:   0.000175000, total:   0.068148000, num_intervals:   1204, glClear
  avg:   0.000012901, min:   0.000011000, max:   0.000045000, total:   0.015534000, num_intervals:   1204, ortho
  avg:   0.000012081, min:   0.000011000, max:   0.000059000, total:   0.014546000, num_intervals:   1204, raster_def
  avg:   0.000011761, min:   0.000011000, max:   0.000044000, total:   0.014161000, num_intervals:   1204, pix_store
  avg:   0.000015555, min:   0.000014000, max:   0.000056000, total:   0.018729000, num_intervals:   1204, raster_pos
  avg:   0.000062172, min:   0.000057000, max:   0.000430000, total:   0.074856000, num_intervals:   1204, glBitmap
  avg:   0.000563327, min:   0.000072000, max:   0.005326000, total:   0.678246000, num_intervals:   1204, swap
</pre>

<p>
So glBitmap just takes a long time.
</p>

<p>
Googled glBitmap performance, found this: http://www.opengl.org/resources/features/KilgardTechniques/oglpitfall/ 
</p>

<p>
Then, another search on Stackoverflow, I'm thinking the solution for fast text rendering is a single
texture-binding call and rendering textured quads:
</p>
<blockquote>
The key is that texture binding is the operation you need to minimize. If you
can render all of your text with a single texture, it won't matter how much
text you need to put on the screen. Even if you have to switch textures a
handful of times (different fonts, different font attributes [bold, underline,
etc]) performance should still be good. Text performance might be more critical
for a HUD, but it less important in the GUI.
</blockquote>

<h2>2011-08-13</h2>

<p>
Saturday morn after staying up late partying and watching Aztec Wrestling Women vs. The Mummy.
</p>

<p>
Will start creating apps to draw multiple polys, eventually textured as text, in various
ways to measure performance (client-side vs. server-side rendering)
</p>

<h2>2011-08-14</h2>

<p>
Good night's sleep, up late, can spend most of today programming! Created first of many
apps to measure performance drawing a large number of polys, 'perf_poly_glv', which uses glVertex(). It
draws 2000 polys per frame, current frame rate is:
</p>
<pre>
fps:  472, pps:  946000
fps:  475, pps:  952000
fps:  476, pps:  954000
</pre>

<p>
That performance is extremely good even using the least-efficient method (perhaps because of
cacheing the uniform data), so will update this
to draw textured polys, with a real font bitmap as a better test. To do that, I need to get
an image of a font set, so next app it 'render_font_set'.
</p>

<h2>2011-08-16</h2>

<p>
Been reading up on png format, as that is the image format I will use to store the font set
image. And it's high time I learned at least one image format in greater detail. Also created
a little test app, 'read_png_chnunks', to output the chunks in a png file, this was very easy
to do. Unfortunately, no more time to do anything else this morning.
</p>

<h2>2011-08-22</h2>

<p>
Big long funs break. Only a tiny work done, however, I did complete another test app,
~/proj/test/graphics/png/write_test_image.c. At first I didn't think it was working
because the png file looked too small. Evenutally, I looked through the libpng code
and did a little gdb steppin before realizing that it must have been doing compression
by default. I should have just tried to open the damn thing in an image viewer!! Duh.
</p>

<p>
So the next step is to create a font image from the glut 9x15 char set
</p>

<p>
Created test app 'write_9x15_font_png'.
</p>

<p>
Next, implementing the bits definition, it seems like I must continually forget the format
of the Fixed9x15_Character_XXX arrays... there are 32 bytes for each character... why??
Ah, 16 rows of 2 bytes each, duh...
</p>

<h2>2011-08-23</h2>

<p>
Up at 6:00 am, time for programmings. Last night I finished initial implementation of
defining the image data array for the font char set and output it to a file. It wasn't
right, but a little thought in bed revealed the problem, I was writing out the rows of
each font char sequentially into the array, when they need to be offset so they line
up under each other. Starting on the fix now.
</p>

<p>
Did the change, but still a problem: the end of the img_data array is reached at the
beginning of the 16th bit row of the first character of the final character row.
Not sure why yet.
</p>

<h2>2011-08-24</h2>

<p>
Slept in till 7:20, needed the sleep but now time for programming. Last night in
spare snippets of time, I finished a python program, gen_w9f_map.py, which creates
a text representation of the image data array, to help me debug the problem. Perhaps
that in conjunction with a quick gdb sesh and a cup of coffee will help make the
magic happen.
</p>

<p>
More debugging, I see my python output array is too small, that needs a little more
work.
</p>

<p>
Lunch, quick coding, changed python script to output each pixel row, not each char row.
When finished, will take a another crack at debugging in gdb.
</p>

<h2>2011-08-25</h2>

<p>
Up good and early, should get some good debugging done today. Right now, I'm adding some
docs to my gserver/gclient utility before debugging the write_9x15_font app with it.
</p>

<p>
Well, spent the whole time this morning documenting the vim-gclient lxl debugging setup,
so the actual debugging of the font test program will have to wait for next time.
</p>

<h2>2011-08-26</h2>

<p>
Up fairly late, just a bit of debugging time, but it's Friday! Last night, did a little
more vim-gdb debugging, added some more docs on escaping stuff. This morning, resumed
debugging, still a bug in the python text generator, the dang chXX label in the pixel
rows is still a little off, fixing that. Why is it so damn hard to get correct?
</p>

<p>
Fixed that, but still not right because the byte offsets of the bottom pixel rows
is 5 digits, not 4, so need to add an extra digit to everything. But must do that
later, it's time to go to work.
</p>

<h2>2011-08-27</h2>

<p>
It's Saturday morning, but I'm working today! So only a little time this morning.
I fixed the python program again and am debugging the write_9x15_font_png app
again in vim/gdb. It's on the final character row (pixel row 240, after the
first character (chf0) first pixel row data has been written. Maybe I'll finally find this
bug.
</p>

<p>
At the end of the first pixel row of chf0, it was at 0x3c040, in agreement with
the python output. Then it added num_img_data_row_bytes (0x400), making i == 0x3c440,
as one would expect. But the start of the next pixel row is instead 0x3c400, so there
is a 0x40 byte difference....?
</p>

<p>
Aha, yes, by adding the 0x400 pixel row value to the index variable when it's at the end
of the first pixel row, it drops it down 1 row so that the next row is actually starting
under the second character in the final character row, chf1.
</p>

<p>
Instead, the index var should be set to the initial offset of the chf0 + 
bit_row * num_img_data_row_bytes. I think I've got it.
</p>

<p>
Made the change, it's better, now it overruns on the final character 255:
</p>
<pre>
mhackslab:test $ ./write_9x15_font_png
ch 255: i: 262140, bit_row: 15 bit_col: 01 bit: 7 bit_val: 0
urk!: Unknown error: 0
mhackslab:test $ 
</pre>

<p>
Cool, that's just an off-by-1 error on my overrun check, should be ok.
</p>

<p>
Victory! We have a font set image! The individual characters upside-down, but
that is easily fixed. Damn I'm slow!
</p>

<p>
Back home, a little time before other stuff, will flip them rows so I can start
thinking about the next part.
</p>

<p>
Did that, chars are now drawn right-side up, but still backwards! I have to 
flip that dir too?? Fine.
</p>

<p>
Ok, flipped horizontally, but now it's shifted over too far to the right for some 
reason.
</p>

<p>
I think it's because the original bitmask def had a little padding of the first bitcol
on the left and excess padding on the right, which is now on the left. bleh..
</p>

<p>
This is getting to be a PITA, but ALMOST there...
</p>

<p>
Hmm, looking closely in Gimp, there's some other weird artifact, some stray white 
pixels scattered around in the first 2 character rows... could those be intentional?
Would have to look more closely at the bitmask defs to be sure.
</p>

<p>
So at this point, I could try doing more bit column hacking and flipping or back up,
output the bit cols in existing order, but instead output the char blocks from 
right-to-left and then reverse all the rows...that sounds almost as ugly.
</p>

<p>
Hmm, on further thought, I don't think those artifacts are intentional, there's 
still some bug in the code. Yeah, think I need to keep flipping the 2 bit cols individually,
but keep them in the original sequence.
</p>

<p>
Did it, we're there! Finally, I have a precisely-defined font image that I can use for 
texture-mapping, where I know exactly where every pixel goes.
</p>

<p>
Time for programming is done for today, except to name a new test app, 'draw_tex_font'.
This will draw a font set using texture mapping, in the simplest possible way and 
provide the baseline for more efficient text rendering.
</p>

<h2>2011-08-28</h2>

<p>
Up at 7 am Sunday morning, plenty of free time to program today! Continuing implementation
of 'draw_text_font' app.
</p>

<p>
Later in the day, finished adding code that loads image from png file,
now I'm trying to specify the absolute minimum number of OpenGL calls
for texturing a triangle. Spent a little time reading the OpenGL 2.1
spec. Very dense, but nice reading the ultimate source for OpenGL
behavior. Currently, texturing isn't working (I'm not using texture
objects yet). I think it's because there are some glTexParameter()
calls that are needed, but I don't remember which ones. The OpenGL
red book gives 4 params (GL_TEXTURE_WRAP_S, GL_TEXTURE_WRAP_T, GL_TEXTURE_MAG_FILTER,
GL_TEXTURE_MIN_FILTER). I think I vaguely remember from a previous
attempt that you have to specify the TEXTURE_MAG/MIN_FILTER params
but not sure. I'll add and see.
</p>

<p>
Aha, confirmed that the GL_TEXTURE_MIN_FILTER is the 'minimum' glTexParameter()
that is required.
</p>

<p>
Currently though, the texture is 'messed up', scrambled lower font set chars
at bottom, the top ones are blank.
</p>

<p>
Ok, ruled out texture issues, I did a glDrawPixels() and it's still messed up.
Could it be the missing glPixelStorei() call? Nope.
</p>

<p>
Duh, it was a bug in the image-loading code I grabbed from my cbots project,
I hadn't fully converted from rgb to rgba everywhere.
</p>

<h2>2011-08-29</h2>

<p>
Monday, tired, didn't have any time this morning, maybe I can do a tiny progress
tonight before dinner. Just want to re-define the tex coords to display a
single character instead of the full image, how hard can that be?
</p>

<h2>2011-08-30</h2>

<p>
Too hard for me, I guess. Still not done, only a little time this morning. Will
keep trying...
</p>

<p>
Ok, got it. It now draws the whole font set at 312 fps. Next: create a new
baseline app that draws 'readable' text lines, then start creating optimized
versions.
</p>

<p>
Next app will display 800x600 window with 80x36 text.
</p>

<p>
After work, at home, little coding before breakin bad, getting weird error compiling
tfont:
</p>
<pre>
mhackslab:font $ make
gcc -o font.o -g -Wall -I/Users/williamknight/swtools/opengl/glfw/include -I..  -c font.c
gcc -o font-9x15.o -g -Wall -I/Users/williamknight/swtools/opengl/glfw/include -I..  -c font-9x15.c
gcc -o tfont.o -g -Wall -I/Users/williamknight/swtools/opengl/glfw/include -I..  -c tfont.c
In file included from tfont.c:4:
../util/img.h:5: error: syntax error before ‘size_t’
../util/img.h:5: warning: no semicolon at end of struct or union
../util/img.h:6: warning: type defaults to ‘int’ in declaration of ‘height’
../util/img.h:6: warning: data definition has no type or storage class
../util/img.h:7: error: syntax error before ‘bytes_per_pixel’
../util/img.h:7: warning: type defaults to ‘int’ in declaration of ‘bytes_per_pixel’
../util/img.h:7: warning: data definition has no type or storage class
../util/img.h:9: error: syntax error before ‘}’ token
../util/img.h:9: warning: type defaults to ‘int’ in declaration of ‘RgbaImage’
../util/img.h:9: warning: data definition has no type or storage class
../util/img.h:11: error: syntax error before ‘*’ token
../util/img.h:11: warning: type defaults to ‘int’ in declaration of ‘img_read_png_rgba’
../util/img.h:11: warning: data definition has no type or storage class
tfont.c:8: error: syntax error before ‘*’ token
</pre>

<p>
wtf?
</p>

<p>
Ah, now I realize the problem with img_h, I did a '#define img_h' in util/img.h. However, that
doesn't explain the error above.
</p>

<p>
Ok, I guess I'm finally realizing that size_t isn't a built-in type in C. Duh.
</p>

<p>
Fixed, test image works! At the incredible fps of 24!
</p>

<h2>2011-08-31</h2>

<p>
Last day of August...sigh. Up at 7, I can do a little this morning. First will add a check
of any existing GL errors ot the baseline app, then also investigate why the window isn't
exactly 800 px wide.
</p>

<p>
Ah, well, that 2nd one was easy, there was a '4' left-over from the 640 that later turned
into an 840! Also making the current base-line app the new template.
</p>

<p>
New baseline with 800x600 window, 80x36 cols is 29 fps (5760 tris). Made it the template, added GL error
check, no errors. Checked in the code. We're ready to optimize.
</p>

<p>
Starting reading again about vertex arrays and vertex buffers.
</p>

<p>
Creating first optimized app tf8036_va (vertex arrays).
</p>

<p>
Read a little about GL arrays, finished create_verts() func, that's all I have time for this morning.
</p>

<p>
More thinkings about next steps, I'll be using glDrawElements(), prob with GL_TRIANGLES to start
and maybe later GL_TRIANGLE_STRIP. The challenge will be to get the verts and tcoords right. I realized
earlier that my first effort wasn't quite righ, it assumed each char row shared verts with the
row below it, but actually in the baseline app, there is a 1 pixel border between, so no sharing
for now.
</p>

<p>
What needs to be done for more efficient tex-mapping of the font is to regenerate the tex image
so that the characters are in 10x16 cells, not 16x16.
</p>

<p>
Wait, it doesn't freakin matter, I can get 10x16 portions from the existing map just by re-defining the 
get_tex_idx() function. Think I'll try changing it to 10x16.
</p>

<p>
Did it, baseline works. Now, back to a more efficient version of the va.
</p>

<p>
Hmm, after all that, now I'm thinking that I won't be able to 'share' the row verts
after all, because the 'bottom' vert of a character in the first row will be associated
with a different tex coord than the same vert for the char in the row below it.
</p>

<p>
So I will need to 'double-define' the verts.
</p>

<p>
Extracted out some common code. Running tf8036_va w/o drawing, we get a null-draw version
with 448 fps.
</p>

<h2>2011-09-01</h2>

<p>
Up late this morning because I was up late last night, very little time for programming but
will try at least to get the tcoord generation done.
</p>

<p>
Finished initial implementation using glDrawElements(), it runs but displays some weird
jaggedy white rows at top, no discernable text. Progress though. And an fps of 248!
</p>

<p>
Now it's just a matter of debugging the data in the verts, tcoords and tris arrays.
</p>

<pre>
(gdb) p _verts[0]
$21 = 0
(gdb) p _verts[1]
$22 = 584
(gdb) p _verts[2]
$23 = 10
(gdb) p _verts[3]
$24 = 584
(gdb) p _verts[4]
$25 = 0
(gdb) p _verts[5]
$26 = 600
(gdb) p _verts[6]
$27 = 10
(gdb) p _verts[7]
$28 = 600
</pre>

<p>
Looks correct to me. Ah, I generated tris wrong, I assumed row-sharing. Changed, still not right.
</p>

<p>
tcoords don't look right:
</p>
<pre>
(gdb) p _tcoords[0]
$1 = 0
(gdb) p _tcoords[1]
$2 = 0.75
(gdb) p _tcoords[2]
$3 = 0.0390625
(gdb) p _tcoords[3]
$4 = 0.75
(gdb) p _tcoords[4]
$5 = 0
(gdb) p _tcoords[5]
$6 = 0.8125
(gdb) p _tcoords[6]
$7 = 0.0390625
(gdb) p _tcoords[7]
$8 = 0.8125
(gdb) 
</pre>

<p>
Well, not sure of that until I lookup the expected tcoord for the '0' char...
It's row 3, col 0. Actually, that does look right. So wtf?
</p>

<p>
Hah, I don't think I ever enabled the texture map stuff!!
</p>

<p>
Ok, added tfont_init() call, it's drawing some semi-recognizable rows at the top now!
Almost there I think.
</p>

<p>
Ok, cranking down to 160 tris, they look squished in x dir...
</p>

<p>
Gotta go to work!
</p>

<p>
At work still coding, 2 things wrong: nch inc, 2nd tri index seq
</p>

<p>
Still not it!
</p>

<p>
Lunch at Riverside Cafe, I'm doing explicit glBegin(GL_TRIANGLES) on the
_verts and then the _tcoords to find out what the heck is going on.
</p>

<p>
I did it for the first tri, using previous debug values of the first tri
verts and tcoords. They appear correct, the lower left half of a '0' is drawn. 
The next step is to actually reference the values from the _verts and _tcoords
arrays.
</p>

<p>
Did that, they must be correct.
</p>

<p>
Did glBegin(GL_TRIANGLES) with glArrayElement() and that works too!!??
So the only thing left is incorrect _tris???
</p>

<p>
wtf?
</p>
<pre>
35glDrawElements(GL_TRIANGLES, 1, GL_UNSIGNED_INT, _tris);
(gdb) p _tris[0]
$1 = 0
(gdb) p _tris[1]
$2 = 1
(gdb) p _tris[2]
$3 = 2
(gdb) 
</pre>

<p>
fuck:
</p>
<pre>
voidglDrawElements(GLenummode, GLsizei count, GLenum type, 
const GLvoid *indices); 
Defines a sequence of geometric primitives using count number of ele- 
ments, whose indices are stored in the array indices.
</pre>

<p>
I was assuming tri count, not vert count!
</p>

<p>
That's it. Jesus.
</p>

<p>
190 fps.
</p>

<p>
When I move the window around, it flickers, fps jumps to 362 and stays there on next
run. Whatever, must be os/driver cacheing or something.
</p>

<p>
Next up: server-side.
</p>

<p>
Tonight, probably just sporadic programming. Here are some items to address:
</p>

<ul>
<li>Re-work write_9x15_font_png to output 0 alpha for empty parts of char bitmaps
<li>Start using texture objects
<li>Find out why the null app is only 448 fps (should be higher)
</ul>

<p>
Added alpha to 9x15 font bg, it works.
</p>

<p>
Need to enable transparency now in the test app.
</p>

<h2>2011-09-02</h2>

<p>
Friday, yeah. Up pretty early, reading the OpenGL book chapter on blending. Before,
I never really understood what the hell I was doing beyond learning you had to
enable blending and pick a blend function with some random blend factors until it
it worked. Now I will try to understand.
</p>

<pre>
Result red pixel = R<sub>s</sub>S<sub>r</sub> + R<sub>d</sub>D<sub>r</sub>
R<sub>s</sub>: Source red pixel
R<sub>d</sub>: Dest red pixel

S<sub>r</sub>: Source blending factor
D<sub>r</sub>: Dest blending factor
</pre>

<p>
Here is what I want:
</p>
<table>
<tr><th>Source red pixel</th><th>Source alpha</th><th>Dest red pixel</th><th>Result red pixel</th></tr>
<tr><td>0 <td>0           </td><td>0.5           </td><td>0.5             </td></tr>
<tr><td>1 <td>1           </td><td>0.5           </td><td>1               </td></tr>
</table>

<p>
In other words, if the src alpha (A<sub>s</sub>) is 1, the result should be the source pixel. If the src alpha
is 0, the result should be the dest pixel.
</p>

<p>
So what values of S<sub>r</sub> and D<sub>r</sub> will give me that?
</p>

<p>
Well, one solution seems to be S<sub>r</sub> = A<sub>s</sub>, D<sub>r</sub> = 1 - A<sub>s</sub>:
</p>
<pre>
0 * 0 + 1 * 0.5 = 0.5
1 * 1 + 0 * 0.5 = 1
</pre>

<p>
So I did this, as before, and it works:
</p>
<pre>
glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
glEnable(GL_BLEND);
</pre>

<p>
But now I understand a little better how and why. for tf8036_va, fps this morning on my macbook
is 355.
</p>

<p>
Friday afternoon, done with work! What's next? Texture objects and new tfont functions
for drawing using glDrawElements().
</p>

<p>
Another consideration: how is selective coloring of text to be done? Changing all the
text color uniformly could be done by changing the underlying texture image data, but
to selective modify individual characters seems to require something like either 
multi-texturing or some kind of overlaid image and a blending function. I'll worry about 
that later, first need to start defining the new tfont functions. And should actually
start out by defining a new tf8036 app to test it, such as tf8036_xt (external texture).
</p>

<p>
Created app and 2 new tfont funcs: tfont_set_text_buf() and tfont_draw_text_buf().
</p>

<p>
Last night I thought a little about the vim commands for 3D graphical movement and
which keys to use for the z axis. At that time, I was going to go with '-' and '='
because that's what I use for 'pg-up' and 'pg-down' and I couldn't visualize what
other home row keys might be applicable that were comparable to h-l and j-k. But
now, looking at the keys, the choice is obvious: i-o (in-out). The only potential
conflict is with the existing use of 'i' to go into insert mode (as well as 'o'),
but I'm not sure yet if such a parallel exists for 3D graphical editing. The
closest thing that I can think of in that case is 'tab' which in Blender toggles
between object and edit mode, and that could simply be retained instead. There
isn't really a close corollary in 3D graphical editing for inputting a sequence of 
characters, I think.
</p>

<p>
Finished initial implementation of tfont text buf code and tf8036_xt. It was 
pretty easy because I just copied stuff from tf8036_va. It crashes on first
run though.
</p>

<h2>2011-09-03</h2>
<p>
Saturday morning, up early, not much sleep. And I'm working half-day today,
so we'll see what gets done. Right now, debugging the new tfont routines.
</p>

<p>
It crashes on the initial 'blank space' array, so that rules out the tfont_set_text_buf()
function. Here is the stack crash at the crash:
</p>
<pre>
0x1437c14a in gleRunVertexSubmitImmediate ()
(gdb) bt
#0  0x1437c14a in gleRunVertexSubmitImmediate ()
#1  0x1437954a in gleLLVMArrayFunc ()
#2  0x1437954a in gleLLVMArrayFunc ()
#3  0x143794d7 in gleSetVertexArrayFunc ()
#4  0x1435479a in gleDrawArraysOrElements_ExecCore ()
#5  0x143556f8 in gleDrawArraysOrElements_IMM_Exec ()
#6  0x955c6aa4 in glDrawElements ()
#7  0x00003480 in tfont_draw_text_buf () at tfont.c:312
#8  0x000027fb in main (argc=1, argv=0xbffff7b0) at tf8036_xt.c:38
(gdb) 
</pre>

<p>
No source code to debug, that sucks. Ah, first thing to try is to reduce
the number of tris drawn in glDrawElements().
</p>

<p>
Hmm, still crashing drawing just one tri.
</p>

<p>
Probably some bounds error, maybe time for valgrind? First maybe I'll just add
my own bounds checks.
</p>

<p>
Fixed, I had just forgotten to add the glVertextPointer() and glTexCoordPointer()
calls before glDrawElements() in tfont.c. Duh.
</p>

<p>
Next: start on some editing functions.
</p>

<p>
New app: tf_edit. First new thing: add a cursor overlay. I'll do it like vim, which
is a simple semi-transparent blinking block cursor.
</p>

<p>
Home after a long day's work, along with bike repair that made it a lot more than 
half-day. While biking to work I worked out some more plans. First up: get the
cursor working and then define an array of line buffers to hold text that
gets selectively written to the screen buffer depending on current row and col
scroll position.
</p>

<p>
Then soon, to implement most of the vim functionality, I think I'll add
a Lua interpreter to handle most of the keyboard input. It's something I've
already done before on other projects. With this C-based project it should
be even easier (one C++/swig project bogged things down with too much complexity,
so I'll probably write my own interface functions).
</p>

<h2>2011-09-04</h2>

<p>
Sunday morning, up early with sufficient sleep. Time to make the cursor happen.
</p>

<p>
Added display of fps in win title.
Added dependency generation to makefiles.
</p>

<p>
Created edit lib.
</p>

<p>
Cursor draws without texture drawing, but not with. Probably need to save/restore
some draw state in the tex drawing calls.
</p>

<p>
Cursor drawing is working. It really is time to start using texture objects.
</p>

<p>
Added the texture object, not really seeing the advantages of it yet thought.
Anyhow, continuing with adding cursor movement. But should I add the lua interface
to do that first? Why not.
</p>

<p>
Cracking open the lua book, doing a quick re-read. Creating first test prog,
lua_sinterp (simple interpreter).
</p>

<h2>2011-09-05</h2>

<p>
Spent most of the morning reading the Lua book. Now, I'm ready to do the first lua
program, which will be a simple one that defines a single lua function, 'keydown()',
which will be the key input handler. I'll call the function from C code using
lua_pcall(), along the lines of the sample code in 25.3. Unfortunately, right now,
I have to get ready and go to work.
</p>

<p>
Lunch, only time for a very little programming. I want to start the next progrm
that both displays graphics and runs a lua interpreter. Well, just modify the 
tf_edit program to do that.
</p>

<p>
Grr, first must fix a bug in the makesfiles, the lua_sinterp is stepping
on the includes var, messing up subsequent ones.
</p>

<p>
I think I need to change the Makefile strategy to must call make on
each individual makefile.
</p>

<p>
I will be late for work, but I did it.
</p>

<p>
Home late, just a little time before dinner. Will try to add something to
the tf_edit program.
</p>

<p>
Ah, a new problem: new makefile scheme doesn't rebuild on src file changes.
By moving the build commands for each app into a separate makefile, the
dependency chain is broken in the main makefile. Easiest fix is to just
call all the proj makefiles unconditionally.
</p>

<p>
Fixed by adding $(targets) to phony.
</p>

<p>
key input callback is working. Time for lua!
</p>

<h2>2011-09-06</h2>

<p>
Up at 7, getting to it. Lua.
</p>

<p>
Did luaL_dofile() and lua_pcall(), it works! Lua rocks. Simplicity rocks.
</p>

<p>
Next: make lua move the cursor.
</p>

<p>
Registering C functions in lua.
</p>

<p>
Added l_edit_set_cursor(), it freakin works! We are ready to rock and roll.
</p>

<p>
I've got a program with lua-controlled cursor movement! It's just too easy!
</p>

<p>
After work. Next up: key autorepeat. Will need to add a timer event. The easiest
is to drive it from the main loop.
</p>

<p>
Adding a tick function to handle key autorepeat.
</p>

<p>
I don't see a lua function for getting millisecond time, so will write a
wrapper func.
</p>

<p>
Autorepeat is working! Sweetness.
</p>

<p>
TODO: figure out how to detect undeclared lua vars (biting me already)
</p>

<h2>2011-09-07</h2>

<p>
Up pretty early (5:30 am) and got enough sleep. I have some precious time for
coding, will get to it. What to do next? The command-line I think.
</p>

<p>
So, first thing, I need a way to get key codes defined in lua. Thought a
little about this yesterday, will write a lua script to generate the
definitions. Could either be in lua or C, why not just be in lua.
</p>

<p>
While I'm at it, might as well consider key-mapping, so I also need
to consider key-sequence mappings. Hmm, don't want to bite off too much
at first though. Will just keep it in mind for now. Think it's time
to start looking at vim source code however.
</p>

<p>
Looking at the vim source code, I see that it references literal 'c'
values. If it's good enough for vim, it's good enough for me.
</p>

<p>
We have the beginnings of a command-line. Next: apply 'shift' to produced
shifted key values (currently 'shift-;' produces only ';' instead of ':')
</p>

<h2>2011-09-08</h2>

<p>
Great night's sleep but only a little time left for programming. Possible
turbulence ahead. Can I get the 'shift' op to at least work?
</p>

<p>
Still need those key code defs from glfw.h.
</p>

<p>
At Modwest, but not working yet. Caught the bus, got in early, now
time for a little more vblend coding on the couch upstairs. I'm
implementing the 'shifted_keycode' table. Not sure if it's the right
way to do it, but it will do what I need for now.
</p>

<p>
After work, debugging glfw keycode mappings:
</p>
<pre>
  k: [A], v: [A], ch: [A]
k!=ch: type(k): string, type(ch): string
k!=ch: #(k): 1, #(ch): 2
ch[1]: [A], ch[2]: []
</pre>

<p>
Finally zeroing in on it.  This is the culprit conversion:
</p>
<pre>
ch = string.char(k,1)
</pre>

<p>
Reading the freakin docs on string.char() again...
</p>
<blockquote>
### `string.char (***)`

Receives zero or more integers. Returns a string with length equal to the
number of arguments, in which each character has the internal numerical code
equal to its corresponding argument.

Note that numerical codes are not necessarily portable across platforms.
</blockquote>

<p>
Well, amazing what reading the freakin docs can do.
</p>

<p>
Ok, key code conversion is finally working.
</p>

<h2>2011-09-09</h2>

<p>
Up good and early, got enough sleep, and it's Friday!! First thing: finish the
keycodes.lua table, then get started on the command-line.
</p>

<p>
Now that I've added key code to ascii code translation, the naming of the
char-pressed and char-input functions becomes more clear.
</p>

<p>
We've got text display on the command-line!
</p>

<p>
Checking in code, wtf happened to my ssh key for my mmmmhack acct, it's not
being recognized. I'm guessing the mmmmhack shell acct is busted. Will
find out soon enough.
</p>

<p>
On the bus to work, nice to have the extra programming time. Next: implement
bs and ret for cmd-line.
</p>

<p>
bs is working.
</p>

<p>
Friday after work, on the bus! Will read more about how to do inter-module
refs in the lua book at some point, but I think right now I can just specify
the global module name. I'd really like to check in the existing code first
though, but my freakin mmmmhack acct on modwest has a really weird mounting
problem that not even jneff could fix. Maybe that means it's finally time to
go git.
</p>

<p>
Built and installed version 1.7.5.2 from source no probs. Reading OReilly
git book.
</p>

<h2>2011-09-10</h2>

<p>
Saturday, up very early, but not enough sleep and too much beer last night.
But will forge on.  Copied existing project dir over to a new one where I'll
create a git repository.
</p>

<p>
Created the repository and did the initial commits. Pretty straightforward.
So now, will continue work on the project and do more git stuff as it comes
up.
</p>

<p>
Later, after a lot more sleep, which is good, taking another a look at the
code and thinking how to reorganize to deal with the different modes.
For now, I'm thinking to define 3 different modules, 'cmd_mode', 'normal_mode', 'insert_mode'.
So this will require my first git rename, which I'm sure is very simple, but
will read a little more of the git book for that.
</p>

<p>
Before the rename, did my second git commit after learning to do 'git commit -a'
('git commit' by itself didn't do anything). Next, I want to learn how to do
the equivalent of 'svn propedit svn:ignore'.
</p>

<p>
Seems pretty simple, just edit .gitignore.
</p>

<p>
Did rename, easy. The simple git stuff is just like subversion. I can't believe
it took me so long to start using it.
</p>

<h2>2011-09-11</h2>

<p>
Good night's sleep, no beer last night, I'm good to go. Continuing with modularization
and cmd-line impl.
</p>

<p>
Finished init cmd-line input, adding normal mode op count.
</p>

<p>
In the process of implementing line movement, I'm adding a new 'line_buf' module.
</p>

<p>
It will soon be time to start outputting stack trace on error.
</p>

<p>
line movement with count is working!
</p>

<p>
Next: insert mode. This requires scroll pos data, which I will initially put in the 'win' module.
</p>

<h2>2011-09-12</h2>

<p>
Up with little time, but got append working. Next: insert. It works too.
</p>

<p>
Next: line scrolling.
</p>

<p>
After work. Will implement '$' before line scrolling, for easy move-to-end-of-line.
Done. Will also add 'q' cmd now that ESC no longer works to exit the app.
</p>

<p>
quit cmd works.
</p>

<h2>2011-09-13</h2>

<p>
Up early, time to code. Get the scrolling working.
</p>

<p>
I thought it would be a fairly simple thing to get started on, but I see that I need
to think more deeply about the problem. There are a few pieces involved:
</p>
<ul>
<li>the screen cursor
<li>an array of text lines, collectively the text buffer
<li>a window that is a subset of the screen area
</ul>

<p>
These pieces must somehow be combined to map a subset of the text lines into
a 'view' on the screen.
</p>

<p>
Previously, I had the notion of using the cursor module to manage scrolling, but
currently the cursor position only refers to the location on the screen. There
needs to be some representation of cursor position in the line buffers as well.
I'll probably think about this on a bike ride in to work.
</p>

<p>
After work, taking a break from biking home to work a little more to get my
mind in the groove. This morning, I decided I needed something like 'scr_to_buf()'
and 'buf_to_scr()' to determine scroll offsets on cursor move. Also, I'll
change existing cursor.get_pos() function to cursor.get_scr_pos(), and also add
cursor.get_buf_pos(). The cursor must somehow be associated with a row,col position
in the buffer, not just with the screen. The movement actions will cause
the cursor.set_buf_pos() to be called, which in turn will update the screen pos.
</p>

<p>
A little more biking, a little more thought. I will create the buffer module
with functions that operate on buf tables.
</p>

<h2>2011-09-14</h2>

<p>
Up early, get coding. Must finish buffer code and get the program working again.
</p>

<h2>2011-09-15</h2>

<p>
Another day, up early, must finish buffer code and get the program working again.
</p>

<p>
Ok, finished the initial implemention of the buffer code, let the debugging begin!
</p>

<p>
Got an initial display, then error in util.isdigit(). I'm tempted to add stack trace
output in the error handler.
</p>

<p>
On the bus to work, will read a little about lua debug, maybe implement stack trace if
time.
</p>

<p>
Added call to debug.traceback() after lua pcall() in tf_edit.c, but it didn't
print anything on error.
</p>

<p>
After work on the bus, read a little more of the lua book and realized that I need
to use xpcall() instead with debug.traceback as the error function.
</p>

<h2>2011-09-16</h2>

<p>
Friday, Hallelujah. Up real early, gonna figure out that debug deal. Amazingly, last
night, I couldn't find any examples of lua_pcall() that use an error handler on
Google. Will try for a bit to just figure it out.
</p>

<p>
Tried one more thing, then started to debug the C code in gdb, realized I was on
a Mac, time to push this baby via git to Linux.
</p>

<p>
On my linux box, looks like the git clone worked. All I did was:
</p>
<pre>
  git clone ssh://williamknight@mhackslab/~/proj/git/vblend
</pre>

<p>
First though, I needed to add 'git-upload-pack' to my path on my mac. So now, probably
just some fix-ups to get the project to build in linux, hopefully not too much work.
</p>

<p>
First though, I will just commit this devlog text and make sure I can pull it back from
my mac.
</p>

<p>
Ok, I did it. Just did a pull from my mac specifying the path via ssh to my linux box.
Easy. I'll leave this comment on mac side while continuing edits on linux side just
for some merging practice.
</p>

<p>
Home, Friday! Yeah! A little progress hopefully before relaxing tonight. Will write
a stub lua program to test lua_pcall(), which I realized that I can debug on the mac
with gdb.
</p>

<p>
Got the test app running. The deal now is that the error function is being called
regardless of whether an error occurs and there is no error message.  Ah, it's
not calling the freakin test func.
</p>

<p>
Sweet, got the traceback working. Just had to push the error handler func before
the pcall() func and specify a stack pos arg of '1' for the handler arg.
</p>

<p>
So now here is the stack trace of the current keydown error:
</p>
<pre>
mhackslab:test $ r
---l_traceback
err: ./lua/util.lua:8: bad argument #1 to 'byte' (string expected, got nil)
[./lua/util.lua]:29
2C function
3C function
[./lua/util.lua]:8
[./lua/normal_mode.lua]:71
[lua/tf_edit.lua]:168
[lua/tf_edit.lua]:157
lua_pcall returned: 0
mhackslab:test $ 
</pre>

<h2>2011-09-17</h2>

<p>
Up early Saturday morn, didn't drink too much beer, let's go.
</p>

<p>
I fixed the proximate problem (I had added 'local' declarations to all function local vars,
but did it mindlessely and some were not in the right scope). Stack traces helps
the fixes, but a real debugger would be nice. Will have to create it at some point.
</p>

<p>
Cursor movement is working again!
</p>

<p>
Command mode is working again!
</p>

<h2>2011-09-18</h2>

<p>
Sunday afternoon, after staying up ridiculously late. Working on insert code.
</p>

<p>
Stack trace still not working right, debugging again in gdb:
</p>
<pre>
mhackslab:test $ r
_debug flag set
failed calling lua draw handler: error in error handling
lua_draw(): No such file or directory
mhackslab:test $ 
</pre>

</p>
. Rebuilt lua lib with -O0 -g.
</p>

<p>
Tracing in to the lua code, I can't see how the error handler is called. Next, 
will trace in for a case where the error handler _is_ called to see how.
</p>

<p>
Here (from running test_lua_pcall):
</p>
<pre>
breakpoint 1, l_traceback (L=0x100120) at test_lua_pcall.c:14
14printf("BEG l_traceback()\n");
(gdb) bt
#0  l_traceback (L=0x100120) at test_lua_pcall.c:14
#1  0x00009191 in luaD_precall (L=0x100120, func=0x801054, nresults=1) at ldo.c:319
#2  0x000093f0 in luaD_call (L=0x100120, func=0x801054, nResults=1) at ldo.c:376
#3  0x00008390 in luaG_errormsg (L=0x100120) at ldebug.c:625
#4  0x000083e4 in luaG_runerror (L=0x100120, fmt=0x254ac "attempt to %s %s '%s' (a %s value)") at ldebug.c:636
#5  0x00008097 in luaG_typeerror (L=0x100120, o=0x80103c, op=0x25587 "call") at ldebug.c:574
#6  0x00008d5c in tryfuncTM (L=0x100120, func=0x80103c) at ldo.c:248
#7  0x00008e40 in luaD_precall (L=0x100120, func=0x80103c, nresults=0) at ldo.c:268
#8  0x000180e3 in luaV_execute (L=0x100120, nexeccalls=3) at lvm.c:587
#9  0x00009407 in luaD_call (L=0x100120, func=0x801018, nResults=0) at ldo.c:377
#10 0x00003ac7 in f_call (L=0x100120, ud=0xbffff70c) at lapi.c:800
#11 0x0000865e in luaD_rawrunprotected (L=0x100120, f=0x3a9d &lt;f_call&gt;, ud=0xbffff70c) at ldo.c:116
#12 0x0000979a in luaD_pcall (L=0x100120, func=0x3a9d &lt;f_call&gt;, u=0xbffff70c, old_top=24, ef=12) at ldo.c:463
#13 0x00003b64 in lua_pcall (L=0x100120, nargs=0, nresults=0, errfunc=1) at lapi.c:821
#14 0x00001f31 in main (argc=1, argv=0xbffff78c) at test_lua_pcall.c:50
(gdb) 
</pre>

<p>
Here is where I want to look:
</p>
<pre>
void luaG_errormsg (lua_State *L) {
  if (L-&gt;errfunc != 0) {  /* is there an error handling function? */
    StkId errfunc = restorestack(L, L-&gt;errfunc);
    if (!ttisfunction(errfunc)) luaD_throw(L, LUA_ERRERR);
    setobjs2s(L, L-&gt;top, L-&gt;top - 1);  /* move argument */
    setobjs2s(L, L-&gt;top - 1, errfunc);  /* push function */
    incr_top(L);
    luaD_call(L, L-&gt;top - 2, 1);  /* call it */
  }
  luaD_throw(L, LUA_ERRRUN);
}
</pre>

<p>
The ttisfunction macro is where the failure is occurring for tf_edit. Here is
the definition:
</p>
<pre>
/Users/williamknight/swtools/lua/lua-5.1.4/src//lobject.h:#define ttisfunction(o)(ttype(o) == LUA_TFUNCTION)
</pre>
<pre>
Breakpoint 1, luaG_errormsg (L=0x1b4e20) at ldebug.c:620
620    StkId errfunc = restorestack(L, L-&gt;errfunc);
(gdb) p L-&gt;errfunc
$2 = 12
(gdb) n
621    if (!ttisfunction(errfunc)) luaD_throw(L, LUA_ERRERR);
(gdb) p errfunc
$3 = (StkId) 0x1668300c
(gdb) 
</pre>

<p>
Definition of ttisfunction:
</p>
<pre>
/Users/williamknight/swtools/lua/lua-5.1.4/src//lobject.h:#define ttisfunction(o)(ttype(o) == LUA_TFUNCTION)
</pre>


<p>
Definition of ttype:
</p>
<pre>
/Users/williamknight/swtools/lua/lua-5.1.4/src//lobject.h:#define ttype(o)((o)-&gt;tt)
</pre>

<p>
Definition of LUA_TFUNCTION:
</p>
<pre>
/Users/williamknight/swtools/lua/lua-5.1.4/src//lua.h:#define LUA_TFUNCTION6
</pre>

<pre>
(gdb) p *errfunc
$4 = {
  value = {
    gc = 0x1b8ea0, 
    p = 0x1b8ea0, 
    n = 8.922746513389578e-318, 
    b = 1805984
  }, 
  tt = 5
}
(gdb) 
</pre>

<p>
type 5 is a table. Next: find out why.
</p>

<p>
Re-run test_lua_pcall, b at lapi.c:815:
</p>
<pre>
Breakpoint 1, lua_pcall (L=0x100120, nargs=0, nresults=0, errfunc=1) at lapi.c:815
815    StkId o = index2adr(L, errfunc);
(gdb) p errfunc
$1 = 1
(gdb) n
817    func = savestack(L, o);
(gdb) p o
$2 = (StkId) 0x80100c
(gdb) p o-&gt;tt
$3 = 6
(gdb) 
</pre>

<p>
Re-run tf_edit, b at lapi.c:815:
</p>
<pre>
Breakpoint 2, lua_pcall (L=0x1b4e40, nargs=0, nresults=0, errfunc=1) at lapi.c:815
815    StkId o = index2adr(L, errfunc);
(gdb) n
817    func = savestack(L, o);
(gdb) p o-&gt;tt
$1 = 5
(gdb) 
</pre>

<p>
Next: I need to start creating some stack dump/inspection functions.
</p>

<p>
Added the one from the lua book, here is the problem:
</p>
<pre>
--- BEG dump_lua_stack
top: 1205
failed calling lua draw handler: error in error handling
lua_draw(): No such file or directory
mhackslab:test $ 
</pre>

<p>
I'm think lack of recursion checks and stack overflow are the cause of this problem. Will
find out soon.
</p>

<h2>2011-09-19</h2>

<p>
Monday, a little time before I have to go. Will add lua stack space checks now.
</p>

<p>
Added printout of lua stack top in all functions that call lua, looks like something 
is not getting popped:
</p>
<pre>
...
END draw()
BEG tick()
top: 17
top: 18
END tick()
BEG draw()
top: 18
top: 19
END draw()
BEG tick()
top: 19
top: 20
END tick()
BEG draw()
top: 20
top: 21
Error: lua checkstack: top: 21
</pre>

<p>
So my first thought is that I need to pop the error handler function that I've been pushing.
</p>

<p>
That fixes the stack overflow problem, now I can see the args on the stack at the failed
error-handler call:
</p>
<pre>
mhackslab:test $ r
_debug flag set
--- BEG lu_dump_stack
top: 3
{t: [table], t: [function], t: [function], }
--- END dump_lua_stack
failed calling lua draw handler: error in error handling
lua_draw(): No such file or directory
mhackslab:test $ 
</pre>

<p>
That's all for this morning.
</p>

<h2>2011-09-20</h2>

<p>
Tuesday morn, not a whole lot of time. Will try to make some progress on this error handler
problem.
</p>

<p>
By calling lu_dump_stack(), I've determined that the stack starts out empty and then goes
to 1 with a table pushed, after the first call to luaL_register(L, "tflua", _tflua_lib):
</p>
<pre>
AFT lua_openlibs()
--- BEG lu_dump_stack
top: 0
{}
--- END lu_dump_stack
AFT luaL_register()
--- BEG lu_dump_stack
top: 1
{t: [table], }
--- END lu_dump_stack
</pre>

<p>
I think the problem here may be that I'm using the luaL_register() incorrectly somehow.
It might be intended to be used only in conjunction with a shared library that is
loaded by the require statement in lua code, whereas currently I'm keeping the code
in the main application...? Not sure if this is the problem, will need to think about
it.
</p>

<p>
Next, I will make a test app with a shared lib file to register in the way described
in the PIL book and check the state of the stack there.
</p>

<h2>2011-09-21</h2>

<p>
Tuesday morning, I know what to do.
</p>

<p>
Finished coding, trying to create shared lib on mac, it can't make .so, must make
.dylib, but how to tell lua to load it? 
SO answer here: http://stackoverflow.com/questions/5900816/osx-loading-dylib-lua-module
</p>

<p>
Even simpler, I can just specify a '-o tlr.so'. The trick was to specify the '-dynamic'
flag with gcc:
</p>
<pre>
tlr.so: tlr.o
$(CC) -dynamiclib -o tlr.so $&lt; $(lua_libs)
</pre>

<p>
Well, doesn't exactly work, after building, when I do "require('tlr')" in lua, it
doesn't cause an error but it defines a function, not a table. And then when I call
the function it segfaults. Freakin macs.
</p>

<p>
google.
</p>

<p>
After downloading some code from lhf and more compiling, I noticed a compiler warning
compiling tlr.c and realized I was calling lua_register() instead of luaL_register()!
</p>

<p>
It's working now.
</p>

<p>
After work, maybe I can get a little work started on the move of the existing 
registered lua funcs in tf_edit.c over to a separate C shared lib module.
</p>

<p>
Ok, finally have a function on the stack, hopefully it is the traceback func:
</p>
<pre>
mhackslab:test $ r
AFT lua_newstate()
top: 0
{}
AFT lua_openlibs()
top: 0
{}
AFT lua_register()
top: 0
{}
AFT lua_dofile()
top: 0
{}
lua_draw(): BEF push traceback
top: 0
{}
lua_draw(): AFT pcall
top: 1
{t: [function], }
rc: 0
mhackslab:test $ 
</pre>

<p>
Yes! Finally got the damn traceback during the original error:
</p>
<pre>
--- BEG tf_traceback
err: ./lua/buffer.lua:106: attempt to get length of local 'ln' (a nil value)
[./lua/util.lua]:29
2C function
[./lua/buffer.lua]:106
[lua/tf_edit.lua]:184
lua_pcall returned: 0
mhackslab:test $ 
</pre>

<p>
I can see where the error is in the lua code, but now instead of continuing with
printf-style debugging, I am seriously considering biting the bullet and seeing
if I can implement a lua debugger with breakpoints and all that!
</p>

<p>
Checking out remdebug, I see that I already downloaded it once!
</p>

<h2>2011-09-22</h2>

<p>
Thursday, up at the usual time, some time for programming. I read a chunk of the debug
library chapter in PIL and think I have an idea on how to implement a simple
debugger. Previously, I thought I would have to do it in C, but now I'm thinking
I should be able to do a lot of it in lua, which will make the parsing much easier.
</p>

<p>
Wow, think I might actually have the freakin debugger working already!
</p>
<pre>
mhackslab:test $ d
&gt; b buffer.lua:104
breaking at buffer.lua:104
breakpoint set
&gt; c
continuing program execution
breakpoint hit!
[./lua/util.lua]:29
[./lua/util.lua]:47
[./lua/buffer.lua]:104
[lua/tf_edit.lua]:184
trace&gt; 
</pre>

<p>
Nice progress this morning.
</p>

<p>
After work, still at work! I think I will do a little more coding, and maybe push the dang git
repos to my modwest account! In fact, I should probabl do that first.
</p>

<p>
Later, at Wardens. A little more work before dancing. I did the git push, it was pretty
easy. Here is all that was required on the local end:
</p>
<pre>
 2237  git remote add origin mmmmhack@shell.modwest.com:git/vblend
 2238  git push origin master
</pre>

<p>
On the remote end, it was a little tricker. I did:
</p>
<pre>
/git/vblend $ git --bare init
/git/vblend $ cd ../..
/ $ mkdir -p proj/vblend
/ $ cd proj/vblend
/proj/vblend $ git remote add origin /git/vblend
/proj/vblend $ ???
</pre>

<p>
Don't remember that last part, will look it up later.
</p>

<p>
So biking in, I figured I can just do nearly all the debugger code in lua.
Starting on a new lua module, test/lua/tf_debug.lua, and function debug_console().
</p>

<h2>2011-09-23</h2>

<p>
Sweet Friday, up good and early. Finished conversion of debugger code from C to lua,
it works!
</p>

<p>
Ok, way late for work, but printing of variable values in debugger is starting to happen.
</p>

<h2>2011-09-24</h2>

<p>
Saturday, had fun last night but can still code this morning. Continuing with routines to
print variable values in the debugger.
</p>

<p>
I added code to determine the stack level of the debug target function at breakpoint,
independent of how many levels of debug functions there are. It took me more work than
I thought.
</p>

<h2>2011-09-25</h2>

<p>
Sunday morning, back at it. Working on the recursive printing of expressions.
</p>

<p>
It's working.
</p>

<p>
The debugger helped me find the buffer-drawing bug. The bug is that all lines in a window needed
to be drawn on vscroll, but the code assumed that the array of lines in the buffer was at
least the size of the number of lines in the window, which is not true and caused an array bounds error:
</p>
<pre>
-- redraw all lines in window if scrolled
if b.scrolled then
beg_row = b.scroll_pos[1]
end_row = math.max(#b.lines - 1, beg_row + b.win_size[1] - 1)
end
for i = beg_row, end_row do
=&gt;local ln = b.lines[i]
local end_col = math.min(#ln, beg_col + b.win_size[0])
-- for now: pad out the rest of the line to the end of the buffer window. later, maybe optimize?
local pad = b.win_size[0] - (end_col - beg_col)
local s = string.sub(ln, beg_col, end_col) .. string.rep(" ", pad)
tflua.set_screen_buf(scr_row, scr_col, s)
scr_row = scr_row + 1
end
</pre>

<p>
(end_row is 34, b.lines = {[0] = "012345..."})
</p>

<p>
Probably the fix for this is to test for end of buffer lines and draw blank lines past the end.
In any case, the built-in debugger is a success!
</p>

<p>
Now I've got plenty of buffer-scrolling logic to work out. Since my head is fuzzy and I'm
lazy, I will try to create a bunch of unit tests to get it worked out.
</p>

<p>
Starting on unit tests for buffer, first up, will add an intermediate step of creating
the display buffer, which can then be checked by unit tests, before copy to actual
screen buffer.
</p>

<p>
Started writing unit tests, they are so easy to do in lua. But now I'm wanting to use the
debugger for the unit tests!
</p>

<p>
Damn, it's pretty easy to do, just needed a couple of requires and a call to 'debug_console()'
in the main() function of the unit test. But need to tweak checking of the src lines
to break at in check_breakpoints().
</p>

<p>
Did that, but still need more tweaks for detecting correct target function level, it's apparently
different from case where debugger runs in tf_edit.
</p>

<p>
Debugging the debugger:
</p>
<pre>
&gt; c
continuing program execution
breakpoint hit!
--- BEG debug_console(): bot_level: 9, cur_level: 1, M.target_level: 6
[../tf_debug.lua]:63 (traceback)
[../tf_debug.lua]:249 (debug_console)
[../tf_debug.lua]:56 (nil)
[../buffer.lua]:20 (new)
[test_buffer.lua]:61 (nil)
6C function
[test_buffer.lua]:74 (main)
[test_buffer.lua]:84 (nil)
9C function
&gt; 
</pre>

<pre>
--- BEG debug_console(): bot_level: 9, cur_level: 1, M.target_level: 6
1 [../tf_debug.lua]:63 (traceback)
2 [../tf_debug.lua]:249 (debug_console)
3 [../tf_debug.lua]:56 (nil)
4 [../buffer.lua]:20 (new)
5 [test_buffer.lua]:61 (nil)
6 C function
7 [test_buffer.lua]:74 (main)
8 [test_buffer.lua]:84 (nil)
9C function
<pre>

<p>
Target is 2 levels above debug_console level of 2, so target abs level 
is 2+2 = 4, which is correct, but debug_console level is wrong.
</p>

<p>
Fixed that, but stack level still off by one.
</p>

<h2>2011-09-26</h2>

<p>
Must get the debugger working again. Here's the current problem: the current
stack bottom is 12, it's dumping from stack level 8.
</p>

<p>
Part of the problem is that I keep getting fooled by the stack levels, as reported by
traceback(), which are all incremented by 1 relative to the caller, in this case,
eval_local_var_expr().
</p>

<p>
Here is the traceback output in eval_local_var_expr():
</p>
<pre>
eval_local_var_expr(): looking for local var at stack level 7
 1 [../tf_debug.lua]:63 (traceback)
 2 [../tf_debug.lua]:146 (eval_local_var_expr)
 3 [../tf_debug.lua]:190 (print_local_var_expr)
 4 [../tf_debug.lua]:220 (print_expr)
 5 [../tf_debug.lua]:288 (debug_console)
 6 [../tf_debug.lua]:56 (nil)
 7 [../buffer.lua]:20 (new)
 8 [test_buffer.lua]:61 (nil)
 9C function
10 [test_buffer.lua]:74 (main)
11 [test_buffer.lua]:84 (nil)
12C function
</pre>

<p>
Executing eval_local_var_expr(), it would be:
</p>
<pre>
eval_local_var_expr(): looking for local var at stack level 7
 1 [../tf_debug.lua]:146 (eval_local_var_expr)
 2 [../tf_debug.lua]:190 (print_local_var_expr)
 3 [../tf_debug.lua]:220 (print_expr)
 4 [../tf_debug.lua]:288 (debug_console)
 5 [../tf_debug.lua]:56 (nil)
 6 [../buffer.lua]:20 (new)
 7 [test_buffer.lua]:61 (nil)
 8 9C function
 9 [test_buffer.lua]:74 (main)
10 [test_buffer.lua]:84 (nil)
11 12C function
</pre>

<p>
So I think I will change the return values of getinfo_bottom() and getinfo_level(). Did it,
and the debugger is working again. And helping me find bugs.
</p>

<p>
First 2 unit tests are passing.
</p>

<p>
After, more unit tests!
</p>

<p>
Added new unit test to set content of new line, now I need to think of the appropriate 
function name to update display lines, separate from draw(). Hmmm, maybe I'll call
it 'update_display_lines()'... :)
</p>

<p>
Added it, and another unit test which passes, but no display! More debugging,
need to add bracket indexing to debug print command, it's not working correctly.
</p>

<p>
Fixed.
</p>

<h2>2011-09-27</h2>

<p>
Up in the middle of the night, back to coding. The debugger is helping me find the bugs.
</p>

<p>
More debugger fun. While debugging a line in the middle of a loop, I found that
the 'q' command in the debugger didn't work. At first I tried to understand why
the code wasn't returning to the calling C code to detect the exit state and quit
and then I finally realized that it isn't going to return to the caller C code
until the debugged lua code returns, which won't happen until I turn off the debug 
hook in the 'q' handler. Duh.
</p>

<p>
Fixed.
</p>

<p>
Fixed a bug in the cmd_mode code, but cursor still not working. Need to create
lots more unit tests. I'm going to start the next one and go to bed.
</p>

<p>
Got the buffer incCursor() test in place, but need more code re-org, because it's
trying to call the actual tflua.set_cursor function. Need a mock or something.
But now, back to bed!
</p>

<p>
Up late, gotta go to work, will only do a tiny bit more work, the required stub
function is trivial.
</p>

<p>
Lunch, a tinuy bit of proggin time, finished the setScroll unit test, next:
incCursor one.
</p>

<p>
Got it working (hscroll at right insert, but cursor display still not right,
so next: cursor pos unit tests)
</p>

<h2>2011-09-28</h2>

<p>
Up early today, but spent most of it researching x3d. I don't think it's gonna
happen. Will start looking in to WebGL tomorrow. In the mean time, will do
a few more unit tests before work.
</p>

<p>
buffer tests are passing, next to fix the current cursor-pos bug in insert_mode,
I need to create insert unit tests.
</p>

<p>
First insert_mode unit test is running (but failing).
</p>

<p>
Adding buffer.dump() method, will call it in insert_mode() for comparison of state
agains unit tests.
</p>

<p>
Ok, that helps. I think the current problem is that b.cursor pos is relative to
buffer pos and in set_cursor() it gets converted to window pos, so a cursor pos
of 79 + scroll pos of 1 translates to a cursor window pos of 80, I think.
</p>

<p>
Confirmed, and that will be off-screen. pos needs to be 79.
</p>
<pre>
buffer.set_cursor(): calling tflua.set_cursor(0, 78)
buffer.set_cursor(): calling tflua.set_cursor(0, 79)
buffer.set_cursor(): calling tflua.set_cursor(0, 80)
</pre>

<p>
On the drive in to work, I thought for a bit about stuff and came to the conclusion
that the needed fix is to just subtract the scroll_pos from the cursor_pos to
get the correct cursor position in the window. I'll try it. 
</p>

<p>
Did this, although the situation is a little more complex than I realized because
the scroll position is adjusted _in_ the set_cursr() function to ensure the
cursor position is in the window.
</p>

<p>
Kool, that fixed it!
</p>

<p>
Still lots of other cursor probs though, first one is moving to the beginning of the row,
_after_ doing an insert w/ scroll (it's fine in normal mode before doing insert).  But that's 
all for now.
</p>

<h2>2011-09-30</h2>
<p>
It's Friday! The last couple of days I started making a separate lua app that
does simple graphics using a C module for glfw code. The program is run by
the lua interpreter. I'm thinking of extending this approach by creating 
C modules for both opengl and glfw. Think I'll call the project either 'glua'
(which is prabably already taken) or possibly 'gluah'. Hmm, there is already
glllua, and created by Waldemar Celes to boot. But his link is down.
Maybe gluyah.
</p>

<h2>2011-10-01</h2>

<p>
Saturday morning, up early, little too much beer but I can still program. 'gluyah'
is a stupid name. Just start making the wrappers.
</p>

<p>
pws. todo: write or get a pretty-printer to reformat indenting to 4 spaces.
add return val.
camera, image recog, security, bones, 3d transform from python 3d edit app.
</p>

<h2>2011-10-02</h2>

<p>
uh huh.
</p>
<p>
Sunday morning, continuing work on lua code to generate C wrapper code for glfw.
Code for wrapping most of the functions is working, but to test it I also need
to generate code for the GLFW_XXX constants.
</p>

<p>
Started doing that, going well, but now I need an efficient way to strip out
C block comments. With lua's nice balanced-delimiter matching capabilities,
I think that will be pretty easy.
</p>

<p>
Hmmm, no, reading the docs, looks like the '%bxy' pattern only works with
single-character delimiters. No bigs, I can write a quick pre-processing function
to do it.
</p>

<p>
Finished lua scripts to generate C code for glfw module, it works! Next: gl lib
wrappers.
</p>

<p>
I spoke too soon, glfw.getWindowParam(GLFW_OPENED) isn't working correctly.
</p>

<p>
I'll need to create a simple C caller app to call the 'test.lua' program,
allowing me to step through with gdb.
</p>

<p>
Got the test app built, did some stepping and figured out the bug: I was pushing
positive index values instead of negative ones. Fixed that, now all else I
need is to reverse the order of the negative indexes in 'gen_wrappers.lua'
</p>

<p>
On the gl wrapper, think I will only wrap a selected subset for now. Still
would be nice to do it by parsing header file though. I'll just define
the subset as a list and scan and parse the gl.h header file to do them.
Main thing will be to parse each function declaration, which can be
be either single or multiline:
</p>
<pre>
...
GLAPI void GLAPIENTRY glColor3ui( GLuint red, GLuint green, GLuint blue );
GLAPI void GLAPIENTRY glColor3us( GLushort red, GLushort green, GLushort blue );

GLAPI void GLAPIENTRY glColor4b( GLbyte red, GLbyte green,
                                   GLbyte blue, GLbyte alpha );
GLAPI void GLAPIENTRY glColor4d( GLdouble red, GLdouble green,
                                   GLdouble blue, GLdouble alpha );
...
</pre>

<h2>2011-10-03</h2>

<p>
Monday, up early, continuing work on gen wrapper lua scripts for gl lib. The
existing scripts for glfw make it easier.
</p>

<p>
Finished initial implementation, added to glfw/test.lua, we have a green triangle!
</p>

<h2>2011-10-04</h2>

<p>
Great night's sleep, but not as much time left - let's go. Will start on the higher-lever
lua gamelib module which provides user-friendly functions around the gl and glfw libs.
</p>

<p>
Got the initial implementation of the gamelib.lua module working, along with the
first demo app 'pong.lua'. It always seems to take me longer than I anticipated,
but it's working. Next: add window dim query, fps, font, key input.
</p>

<p>
Home after a long day, time for a little proggin before dinner. Starting on 
a lua wrapper for the existing sys.c module (gamelib needs sys_double_time())
The question is, do I write the wrapper by hand or write another lua 
script to generate it? I'm leaning towards the script approach - the better
I get at auto-generating wrappers for C code, the easier it will be to wrap
additional modules, which I'll definitely need to do.
</p>

<p>
One issue that's cropping up is how to best organize all the lua and C code
that I'm creating. Here are some existing categories:
</p>
<ul>
<li>C code
  <ul>
  <li>C code for opengl           (ex: font/tfont.c)
  <li>C code for utility purposes (ex: util/*.c)
  <li>C code for lua libs         (ex: gl/*.c, glfw/*.c)
  </ul>
<li>lua code
  <ul>
  <li>gamelib                     (ex: gamelib/*.lua)
  <li>vim editing                 (ex: test/lua/tf_edit,buffer,cursor,normal_mode,cmd_mode,line_buf.lua)
  <li>debugging                   (ex: test/lua/tf_debug.lua)
  <li>util                        (ex: test/lua/util.lua)
  <li>wrapper-gen code            (ex: gl/gen_wrappers,gen_constants,preproc_header.lua)
  </ul>
<li>test code
  <ul>
  <li>C test code
  <li>lua test code
  </ul>
</ul>

<p>
So I want to create a lua parser module to generalize and centralize the wrapper-generation code.
Where to put it? A number of the modules currently under test/lua should be moved out of test,
but where? Under 'CATEGORY/lua' subdirs? Or under 'lua/CATEGORY' subdir? I'm going to go
with 'CATEGORY/lua', so will create a parse subdir and put them there. Or maybe just put
the lua files directly under the 'CATEGORY' dir? How do other people do it? For now, think
I'll just put everything under each category (both C and lua) unless there is a reason
to organize more specifically.
</p>

<h2>2011-10-05</h2>

<p>
Up good and early today, but the time is flying. Started on the more generalized lua scripts
to generate wrappers from C header files. It's going well, but I need to think of a way
to specify various options during the processing. I changed the scripts to read from stdin,
maybe I'll also just start doing command-line processing of options. Hmm, problem with that
though is that it's awkward to directly specify a list of selected functions for parsing,
well duh, just allow reading from file then.
</p>

<p>
After work, power very low. I will write my own getopt.lua, I've already done similar
in python.
</p>

<h2>2011-10-06</h2>

<p>
Thursday, wow. Up at the regular time, time for some regular coding. Implementing my
own getopt in lua. The implementation was easy, but does it work?
</p>

<p>
Cool, I believe it does work.
</p>

<p>
Done with work, in car before drive home, will work a little to get my mind going
on finishing this wrapper script, must get it done.
</p>

<p>
Got 'ret_decl, func_name, params' parsed ok with regex.
</p>

<p>
Will add special lua code to convert lua tables to C structs
</p>

<p>
Using the debug a little, I need to add support for printing globals.
</p>

<p>
Also need to fix tflua refs in tf_debug.lua:
</p>
<pre>
&gt; q
lua: ../test/lua/tf_debug.lua:338: attempt to index global 'tflua' (a nil value)
stack traceback:
../test/lua/tf_debug.lua:338: in function 'debug_console'
../test/lua/tf_debug.lua:59: in function &lt;../test/lua/tf_debug.lua:52&gt;
../parse/gen_wrappers.lua:282: in function 'gen_func_wrapper'
../parse/gen_wrappers.lua:320: in function 'main'
../parse/gen_wrappers.lua:334: in main chunk
[C]: ?
mhackslab:util $ 
</pre>

<p>
Fixed, just replaced the tflua.quit() with os.exit()
</p>

<p>
sel_funcs is working
</p>

<h2>2011-10-07</h2>

<p>
Friday, Hallelujah. Solid night's sleep, but not a whole lot of time left this
morning, gotta get this wrapper done! Need to implement 'remove-prefix' option.
</p>

<p>
Did it, it works. Next, continue adding rest of code generation.
</p>

<p>
Tried to use the debugger again, it's still got issues...grr
The stack doesn't appear correct when I break in gen_func_wrapper().
Oh well, there's always printf.
</p>

<p>
Ok, finally got the code for the first function generated. Now, just need
to output to file, and add the register list output and we'll be done for now.
But time to go to work!
</p>

<h2>2011-10-08</h2>

<p>
Sweet Saturday morning. Next up: change the gen_wrappers script to output
file names with 'lua_XXX_' prefix where XXX is the base part of the input
header file.
</p>

<p>
Output of lua_xxx_func_def.c and lua_xxx_func_reg.c is working, now just
need to add generation of the main c file that includes them.
</p>

<p>
No, will just manually generate that one, I've spent enough time
on the wrapper scripts for the time being.
</p>

<p>
Built the lib, tested pong.lua, fps works!
</p>

<p>
pws
1.1M    /Users/williamknight/tmp/test1/sounds
1.2M    /Users/williamknight/tmp/flex
1.3M    /Users/williamknight/tmp/test1/food_images
1.8G    /Users/williamknight/tmp/dod-dvd
1.8G    /Users/williamknight/tmp/dod-dvd/VIDEO_TS
104K    /Users/williamknight/tmp/vb/Class 5
108K    /Users/williamknight/tmp/joglEdit
112K    /Users/williamknight/tmp/xchemo.ii
116K    /Users/williamknight/tmp/vb/Class 6
120K    /Users/williamknight/tmp/fbots.ii
</p>

<h2>2011-10-09</h2>

<p>
Tried to do what was supposed to be a quick port to win32 yesterday (not
in the sharpest frame of mind) and ran into problems loading glfwCloseWindow()
from the glfw.dll that I fixed by renaming the lua wrapper dll to something
different. Although I'm not 100% sure this was necessary, I will stick with
this change for now.
</p>

<p>
Did it, what next? Need to get the fontlib wrapped.
</p>

<p>
First, been working on getting the gl lib wrappers to be generated by the parse
wrapper scripts. Now: improving the debugger by getting it to print globals as
well as locals.
</p>

<p>
Added printing of globals, works, which is great, but I still don't see
how to access and print 'local' variables of a module.
</p>

<p>
Looks like I'll have to do a little more review of lua execution environments,
which is all to the good.
</p>

<h2>2011-10-10</h2>

<p>
Monday morning, up early, reading about chunks. A chunk is treated as the body
of an anonymous function. So the locals declared in any file should be accessible
from the debug library. Reading chapter 6, such local variables of a file
are also upvalues for functions defined in the file.
</p>

<p>
No, after doing some tests, I see that such 'file' locals are only upvalues for
a function if it references them in the function.
</p>

<p>
Added printing of upvalues, but there is a level off-by-1 hack that I had to
do but don't understand why. Little by little though, the debugger gets better
and helped me identify another bug.
</p>

<p>
I need to come up with a 'best-way' of identifying the target stack level
once and for all.
</p>

<p>
After work, back to working on gen_wrappers, need to trim space after ctype
</p>

<p>
:[ still a problem printing vars in the debugger.
</p>

<pre>
--- lua debug console version 0.1
&gt; o
local 0001: name: [param_decls], val: [table: 0x119d00]
local 0002: name: [params], val: [table: 0x112830]
local 0003: name: [(for generator)], val: [function: 0x100980]
local 0004: name: [(for state)], val: [table: 0x119d00]
local 0005: name: [(for control)], val: [1]
local 0006: name: [i], val: [1]
local 0007: name: [p], val: [GLclampf red]
local 0008: name: [ctype], val: [GLclampf ]
local 0009: name: [cident], val: [red]
local 0010: name: [param], val: [table: 0x12a5d0]
&gt; p param
invalid expression: param
&gt; 
</pre>

<p>
This is the source of my debugger woes:
<p>
<pre>
  if cur_level then
    M.target_offset = bot_level - (cur_level + 2)  -- getinfo() stack level of target function, relative to bottom level (2 levels above debug_consol())
  else
    M.target_offset = nil
  end
</pre>

<p>
This level was defined in the context of hitting a breakpoint in 'check_breakpoints()' but
now I'm calling the debug_console() directly in the target code and the target level is
off by one. I need to add a check that looks at the number of debugger functions on the
stack to determine the true target level.
</p>

<h2>2011-10-11</h2>

<p>
Last night I realized some changes that should be done to the debugger to improve it.
First: all functions that need to reference a target level should receive a relative
level parameter and calculate the actual level inside the function. This will fix the
current behavior where the level breaks if the function call level changes.
</p>

<p>
Second, determine the target level programmatically instead of using a fixed value,
so it's correct no matter whether debug_console() is called directly from the
target or from check_breakpoint().
</p>

<p>
Created count_up_to_src_level() and target_level() functions, that is going to help.
</p>

<p>
Ok, looks like it's working. Next, I would really like to implemnt 'next' and 'step'
control. But will checkin code first. Wait, should also test breakpoint.
</p>

<p>
Tested it, looks like still correct location, hallelujah.
</p>

<p>
Next thing to work on: add script to replace defines in header files, to fix stuff
like this:
</p>
<pre>
beg gfw: decl: [GLAPI void GLAPIENTRY glClearIndex( GLfloat c );]
  ret_decl: [GLAPI void GLAPIENTRY], func_name: [glClearIndex], params_decl: [ GLfloat c ]
  param  1: [GLfloat] [c], luatype: [number]
  lua: ../parse/gen_wrappers.lua:347: lua_ret_type is nil for c_ret_type: [GLAPI void GLAPIENTRY]
</pre>

<p>
Created script, it works (but not robustly, need to update to support full token-scanning and
substitution as opposed to simple gsub).
</p>

<p>
parse/gen_wrappers.lua script is finally now parsing the whole gl header file. Now just
have to finish implementation of arg, func call and return emission.
</p>

<h2>2011-10-12</h2>

<p>
Tuesday morning, slept in, maybe an hour of programming time left. Will start working on
using the parse/gen_wrappers.lua script to generate wrappers for glfw.
</p>

<p>
Need to work on the declaration parsing code, it's currently getting tripped up by a
nested ; in a struct declaration. At some point, I'll probably need to implement a 
real parser, but for now, would just like to get on with the game dev stuff!!
</p>

<p>
After work, at Bernices, inspired by attending a political rally at Caras Park 
(Occupy Missoula). Got to get moving on the game. Driving this mornign, I thought
that a full parse won't be needed right now. Will just create a few new scripts
to:
</p>
<ul>
<li>join continued lines
<li>remove preproc blocks (#ifXXX ... #endif)
<li>remove blank lines
<li>read the resulting file char-by-char and parse declarations by ignoring
    everything in the outermost { } delimiters.
</ul>

<p>
Got it working.
</p>

<p>
At home, got parse/filter_ifdefs.lua script working. 
</p>

<p>
Next: start on 'strip_non_func_decls.lua'.
</p>

<h2>2011-10-13</h2>

<p>
Up at 7, Thursday, getting to work. Last night, I realized that parsing the declarations
to only yield function declarations works best when called from within the gen_wrappers
script, as it will work like an iterator.
</p>

<p>
glfw wrapping is now working with the parse scripts.
</p>

<p>
Next: wrap sys then move on to the font module.
</p>

<h2>2011-10-14</h2>

<p>
Sweet Friday, up at 6, think I'll start on wrapping the tfont module. Nope, the sys module
is broken, need to fix that first. Fixed. And I think I'll get the keyboard stuff
in glfw working first too.
</p>

<p>
The getKey() function works already. Next, I added code to report skipped functions in
parse/genWrapper and currently it skips 35 funcs in glfw. Think I'll start adding support
to return values via param int pointers so functions like glfwGetWindowSize() will
can be wrapped. This will require an additional kind of input to the wrapper script
to declare certain params as return params. Either that, or I could just _assume_
that any int* param is a return param. But that might make an ass out of u and me.
</p>

<p>
Gotta have some kind of declaration, hiding stuff, implicit and unexpected behavior in 
sw is generally bad bad.
</p>

<p>
I suspect over time there will be more qualifications and specifications needed
for wrapping, but for now, will just create another input file type 'RET_PARAMS'
with a format like:
</p>
<pre>
return {
  [func_name,param_id]=true,
}
</pre>

<p>
While I'm at it, I'm generalizing the use of lua files for parse/gen_wrapper.lua params.
</p>

<p>
Updated gen header and gen wrappers for gl, added verbose flag to parse.gen_wrappers.luaparse. 
So much little workies.
</p>

<p>
Next: finish implementing parse/gen_wrappers --ret-params option.
</p>

<h2>2011-10-15</h2>

<p>
Ah, the weekend. Quiet early Saturday morning with coffee and rain outside. Starting on
the --ret-params option.
</p>

<p>
Finished implementation, looks like it works. Well, almost. After compiling, I realize
another little piece of info is needed, the local declaration of 'int *' ret params
needs to be 'int'. Will probably have to supplement the info in the ret_params map.
</p>

<p>
Maybe for now, will just take the simple approach approach and assume a '*' needs
to be stripped off of the ctype return param.
</p>

<p>
Did it, it worked.
</p>

<p>
Testing getWindowSize() in pong.lua, using the debugger again (moved out of test/lua
to debugger), and another debugger problem:
</p>
<pre>
mhackslab:gamelib $ lua pong.lua 
--- lua debug console version 0.1
level  5: src: [=[C]]
level  4: src: [@pong.lua]
level  3: src: [@./gamelib.lua]
level  2: src: [@../debugger/debugger.lua]
level  1: src: [@../debugger/debugger.lua]
level  0: src: [=[C]]
level -1: src: [=(tail call)]
level -2: src: [=(tail call)]
level -3: src: [=(tail call)]
level -4: src: [=(tail call)]
level -5: src: [=(tail call)]
...
</pre>

<p>
Had to fix some problems that resulted from renaming the debugger module.
</p>

<p>
Fixed that, but more debugger debug fun:
</p>
<pre>
mhackslab:gamelib $ lua pong.lua 
--- lua debug console version 0.1
 1 [./gamelib.lua:79] (win_height)
 &gt; print width
 lua: ../debugger/debugger.lua:314: assign to undeclared variable 'func_name'
 stack traceback:
 [C]: in function 'error'
./strict.lua:28: in function &lt;./strict.lua:24&gt;
../debugger/debugger.lua:314: in function 'print_expr'
../debugger/debugger.lua:467: in function 'debug_console'
./gamelib.lua:79: in function 'win_height'
pong.lua:15: in main chunk
[C]: ?
mhackslab:gamelib $ 
</pre>

<p>
Cool, that one was a catch of a missing local declaration after I started
requiring strict.
</p>

<p>
Ok, debugger got me to the point of needing to step through the wrapper
code, time to crank up the ole' gdb. I'll need to use a C app with lua
calls for that, think I've already made one before, will adapt it.
</p>

<p>
Hah, went through the whole trouble of creating a debug app that loads lua_glfw.o
(which was working) and discovered the cause of the bug before I even got the chance
to run gdb. I was retrieving the window width and height before the window had
been created, duh.
</p>

<p>
Ok, wrapped functions with return parameters (at least lua_glfw.getWindowSize()) are
working.
</p>

<h2>2011-10-16</h2>

<p>
A little too much funs last night, my brain is dragging. This morning I started
creating the 'hello world' demo for the gamelib framework and this motivated
me to start on the documentation as well. I'm going to follow many of the vim
conventions for documentation. I plan on leveraging capabilities of the vim editor 
itself for navigating and displaying the docs (links, syntax coloring). The
destination files will be simple text format, with simple markup vim conventions.
</p>

<p>
A need for syntax coloring is finally driving me to learn how syntax coloring
works in vim and how to create my own syntax coloring scripts. 
</p>

<p>
Today is probably a good day to do the mundane and sometimes tedious work of
creating documentation, as opposed to coding and debugging.
</p>

<p>
Ha, all I really needed to do for now is 'se ft=help'. I knew that leveraging
vim functionality would give quick payoffs.
</p>

<p>
Demo function works, now must start on the wrapper for tfont module.
</p>

<p>
Took a big break today because I wasn't feeling well, and also I'm lazy. Now
I need to add support for the first 'const char*' param type to parse/gen_wrappers,
should be very straightforward.
</p>

<p>
Built the lua_tfont module, trying to get it to work with the hello.lua demo,
I need to link in png-loading support.
</p>

<p>
pws. sunlight-powered hydrolysis, using tea.
</p>

<h2>2011-10-19</h2>

<p>
Took a break over the last couple of days reading about shared libraries to deal with
some linking and loading problems involving the additional shared libraries that I
created for the demo app.
</p>

<p>
Often when I run in to these kinds of problems I start reading the fundamentals of
linking and loading, hoping to acquire a deep and detailed understanding of what's
really going on. Generally after a little time and progress, I return to just trying
to get it to work. That's where I'm at right now. I just created a shared lib
for the util object files, using the '-dynamiclib -undefined dynamic_lookup' flags.
I think added this util.so file to the end of the link line for the lua_sys.so
shared lib. Now I'll try copying both to the gamelib directory and see what happens.
</p>

<p>
Here is the current error I'm getting:
</p>
<pre>
mhackslab:gamelib $ lua pong.lua
lua: error loading module 'lua_sys' from file './lua_sys.so':
dlopen(./lua_sys.so, 2): Symbol not found: _png_create_info_struct
  Referenced from: /Users/williamknight/proj/git/vblend/gamelib/util.so
  Expected in: dynamic lookup

stack traceback:
[C]: ?
[C]: in function 'require'
./gamelib.lua:11: in main chunk
[C]: in function 'require'
pong.lua:5: in main chunk
[C]: ?
mhackslab:gamelib $ 
</pre>

<p>
I'm fairly confident that the _png_create_info_struct symbol is in the util.so
lib so need to figure out why it isn't being found.
</p>

<p>
nm on util.so shows:
</p>
<pre>
         U _png_create_info_struct
</pre>

<p>
So, just need to link either a static or shared lib for png.
</p>

<p>
Hmm, this is weird, the only reference to libpng in my Makefiles is in util/Makefile.osx
and it's not even referenced. Did it used to be?
</p>

<p>
Weird, git history doesn't appear to show any use of it.
</p>

<p>
I'm going to go back to the previous working config of pong.lua to see how the png lib
gets loaded. Learned to retrieve prev version of a file using 'git show':
</p>
<pre>
mhackslab:util $ git show HEAD^:./Makefile.osx &gt; Makefile-old.osx
</pre>

<p>
Got it running again, now to search for _png_create_info_struct.
</p>

<p>
Not there, so as usual, there is more going on than meets the eye. Must be loading
it from a system path.
</p>

<p>
But wait dumbkopf, no actual use is made of png in the old version of the gamelib
app. It's only when you created the 'util.so' that the reference was needed.
</p>

<p>
More clarity. For some reason I thought that png-loading capability was present
in glfw and so thought maybe it was referencing libpng there somehow but after
looking at nm output for libglfw.dylib and not finding it and then carefully
reading the docs, I discover that it only supports tga format!
</p>

<p>
So at this point my plan is to link libpng.a statically with the util.so shared
lib and intend that this is going to fix the current loading problems.
</p>

<p>
Did it, it worked!
</p>

<p>
I also realize I can avoid the table-renaming of 'lua_sys' and 'lua_glfw' in
lua because the actual shared lib file can be 'lua_glfw.so' while the registered
name in lua can be 'glfw'. That will keep things cleaner.
</p>

<p>
Got lua_tfont.so loaded in demo/hello.lua, now just need to add font-drawing call
and resource file.
</p>

<p>
Almost working!
</p>

<pre>
mhackslab:demo $ lua hello.lua 
failed opening file: res/9x15_font.png
cwd: /Users/williamknight/swtools/lua/bin
load_image() failed: No such file or directory
mhackslab:demo $ 
</pre>

<p>
Hack hack hack.
Victory!
We have text displayed in demo/hello.lua
</p>

<p>
Even better, I am much more comfortable now with understanding and creating
the lua wrapper and C shared libraries that are needed.
</p>

<p>
Next:
</p>
<ul>
<li>fix cwd
<li>more docs, esp for font
<li>more demos
<li>make pong have paddles, physics
<li>finish edit module
</ul>

<p>
After work, a little more proggin. Investigating the cwd which requires
another sys and wrapper function, with a new return type, const char*.
</p>

<p>
Added it, but now, wtf is _crc32?:
</p>
<pre>
mhackslab:demo $ lua pwd.lua 
lua: error loading module 'lua_sys' from file './lua_sys.so':
        dlopen(./lua_sys.so, 2): Symbol not found: _crc32
  Referenced from: /Users/williamknight/proj/git/vblend/demo/util.so
  Expected in: dynamic lookup

stack traceback:
        [C]: ?
        [C]: in function 'require'
        pwd.lua:1: in main chunk
        [C]: ?
mhackslab:demo $ 
</pre>

<pre>
mhackslab:demo $ nm -A *.so | grep _crc32
util.so:single module:          U _crc32
mhackslab:demo $ 
</pre>

<p>
Somehow referencing zlib?
</p>
<pre>
mhackslab:demo $ find /usr/include | xargs grep -l crc32 2&gt;/dev/null
/usr/include/php/ext/hash/php_hash.h
/usr/include/php/ext/hash/php_hash_crc32.h
/usr/include/php/ext/standard/basic_functions.h
/usr/include/php/ext/standard/crc32.h
/usr/include/zconf.h
/usr/include/zlib.h
mhackslab:demo $ 
</pre>

<h2>2011-10-20</h2>

<p>
Thursday, 7:22 am. I slept 9 hours last night, which is great, but not a whole
lot of time before work. I will add zlib to the link line of util.so in an
attempt to fix the above problem.
</p>

<p>
Added it, don't get that error anymore, but now more probs:
</p>
<pre>
mhackslab:demo $ lua pwd.lua 
lua: error loading module 'lua_sys' from file './lua_sys.so':
        dlopen(./lua_sys.so, 2): Symbol not found: _glfwInit
  Referenced from: /Users/williamknight/proj/git/vblend/demo/util.so
  Expected in: dynamic lookup

stack traceback:
        [C]: ?
        [C]: in function 'require'
        pwd.lua:1: in main chunk
        [C]: ?
</pre>

<p>
So this is crap:
</p>
<pre>
mhackslab:demo $ nm -A *.so |grep _glfwInit
lua_glfw.so: 0000b004 D __glfwInitialized
lua_glfw.so: 00004910 T _glfwInit
util.so:single module:          U _glfwInit
mhackslab:demo $ 
</pre>

<p>
I guess I'm back to needing to understand in excruciating detail what the hell
is going on in dynamic lookup.
</p>

<p>
Did some googling, I need to read up on otool I think.
</p>

<h2>2011-10-20</h2>

<p>
Sweet Friday again. Readin a very nice book: "Mac OSX Internals - Complete".
Playing with my otool. This might be a problem:
</p>
<pre>
mhackslab:demo $ otool -L util.so
util.so:
        util.so (compatibility version 0.0.0, current version 0.0.0)
        /usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current version 1.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 111.1.7)
mhackslab:demo $ 
</pre>

<p>
The cyclical reference to itself doesn't look right.
</p>

<p>
Looking through the Makefiles, I wonder if the problem is because I'm statically linking glfw
with lua_glfw.so:
</p>
<pre>
lua_glfw.so: lua_glfw.o
  $(CC) $(CFLAGS) -bundle -undefined dynamic_lookup -o $@ $&lt; $(glfw_dir)/lib/libglfw.a -framework Cocoa -framework OpenGL
</pre>

<p>
I tried that. Previously, otool for lua_glfw.so looked like:
</p>
<pre>
mhackslab:demo $ otool -L lua_glfw.so
lua_glfw.so:
        /System/Library/Frameworks/Cocoa.framework/Versions/A/Cocoa (compatibility version 1.0.0, current version 12.0.0)
        /System/Library/Frameworks/OpenGL.framework/Versions/A/OpenGL (compatibility version 1.0.0, current version 1.0.0)
        /usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current version 1.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 111.1.7)
        /usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 227.0.0)
        /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 476.19.0)
        /System/Library/Frameworks/AppKit.framework/Versions/C/AppKit (compatibility version 45.0.0, current version 949.54.0)
        /System/Library/Frameworks/ApplicationServices.framework/Versions/A/ApplicationServices (compatibility version 1.0.0, current version 34.0.0)
        /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation (compatibility version 300.0.0, current version 677.26.0)
mhackslab:demo $ 
</pre>

<p>
Now it looks like:
</p>
<pre>
mhackslab:glfw $ otool -L lua_glfw.so
lua_glfw.so:
        @executable_path/libglfw.dylib (compatibility version 1.0.0, current version 1.0.0)
        /System/Library/Frameworks/Cocoa.framework/Versions/A/Cocoa (compatibility version 1.0.0, current version 12.0.0)
        /System/Library/Frameworks/OpenGL.framework/Versions/A/OpenGL (compatibility version 1.0.0, current version 1.0.0)
        /usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current version 1.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 111.1.7)
mhackslab:glfw $ 
</pre>

<p>
Tried that, now I'm getting:
</p>
<pre>
mhackslab:demo $ lua hello.lua 
lua: error loading module 'lua_glfw' from file './lua_glfw.so':
        dlopen(./lua_glfw.so, 2): Library not loaded: @executable_path/libglfw.dylib
  Referenced from: /Users/williamknight/proj/git/vblend/demo/lua_glfw.so
  Reason: image not found
stack traceback:
        [C]: ?
        [C]: in function 'require'
        ../gamelib/gamelib.lua:8: in main chunk
        [C]: in function 'require'
        hello.lua:7: in main chunk
        [C]: ?
mhackslab:demo $ ls libglfw.dylib
libglfw.dylib
mhackslab:demo $ 
</pre>

<p>
So what is the @executable_path? Probably something dumb like './appName?.app/Contents/MacOS/'
</p>

<p>
I vaguely remember using some other mac tool to specify the @executable_path for some
cross-platform desktop work I did last year. Not sure if that is really the problem though,
will keep reading.
</p>

<h2>2011-10-25</h2>

<p>
Spending some time on other stuff, like gamepad input device, so progress is slow. Read
some more this morning about mac osx shared libs and loading in Mac OSX internals book. Will
read a little more about otool now.
</p>

<p>
Well, I just fixed the pwd.lua problem by splitting out the sys.o code from the problematic
messy grab-bag of util.so and just built a sys.so. I'll just keep doing that with all
the other modules in the util dir and see if that makes things go more smoothly.
</p>

<p>
Still a problem here though:
</p>
<pre>
hackslab:demo $ lua hello.lua 
lua: error loading module 'lua_glfw' from file './lua_glfw.so':
dlopen(./lua_glfw.so, 2): Library not loaded: @executable_path/libglfw.dylib
  Referenced from: /Users/williamknight/proj/git/vblend/demo/lua_glfw.so
  Reason: image not found
stack traceback:
[C]: ?
[C]: in function 'require'
../gamelib/gamelib.lua:8: in main chunk
[C]: in function 'require'
hello.lua:7: in main chunk
[C]: ?
</pre>

<p>
Reading this: http://www.mikeash.com/pyblog/friday-qa-2009-11-06-linking-and-install-names.html
and this: http://www.dribin.org/dave/blog/archives/2009/11/15/rpath/
</p>

<p>
ftfa: "@executable_path will expand to /Applications/Bar.app/Contents/MacOS."
Yup, I thought it might be that appended crap.
</p>

<p>
damn mac shit:
</p>

<pre>
mhackslab:demo $ install_name_tool -change @executable_path/libglfw.dylib ./libglfw.dylib libglfw.dylib 
mhackslab:demo $ otool -D libglfw.dylib 
libglfw.dylib:
@executable_path/libglfw.dylib
mhackslab:demo $ 
</pre>

<p>
Read this: http://stackoverflow.com/questions/2985315/using-install-name-tool-whats-going-wrong
</p>

<p>
So next I do this:
</p>
<pre>
mhackslab:demo $ otool -L lua_glfw.so 
lua_glfw.so:
lua_glfw.so (compatibility version 0.0.0, current version 0.0.0)
@executable_path/libglfw.dylib (compatibility version 1.0.0, current version 1.0.0)
/System/Library/Frameworks/Cocoa.framework/Versions/A/Cocoa (compatibility version 1.0.0, current version 12.0.0)
/System/Library/Frameworks/OpenGL.framework/Versions/A/OpenGL (compatibility version 1.0.0, current version 1.0.0)
/usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current version 1.0.0)
/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 111.1.7)
mhackslab:demo $ install_name_tool -change @executable_path/libglfw.dylib ./libglfw.dylib lua_glfw.so
mhackslab:demo $ otool -L lua_glfw.so 
lua_glfw.so:
lua_glfw.so (compatibility version 0.0.0, current version 0.0.0)
./libglfw.dylib (compatibility version 1.0.0, current version 1.0.0)
/System/Library/Frameworks/Cocoa.framework/Versions/A/Cocoa (compatibility version 1.0.0, current version 12.0.0)
/System/Library/Frameworks/OpenGL.framework/Versions/A/OpenGL (compatibility version 1.0.0, current version 1.0.0)
/usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current version 1.0.0)
/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 111.1.7)
mhackslab:demo $ 
</pre>

<p>
Still busted:
</p>
<pre>
lua: attempt to index a nil value
stack traceback:
[C]: ?
[C]: in function 'require'
../gamelib/gamelib.lua:8: in main chunk
[C]: in function 'require'
hello.lua:7: in main chunk
[C]: ?
mhackslab:demo $ 
</pre>

<p>
Ok, rebuilt libglfw.dylib in the glfw dir after removing the 'install_name' DYLIBFLAG, fixed up
lua module name of glfw in glfw/lua_glfw_const_def.c and now pong demo runs again!
</p>

<p>
Now, back to the demos, need to create an img.so for tfont.so
</p>

<h2>2011-10-26</h2>

<p>
Rebuilt tfont lib to get rid of dependency on win.o, it gets the win height from gl viewport
call. 'hello.lua' demo works now. Things are looking good. Next, I want to complete the
cross-platform build process and improve the docs and maybe make the gamelib available
on a web page.
</p>

<p>
First thing, I will add subdirs for the glfw, libpng and zlib dependencies and makefiles 
to build them.
</p>

<h2>2011-10-27</h2>

<p>
Yesterday, got the zlb build working, now starting on glfw.
</p>

<p>
Built that no problem, next doing libpng, gah, it's very weird. Compiling with libtool? wtf?
</p>
<pre>
libtool: compile:  gcc -DHAVE_CONFIG_H -I. -DPNG_CONFIGURE_LIBPNG -g -O2 -MT libpng12_la-pngrtran.lo -MD -MP -MF .deps/libpng12_la-pngrtran.Tpo -c pngrtran.c  -fno-common -DPIC -o .libs/libpng12_la-pngrtran.o
libtool: compile:  gcc -DHAVE_CONFIG_H -I. -DPNG_CONFIGURE_LIBPNG -g -O2 -MT libpng12_la-pngrtran.lo -MD -MP -MF .deps/libpng12_la-pngrtran.Tpo -c pngrtran.c -o libpng12_la-pngrtran.o &gt;/dev/null 2&gt;&amp;1
mv -f .deps/libpng12_la-pngrtran.Tpo .deps/libpng12_la-pngrtran.Plo
/bin/sh ./libtool  --tag=CC   --mode=compile gcc -DHAVE_CONFIG_H -I.  -DPNG_CONFIGURE_LIBPNG    -g -O2 -MT libpng12_la-pngwtran.lo -MD -MP -MF .deps/libpng12_la-pngwtran.Tpo -c -o libpng12_la-pngwtran.lo `test -f 'pngwtran.c' || echo './'`pngwtran.c
libtool: compile:  gcc -DHAVE_CONFIG_H -I. -DPNG_CONFIGURE_LIBPNG -g -O2 -MT libpng12_la-pngwtran.lo -MD -MP -MF .deps/libpng
...
</pre>

<p>
This is the relevant link line, will work back from there:
</p>
<pre>
libtool: link: gcc -dynamiclib  -o .libs/libpng.3.dylib  .libs/libpng_la-png.o .libs/libpng_la-pngset.o .libs/libpng_la-pngget.o .libs/libpng_la-pngrutil.o .libs/libpng_la-pngtrans.o .libs/libpng_la-pngwutil.o .libs/libpng_la-pngread.o .libs/libpng_la-pngrio.o .libs/libpng_la-pngwio.o .libs/libpng_la-pngwrite.o .libs/libpng_la-pngrtran.o .libs/libpng_la-pngwtran.o .libs/libpng_la-pngmem.o .libs/libpng_la-pngerror.o .libs/libpng_la-pngpread.o   -lz    -install_name  /Users/williamknight/swtools/graphics/libpng/lib/libpng.3.dylib -compatibility_version 45 -current_version 45.0 -Wl,-single_module
</pre>

<p>
There are 2 different lines that create first obj file above, 'libpng_la-png.o':
</p>
<pre>
libtool: compile:  gcc -DHAVE_CONFIG_H -I. -DPNG_CONFIGURE_LIBPNG -g -O2 -MT libpng_la-png.lo -MD -MP -MF .deps/libpng_la-png.Tpo -c png.c  -fno-common -DPIC -o .libs/libpng_la-png.o
libtool: compile:  gcc -DHAVE_CONFIG_H -I. -DPNG_CONFIGURE_LIBPNG -g -O2 -MT libpng_la-png.lo -MD -MP -MF .deps/libpng_la-png.Tpo -c png.c -o libpng_la-png.o &gt;/dev/null 2&gt;&amp;1
</pre>

<p>
Ah, no, only the first one is used in creating the dylib, the second one is used in creating the static lib.
</p>

<p>
Now I just need to understand the purpose of '-MT libpng_la-png.lo'. Docs say '-MT' means 'add unquoted target',
wtf does that mean? Is it just for dependencies? I don't care about that.
</p>

<pre>
mhackslab:libpng-1.2.41 $ cat libpng_la-png.lo 
# libpng_la-png.lo - a libtool object file
# Generated by ltmain.sh (GNU libtool) 2.2.6b
#
# Please DO NOT delete this file!
# It is necessary for linking the library.

# Name of the PIC object.
pic_object='.libs/libpng_la-png.o'

# Name of the non-PIC object
non_pic_object='libpng_la-png.o'

mhackslab:libpng-1.2.41 $ 
</pre>

<p>
I will just try building without these kind of files for now, I think they are just used for
platform-independent building of shared libs and I will be explicitly creating 'Makefile', 'Makefile.osx'
and 'Makefile.ming' files to handle that instead.
</p>

<p>
Ok, built libpng, got it all working, moved stuff to demo dir. It's coming together, need to
implement recursive make and move lua into project tree so everything will be fully self-contained
(except for opengl).
</p>

<p>
Home after a long day, just a few minutes before dinner, starting on recursive makes.
</p>

<p>
Finished recursive make after dinner, it works. Next, just need to move lua in there
then I'll start on the mingw makefiles.
</p>

<p>
Moved in lua, tomorrow will start on mingw.
</p>

<h2>2011-10-28</h2>

<p>
Sweet Friday, working on Windows XP on my old thinkpad, but with nice big external
flat screen monitor and keyboard, it's almost as good as working on linux or my macbook
now, which use same monitor and keyboard. Anyhow, I'm ready to start generating mingw
makefiles from the Makefile.osx files.
</p>

<p>
Bleh, had to log out and into admin just to turn off the damn speaker beep, now to work.
</p>

<p>
Weird, there are some strange diffs with the version of lua I just built on win xp/mingw,
might be because of the luaconf.h file I used from Mac OSX, here is what it's doing:
</p>
<pre>
&gt; print(math.huge)
1.#INF
&gt; buf=io.read(math.huge)
&gt; print(#buf)
0
</pre>

<p>
Hmm, does the same thing with the pre-built version of lua too, well guess that's good.
I'll just deal.
</p>

<h2>2011-10-29</h2>

<p>
Saturday morning. Wasn't able to check in the work I did yesterday on this thinkpad
because I had cloned the git repository on my macbook, which wasn't a bare repository.
This morning, I did a clone instead from the missoulagamedev repository on modwest.
Next, I'll do a test push to make sure I can upload the work.
</p>

<p>
Good, worked liked I expected. On with it.
</p>

<p>
Hmm, lua string.gsub() is _NOT_ working at all how I expected it to:
</p>
<pre>
&gt; print(repl)
bf
&gt; print(buf)
        $(CC) -o $@ -dynamiclib -undefined dynamic_lookup $&lt; -framework Cocoa -framework OpenGL

&gt; pat='-dynamiclib -u'
&gt; s = string.gsub(buf,pat,repl)
&gt; print(s)
        $(CC) -o $@ -dynamiclib -undefined dynamic_lookup $&lt; -framework Cocoa -framework OpenGL

&gt; pat='-dynamiclib -'
&gt; s = string.gsub(buf,pat,repl)
&gt; print(s)
        $(CC) -o $@ bf -undefined dynamic_lookup $&lt; -framework Cocoa -framework OpenGL

&gt;
</pre>

<p>
It's not specific to gsub, it's something with the lua pattern matching:
</p>
<pre>
&gt; pat='-dynamiclib -'
&gt; n = string.find(buf, pat)
&gt; print(n)
14
&gt; pat='-dynamiclib -u'
&gt; n = string.find(buf, pat)
&gt; print(n)
nil
&gt; print(buf)
        $(CC) -o $@ -dynamiclib -undefined dynamic_lookup $&lt; -framework Cocoa -framework OpenGL

&gt;
</pre>

<p>
First thing I will do is test this on mac to see if there's more weirdness
with lua on mingw.
</p>

<p>
Tried it, then reviewed lua patterns, duh, I forgot that '-' is magic!
</p>

<h2>2011-10-30</h2>

<p>
Ran in to a linking problem yesterday building glfw:
</p>
<pre>
C:\Documents and Settings\strangecell\proj\vblend\glfw\libglfw&gt;make -f Makefile.mingw
dllwrap --dllname libglfw.dll --def glfwdll_mgw1.def enable_dll.o fullscreen_dll.o glext_dll.o image_dll.o init_dll.o
 stream_dll.o tga_dll.o thread_dll.o time_dll.o window_dll.o win32_dllmain_dll.o win32_enable_dll.o win32_fullscreen_
 32_init_dll.o win32_joystick_dll.o win32_thread_dll.o win32_time_dll.o win32_window_dll.o -s -lopengl32 -lwinmm -lgdi
 win32_window_dll.o:win32_window.c:(.text+0x19ab): undefined reference to `_glfwRefreshContextParams'
 collect2: ld returned 1 exit status
 C:\home\willkn\swtools\mingw\bin\dllwrap.exe: C:\home\willkn\swtools\mingw\bin\gcc exited with status 1
 make: *** [libglfw.dll] Error 1

 C:\Documents and Settings\strangecell\proj\vblend\glfw\libglfw&gt;
</pre>

<p>
Before investigating, need to cleanup to free some disk space.
</p>

<p>
Did that, next, built ref version of glfw on mingw, no probs. I'm thinking
my version fails because I removed the static lib build, comparing the
two different make outputs.
</p>

<p>
Comparing them, I now think there must be something different in the
includes for compiling win32_window.c, because the ref build doesn't
give the warning about glfwRefreshContextParams.
</p>

<p>
Next, will probably compare preprocessed files of that c file.
</p>

<p>
Ok, believe that I tracked it down, the diff is in glfw/lib/internal.h,
the glfw-2.7.2 version on my xp thinkpad has the missing _glfwRefreshContextParams()
declaration and the reason is because the version of glfw on my macbook
is different! It's glfw-2.7! DUH!!
</p>

<h2>2011-10-31</h2>

<p>
Trying to pull changes from modwest git repo after push from thinkpad, I ran
into this err msg:
</p>

<p>
Starting reading some more git pro book and after a bit, I just followed the
instructions and did this:
</p>
<pre>
mhackslab:vblend $ git pull
remote: Counting objects: 25, done.
remote: Compressing objects: 100% (14/14), done.
remote: Total 14 (delta 9), reused 0 (delta 0)
Unpacking objects: 100% (14/14), done.
From shell.modwest.com:git/vblend
   c2963e7..3ef05a2  master     -&gt; origin/master
 You asked me to pull without telling me which branch you
 want to merge with, and 'branch.master.merge' in
 your configuration file does not tell me, either. Please
 specify which branch you want to use on the command line and
 try again (e.g. 'git pull &lt;repository&gt; &lt;refspec&gt;').
 See git-pull(1) for details.

 If you often merge with the same branch, you may want to
 use something like the following in your configuration file:

     [branch "master"]
     remote = &lt;nickname&gt;
     merge = &lt;remote-ref&gt;

     [remote "&lt;nickname&gt;"]
     url = &lt;url&gt;
     fetch = &lt;refspec&gt;

 See git-config(1) for details.
 mhackslab:vblend $ git branch
</pre>

<pre>
mhackslab:vblend $ git pull ssh://mmmmhack@shell.modwest.com/git/vblend
From ssh://shell.modwest.com/git/vblend
 * branch            HEAD       -&gt; FETCH_HEAD
 Updating 7c92b6e..3ef05a2
 Fast-forward
 .gitignore                |   10 ++
 Makefile.osx              |   27 +++--
 devlog-wknight.html       |  137 ++++++++++++++++++++++++
 gl/Makefile.mingw         |   47 +++++----
 gl/Makefile.osx           |   13 ++-
 glfw/Makefile.mingw       |   51 ++++++----
 glfw/Makefile.osx         |   22 +---
 glfw/libglfw/Makefile.osx |   57 ++--------
 glfw/libglfw/internal.h   |   10 ++-
 glfw/libglfw/platform.h   |  253 ---------------------------------------------
 10 files changed, 253 insertions(+), 374 deletions(-)
 delete mode 100644 glfw/libglfw/platform.h
 mhackslab:vblend $ 
</pre>

<p>
So next, will build again on macbook with new version, test, checkin changes
and later resume work on win32.
</p>

<h2>2011-11-01</h2>

<p>
Back on macbook, getting libglfw to build here. Still re-organizing the the
cocoa, win32 and x11 files.
</p>

<p>
Built, tested, pong works. Back to win32.
</p>

<p>
Got glfw-2.7.2 files syncd up, it builds. Moving on to next Makefile.
</p>

<p>
Working on building util, now I'm back to real porting issues, timespec
isn't declared.
</p>

<p>
Ah, duh, that's the later, more precise struct, I only need timeval
for now, will just handle with ifdefs.
</p>

<p>
Did it, it works. On to the next one, zlib, need to get the multi-platform
version off of macbook, so back to checkin and switch-over and then must
go to work.
</p>

<h2>2011-11-02</h2>

<p>
Up early Tuesday morning, lots of time to work, back on mingw trying to
build zlib.
</p>

<p>
Learning good and interesting about C-runtime libs on win32 by reading 
the zlib DLL_FAQ.
</p>

<p>
Just had to make a few minor mods to the zlib win32/Makefile.gcc file,
it works.
</p>

<p>
Now starting on libpng.
</p>

<p>
libpng done, haven't tested it, will test in gamelib app. Moving
on to img Makefile.mingw
</p>

<p>
img done, now moving on to final subdir font.
</p>

<p>
tfont done, now for the final kahuna.
</p>

<p>
Did it, victory!
</p>

<p>
Back on macbook, adding missing demo/res dir.
</p>

<p>
Back on mingw, both pong and hello demos work.
</p>

<h2>2011-11-03</h2>

<p>
Back on macbook, starting on joystick inputs. First, I want to create
new glfw text docs from the glfw-2.7.2 src. They are in LaTex format,
should be a simple way to convert to text I'm hoping...
</p>

<p>
Downloading Ian Hutchison's TtH and checking it out. Once in html, think
I have a good html2ascii converter.. html2markdown I believe...
</p>

<p>
Looked at it, pretty incomprensible lex-generated C code, compiled it, tried it out on 
glfw ref manual, works great! Now converting to ascii with html2markdown...
</p>

<p>
Crap, that's failing, not sure if I'm using the right version.
</p>

<p>
Cool, after running the 2.39 version and also seeing it fail on 0xad bytes,
I just deleted those in vim and it completed.
</p>

<p>
Looks good, next, trying to get a good markdown syntax file in vim that works
with it, tried plasticboy mkd.vim but didn't work right. I just need to learn
vim syntax creation myself soon.
</p>

<p>
Working on show_js_params.lua in test/joystick directory, ran into a new
problem where all the shared libs can't load, even after setting package.cpath,
because they all are referenced in 'current directory'. Will think about a
solution but for now, will just develop test apps in the dist dir.
</p>

<p>
Lovely, looks like the joystick isn't being detected on my macbook. I _really_
hope this is fixable, after all the trouble I went to to develop this cross-platform
gamelib.
</p>

<p>
Google time, there is a shareware usb driver, usb overdrive, that will probably
work but I want an opensource solution.
</p>

<p>
There is this, at the very least: http://xhd.sourceforge.net/
</p>

<h2>2011-11-04</h2>

<p>
Another fine Friday has come around. Continuing on the paddle demo, which I'll
use to update the current pong demo into an actual game. Might start investigating
sound at some point, which might turn out to be easier than getting the joystick
to work at this point (tried detecting the Logitech game pad in win32, no luck there
either, even though the OS recognized it).
</p>

<p>
Adding code to produce 60 fps in paddle.lua. On mingw, there is no nanosleep, but
there is usleep (in unistd.h). Hmm, there is usleep on mac as well, wonder why it's
not mentioned in the gnu libc.txt docs. Will check on gnu/linux.
</p>

<p>
It's got it there, that's what I'll use.
</p>

<p>
Running into annoying lua path issues again, think I might start setting an
env var for development.
</p>

<p>
Added sys.usleep(), used it in paddle.lua, it now has 60 fps rate.
</p>

<p>
renamed paddle.lua to pong.lua, adding ball
</p>

<h2>2011-11-05</h2>

<p>
A lovely Saturday, good night's sleep, good coffee, I set to work on implementing
the pong ball-paddle intersect code. It should be so simple, and yet for me,
it is complicated and takes me a long time. I get the initial implementation done
but there are bugs. I will create some unit tests to shake it out.
</p>

<p>
Later at home, after good programming sesh with Sam. Would like to get the collision
detection working, wrote a couple of unit tests so far, will write a few more
before just cracking out the debugger.
</p>

<h2>2011-11-06</h2>

<p>
Sunday, up way too early, but there it is. Added some more unit tests to the collision
functions but no joy yet. Now, will just output some info on the collisions
</p>

<p>
Did it, will plug these values into a unit test case:
</p>
<pre>
mhackslab:dist $ r
paddle geom: 600, 400, 40, 100
ball geom: 620, 520, 30, 30
--- ball edge intersects:
  x1: 0, x2: 1

  y1: 1, y2: 1
</pre>

<p>
Ok, that did it, just needed a simple fix to geom.get_edge_intersects(), I was
interpreting boundary intersections as value 1 when they are actually value 0.
The ball-paddle collisions now work, but still not good enough for real game
play. Simple mirror-rebound doesn't give good action off paddle, the angle
needs to vary depending on collision position along paddle. But that is
something Sam and I can work on together.
</p>

<p>
Now, maybe I'll start investigating sound libs.
</p>

<p>
Read the pyglet docs, will checkout openal.
</p>

<p>
Uh, maybe openal soft, I've been down this road before, openal is a creative labs
product and open source status and availability is dubious.
</p>

<p>
Initial attempt at building older version of openal-soft fails:
</p>
<pre>
...
[ 90%] Building C object CMakeFiles/openal.dir/Alc/bs2b.o
[ 95%] Building C object CMakeFiles/openal.dir/Alc/wave.o
Linking C shared library libopenal.dylib
ld: malformed version number: 1.12.854
collect2: ld returned 1 exit status
make[2]: *** [libopenal.1.12.854.dylib] Error 1
make[1]: *** [CMakeFiles/openal.dir/all] Error 2
make: *** [all] Error 2
mhackslab:build $ 
</pre>

<p>
Next, will try version 1.13.
</p>

<p>
Yay:
</p>
<pre>
...
Linking C shared library libopenal.dylib
[ 96%] Built target openal
Scanning dependencies of target openal-info
[100%] Building C object CMakeFiles/openal-info.dir/utils/openal-info.o
/Users/williamknight/swtools/audio/openal-soft/openal-soft-1.13/utils/openal-info.c: In function ‘main’:
/Users/williamknight/swtools/audio/openal-soft/openal-soft-1.13/utils/openal-info.c:332: warning: internal and protected visibility attributes not supported in this configuration; ignored
Linking C executable openal-info
[100%] Built target openal-info
mhackslab:build $ 
</pre>

<h2>2011-11-19</h2>

<p>
Long hiatus, much going on. Been working on some test openal projects on macbook recently,
but no sound is coming out. Will perhaps start on some 3D stuff today for demo for Sam.
Would be nice to quickly whip out some 3D matrix libs in C and lua.
</p>

<p>
Looking here: http://lua-users.org/wiki/LibrariesAndBindinga. Will checkout luamatrix.
</p>

<h2>2011-11-21</h2>

<p>
Got openal working on make by skipping openal-soft and linking with openal framework instead.
Not ideal, but it's progress.
</p>

<h2>2011-11-22</h2>

<p>
Up early, at 5 am. But I have to get to work earlier now too. Getting started on audio
stuff.
</p>

<p>
Wrote test prog 'enumdevices', tried it with both openal-soft and openalframework, this
is enlightening:
</p>
<pre>
mhackslab:enumdevices $ ./enumdevices 
devices:
  [No Output]
mhackslab:enumdevices $ m clean
rm enumdevices *.o
mhackslab:enumdevices $ m
cc -o main.o  -I/Users/williamknight/swtools/audio/openal-soft/include -I/Users/williamknight/swtools/audio/freealut/include -c main.c
cc -o enumdevices main.o -framework openal
mhackslab:enumdevices $ ./enumdevices 
devices:
  [Built-in Output]
mhackslab:enumdevices $ 
</pre>

<p>
No, I decided instead to look at the cbots vector, matrix and transformer code. Think
I'll create lua vector3 and matrix3 classes and a camera class.
</p>

<p>
Or maybe for now, will just use gluLookAt().
</p>

<h2>2011-11-28</h2>

<p>
Yesterday, while debugging grid3d.lua, I finally added the 'step' command to the debugger.
Now, I'm going to add the 'next' commmand.
</p>

<p>
Added it, it works! I finally have a real lua debugger now, and one that I created myself.
</p>

<h2>2011-11-29</h2>

<p>
Up early this morning, wasting much time reading politics. Finished reading Chap 4 discussion 
of frame rotation in GTCG. Now, I want to implement a simple matrix rotation function in
vector3f.lua.
</p>

<h2>2011-11-30</h2>

<p>
Continuing implementation of vector and matrix code to get rotation.
</p>

<p>
Finished, looks like it works:
</p>
<pre>
mhackslab:test $ lua test_rot_marix.lua 
--- create rotation matrix
enter a rotation vector [1 0 0]: 0 1 0
enter a rotation angle in degrees [90]: 
creating a matrix with rotation of 90 degrees about vector 0.000000, 1.000000, 0.000000
   0.0000    0.0000   -1.0000
   0.0000    1.0000    0.0000
   1.0000    0.0000    0.0000

--- test the matrix
enter a test vector to be rotated [0 0 1]: 
result vector: 1.000000, 0.000000, 0.000000
mhackslab:test $ 
</pre>

<p>
Rotation is working in grid3d.lua!
</p>

<h2>2011-12-01</h2>

<p>
Today I want to start on creating a full input transform capability for navigating
and manipulating in 3D space. I already have C code for a transformer class, as a
reference (from the cbots project).
</p>

<p>
Created the gamelib/camera.lua module. After looking for a bit at the transformer
code in omd, I came up with a simpler approach.
</p>

<p>
After this second reading of chaps 3 and 4 in GTCG, I can now visualize rotations
of the coordinate axes in my head in a way that allows me to define the 3x3 rotation
matrices for the x, y and z rotations without having to look them up in a book.
That's kind of satisfying.
</p>

<p>
At first, I considered using a matrix to hold the camera rotation, but then, thinking
about how to avoid accumulated errors in matrix operations, I tried to think of
a way to implement camera rotations where the camera orientation is defined only
in terms of a look dir and up dir (so I can just call gluLookAt()) and came up
with this nice scheme (which I believe is self-correcting with respect to matrix
multiplication errors):
</p>
<pre>
if M.state['rot_x'] ~= 0 then
local theta = M.state['rot_x'] * M.rot_rate * dt
local vrot = vector3.cross(M.look_dir, M.up_dir)
local Mr = geom.create_rot_matrix(vrot, theta)
M.look_dir = vector3.mul(M.look_dir, Mr)
M.up_dir = vector3.cross(vrot, M.look_dir)
end
</pre>

<p>
The rot_y and rot_z are simpler of course because these are just 
rotations around the up dir and look dir respectively.
</p>

<p>
I'm sure this must be a common implementation of camera rotation that I've
stumbled upon independently.
</p>

<p>
Next, walking to work, I'm thinking about what key bindings to create for
3D navigation. After considering some more conventional approaches like
the aswd and jhkl bindings, I decided on trying an approach that mimics
the 'move/look' approach of a gamepad controller with 2 joysticks that
I'll also support at some point. Here is what I will try first:
</p>
<ul>
<li>- trans_x : f
<li>+ trans_x : g
<li>- trans_z : e
<li>+ trans_z : d
<li>+ rot_y   : h
<li>- rot_y   : j
<li>+ rot_x   : i
<li>- rot_x   : k
</ul>

<p>
Advantages of this approach:
</p>
<ul>
<li>move and look are symmetrical
<li>both axes can be hit simultaneously
<li>shift/ctrl/alt keys can be hit simultaneously with axis keys
</ul>

<p>
After work, on the bus. Starting on cam_control module.
</p>

<h2>2011-12-02</h2>

<p>
Friday morning, ho yeah. Worked a little more on the cam_control and
camera last night, it's almost working, testing in gridcam3d.lua.
Just need to transform world input trans to camera frame.
</p>

<p>
Got it working, sweet. Just need to add projection of tilted camera
frame to world x-z plane for translation and y-rotation.
</p>

<p>
On bus, adjusted translation with projection of look_dir onto xz plane.
next: adust for x rotation.
</p>

<p>
Adjusted it, camera is working.
</p>

<h2>2011-12-05</h2>

<p>
Monday morning. I need to get the editor working so I can start on 3D
model tools.
</p>

<p>
I created the documentation for the font module in docsrc/font.txt
</p>

<p>
Next, revamping the edit module to create a lua_edit wrapper for it,
after modifying the font shell and lua scripts, running into a 'return
pointer param' not handled situation again. I know that I've dealt
with this before, need to create a freakin wiki to hold my memories.
</p>

<p>
Will do that later thought, for now I see I put the info in the help
for the parser script:
</p>
<pre>
 -r, --ret-params RET_PARAMS_FILE   identify returned values in function params from '[func_name,param_name]=lua_type' table entries in lua file RET_PARAMS_FILE
</pre>

<p>
But I never used it?
</p>
<pre>
mhackslab:edit $ find .. -name '*.sh' | xargs grep "ret-param"
mhackslab:edit $ 
</pre>

<p>
Yeah I did:
</p>
<pre>
mhackslab:edit $ find .. -name '*.sh' | xargs grep "\-r"
../glfw/gen_wrappers.sh:lua ../parse/gen_wrappers.lua -p glfw -r lua_glfw_ret_params.lua $@ glfw.i
mhackslab:edit $ 
</pre>

<p>
Got the lua_edit module working.
</p>

<p>
Next, looking over the old tf_edit.lua code (now moved to demo/edit), the main question is
whether to add support for key events to the game lib or just do the polling myself. If
that's all the glfw lib does currently, might just add the polling for now.
</p>

<p>
No, looking at the code, it gets key events from the OS, so guess I'll add support
for key events to the gamelib.
</p>

<p>
The glfw function glfwSetKeyCallback() isn't currently wrapped and it takes a 
function ptr param, so won't be simple to support that in the gen_wrappers scripts.
I'll just add yet-another-param to the parse/gen_wrapper.lua script to import
custom wrapper function code.
</p>

<p>
Sent out first homework assignment for Sam. While walking to work, more thought
on the edit program. Also thinking about defining a 3D cursor with graphical
editing capabilities, in parallel with the text editor. Started work on the 'include_map'
param in the parse/gen_wrappers.lua script.
</p>

<p>
After work, on bus, --include-map is almost working.
</p>

<p>
At home, after dinner, finished initial implementation of glfw.setKeyCallback().
Currently it's crashing, will have to debug in gdb.
</p>

<h2>2011-12-06</h2>

<p>
Tuesday morning after a loong night's sleep, not a whole lot of time for programming
before work, but I'm hopeful I can make a good start on debugging the callback function.
Need some kind of template debug C file, and a wiki!
</p>

<p>
Found 'debug_wrapper.c' in glfw, copying to debugger dir.
</p>

<p>
Got the debug app working.
</p>

<p>
Ok, see the problem right away:
</p>
<pre>
Breakpoint 1, lw_setKeyCallback (L=0x1096d0) at lua_setKeyCallback.c:22
22  const char* cb_name = lua_tostring(L, -1);
(gdb) w
Ambiguous command "w": watch, whatis, where, while, while-stepping, ws.
(gdb) bt
#0  lw_setKeyCallback (L=0x1096d0) at lua_setKeyCallback.c:22
#1  0x000091fd in luaD_precall (L=0x1096d0, func=0x825a54, nresults=0) at ldo.c:319
#2  0x0001814f in luaV_execute (L=0x1096d0, nexeccalls=1) at lvm.c:587
#3  0x00009473 in luaD_call (L=0x1096d0, func=0x802618, nResults=0) at ldo.c:377
#4  0x00003b33 in f_call (L=0x1096d0, ud=0xbffff5bc) at lapi.c:800
#5  0x000086ca in luaD_rawrunprotected (L=0x1096d0, f=0x3b09 &lt;f_call&gt;, ud=0xbffff5bc) at ldo.c:116
#6  0x00009806 in luaD_pcall (L=0x1096d0, func=0x3b09 &lt;f_call&gt;, u=0xbffff5bc, old_top=24, ef=0) at ldo.c:463
#7  0x00003bd0 in lua_pcall (L=0x1096d0, nargs=0, nresults=0, errfunc=0) at lapi.c:821
#8  0x00001f9e in main (argc=1, argv=0xbffff644) at debug_wrapper.c:36
(gdb) n
23strncpy(lua_keyCallbackFuncName, cb_name, sizeof(cb_name));
(gdb) p  cb_name
$1 = 0x0
(gdb) 
</pre>

<p>
Duh, it's kinda what I figured, I'm passing the param as a function and expecting to
convert to a string:
</p>
<pre>
--- debug_wrapper.lua:
...
print("BEF setKeyCallback()")
glfw.setKeyCallback(key_cb)
print("AFT setKeyCallback()")
...
---lw_setKeyCallback.c:
static int lw_setKeyCallback(lua_State* L) {
  const char* cb_name = lua_tostring(L, -1);
strncpy(lua_keyCallbackFuncName, cb_name, sizeof(cb_name));
LL = L;
  glfwSetKeyCallback(
keyCallback
  );
  return 0;
}
</pre>

<p>
Changed param to string, tried again, now it gets into the C
callback function but getglobal on the lua cb function isn't
working:
</p>
<pre>
mhackslab:dist $ ./debug_wrapper 
BEG debug_wrapper.c main()
BEG debug_wrapper.lua main()
BEF glfw.init()
rc: 1
AFT glfw.init()
BEF open_window()
AFT open_window()
win w: [800], win h: [600]
BEF setKeyCallback()
AFT setKeyCallback()
failed calling lua keydown handler: attempt to call a nil value
keyCallback: No such file or directory
mhackslab:dist $ 
</pre>

<p>
Next, will probably need to add some lua stack dumps, but now
gotta get going.
</p>

<p>
Little more time, debugging the getglobal, the name is wrong!
</p>
<pre>
Breakpoint 1, keyCallback (key=74, action=1) at lua_setKeyCallback.c:10
10lua_getglobal(LL, lua_keyCallbackFuncName);
(gdb) p lua_keyCallbackFuncName
$1 = "key_", '\0' &lt;repeats 251 times&gt;
(gdb) 
</pre>

<p>
Duh, found it, I don't know how to give the freaking correct size arg
to strlen!!!
</p>
<pre>
Breakpoint 1, lw_setKeyCallback (L=0x1096d0) at lua_setKeyCallback.c:23
23strncpy(lua_keyCallbackFuncName, cb_name, sizeof(cb_name));
(gdb) p cb_name
$1 = 0x10f9f0 "key_cb"
(gdb) p lua_keyCallbackFuncName
$2 = '\0' &lt;repeats 255 times&gt;
(gdb) n
24LL = L;
(gdb) p lua_keyCallbackFuncName
$3 = "key_", '\0' &lt;repeats 251 times&gt;
(gdb) p sizeof(cb_name)
$4 = 4
(gdb) 
</pre>

<p>
(Should have been sizeof(lua_keyCallbackFuncName) dumbkopf!)
</p>

<p>
Victory!
</p>

<h2>2011-12-07</h2>

<p>
Resuming work on the editor app. Finally got around to making
a Makefile in the dist directory to update it with changed source files
instead of doing manual copy. It's so easy, why didn't I do it a 
long time ago?
</p>

<p>
On the bus, debugging glfw.setKeyCallback() after I added it to the
editor.lua app. The callback isn't getting called and I don't understand
why. Hmm, maybe because I need to link all the lua libs to the debug_wrapper
exe instead of dyn_load? No, that doesn't make sense, the breakpoint at
lua_setKeyCallback.c:22 gets hit, just not the one at lua_setKeyCallback.c:8
(the C callback function).
</p>

<p>
Aha! Stepping into glfwSetKeyCallback() may have just revealed the answer!
I was calling it before glfwOpenWindow()!
</p>

<p>
That was it!
</p>

<p>
Got editor line display and cursor movement working again!
</p>

<h2>2011-12-08</h2>

<p>
Wow, Thursday already. Yesterday on the way to work, thought a little more
about text windows and also the need for multiple graphics windows for
front, side and top views. I think that can be done with a single opengl
context just using different calls to glViewport? Will need to read up
on that.
</p>

<p>
However, for now, I just might want to try to make progress using a 
single text and graphics window, just so that I can start doing some
simple 3D modeling.
</p>

<p>
So, will continue working on the editor app for now, to get it to work
as a full-screen single-window app.
</p>

<p>
Will setup the vblend wiki while looking at and thinking about the
editor code.
</p>

<p>
Got the wiki setup without too much trouble, the logo took the most
time.
</p>

<p>
Created 'Editor' page in wiki.
</p>

<h2>2011-12-09</h2>

<p>
It's Friday again! Would like to continue working on the editor, I will
for a bit but must also put some time into the robot_war demo.
</p

<p>
Added more stuff to editor wiki page.
</p>

<p>
Did a tiny bit bit of work on cursor movement in editor.
</p>

<p>
Did a tiny bit of work on robot_war.
</p>

<h2>2011-12-11</h2>

<p>
Back to work on editor app, think I'll add a trace option to the lua debugger.
</p>

<p>
Added it, it works! 
</p>

<p>
Hmm, no, not quite, it's reporting wrong source file at times.
</p>

<p>
Also getting crash:
</p>
<pre>
breakpoint hit!
 1 [./normal_mode.lua:71] (char_pressed)
 &gt; t
 instruction tracing is ON, appending to trace.log
 &gt; c
 continuing program execution

 Program received signal EXC_BAD_ACCESS, Could not access memory.
 Reason: KERN_PROTECTION_FAILURE at address: 0x00000006
 0x000069f0 in lua_getstack (L=0x1096d0, level=0, ar=0xbfffdea4) at ldebug.c:90
 90    if (f_isLua(ci))  /* Lua function? */
 (gdb) bt
 #0  0x000069f0 in lua_getstack (L=0x1096d0, level=0, ar=0xbfffdea4) at ldebug.c:90
 #1  0x0001c816 in db_getinfo (L=0x1096d0) at ldblib.c:104
 #2  0x000091fd in luaD_precall (L=0x1096d0, func=0x8c1a64, nresults=1) at ldo.c:319
 #3  0x0001814f in luaV_execute (L=0x1096d0, nexeccalls=2) at lvm.c:587
 #4  0x00009473 in luaD_call (L=0x1096d0, func=0x8c19b0, nResults=0) at ldo.c:377
 #5  0x00003adf in lua_call (L=0x1096d0, nargs=2, nresults=0) at lapi.c:782
 #6  0x0001cf3e in hookf (L=0x1096d0, ar=0xbfffe330) at ldblib.c:219
 #7  0x00008b0d in luaD_callhook (L=0x1096d0, event=2, line=155) at ldo.c:198
 #8  0x00015217 in traceexec (L=0x1096d0, pc=0x111794) at lvm.c:75
 #9  0x000164e8 in luaV_execute (L=0x1096d0, nexeccalls=1) at lvm.c:390
 #10 0x00009473 in luaD_call (L=0x1096d0, func=0x8c195c, nResults=0) at ldo.c:377
 #11 0x00003b33 in f_call (L=0x1096d0, ud=0xbfffe85c) at lapi.c:800
 #12 0x000086ca in luaD_rawrunprotected (L=0x1096d0, f=0x3b09 &lt;f_call&gt;, ud=0xbfffe85c) at ldo.c:116
 #13 0x00009806 in luaD_pcall (L=0x1096d0, func=0x3b09 &lt;f_call&gt;, u=0xbfffe85c, old_top=348, ef=0) at ldo.c:463
 #14 0x00003bd0 in lua_pcall (L=0x1096d0, nargs=2, nresults=0, errfunc=0) at lapi.c:821
 #15 0x00041d3e in keyCallback (key=323, action=1) at lua_setKeyCallback.c:13
 #16 0x9139e731 in -[NSWindow sendEvent:] ()
 #17 0x9136a6a5 in -[NSApplication sendEvent:] ()
 #18 0x0004ba57 in -[GLFWApplication sendEvent:] (self=0x1410f0, _cmd=0x952cf4b8, event=0x1362e0) at cocoa/cocoa_init.m:62
 #19 0x0004df2e in _glfwPlatformPollEvents () at cocoa/cocoa_window.m:847
 #20 0x00041ace in lw_swapBuffers (L=0x1096d0) at lua_glfw_func_def.c:99
 #21 0x000091fd in luaD_precall (L=0x1096d0, func=0x8c1968, nresults=0) at ldo.c:319
 #22 0x0001814f in luaV_execute (L=0x1096d0, nexeccalls=3) at lvm.c:587
 #23 0x00009473 in luaD_call (L=0x1096d0, func=0x80266c, nResults=1) at ldo.c:377
 #24 0x00003adf in lua_call (L=0x1096d0, nargs=1, nresults=1) at lapi.c:782
 #25 0x000249be in ll_require (L=0x1096d0) at loadlib.c:484
 #26 0x000091fd in luaD_precall (L=0x1096d0, func=0x802624, nresults=0) at ldo.c:319
 #27 0x0001814f in luaV_execute (L=0x1096d0, nexeccalls=1) at lvm.c:587
 #28 0x00009473 in luaD_call (L=0x1096d0, func=0x802618, nResults=-1) at ldo.c:377
 #29 0x00003b33 in f_call (L=0x1096d0, ud=0xbffff5bc) at lapi.c:800
 #30 0x000086ca in luaD_rawrunprotected (L=0x1096d0, f=0x3b09 &lt;f_call&gt;, ud=0xbffff5bc) at ldo.c:116
 #31 0x00009806 in luaD_pcall (L=0x1096d0, func=0x3b09 &lt;f_call&gt;, u=0xbffff5bc, old_top=24, ef=0) at ldo.c:463
 #32 0x00003bd0 in lua_pcall (L=0x1096d0, nargs=0, nresults=-1, errfunc=0) at lapi.c:821
 #33 0x00001ebb in main (argc=1, argv=0xbffff644) at debug_wrapper.c:27
 (gdb) 
</pre>

<p>
Maybe stack size exceeded, will add checks for that.
</p>

<p>
Don't see a programmatic way to increase the C lua stack size with the current
approach (running lua scripts using lua exe instead of C code, so I can't call lua_checkstack(L, extra))
but since lua is built in the project itself, I can just increase the defined value of LUA_MINSTACK
which is only 20 and seems clearly way to small from the stack trace above.
</p>

<p>
I increased to 200, rebuilt everything, tried again, crashes in the same way, so maybe has nothing
to do with stack size?
</p>

<h2>2011-12-12</h2>

<p>
I must understand Lua internals.
</p>

<p>
Started documenting the lua source code in the wiki. While going through luaconf.h, I
note LUA_USE_APICHECK, which I'll try defining at some point to see if it catches the crash above.
</p>

<h2>2011-12-13</h2>

<p>
Tuesday morning. Continuing reading and documenting lua source code.
</p>

<h2>2011-12-15</h2>

<p>
Thursday morning. Tuesday morning, I conceived of a nice system for representing and 
understanding the execution of code - use vim to display multiple windows:
</p>

<ul>
<li>Navigator and Narrative windows on top
<li>Source window in middle
<li>Data/Detail window(s) on bottom
</ul>

<p>
vim scripts would define a sequence of narrative and highlighting actions for each
step through the source code, showing the effect on various data structures,
connecting high-level intent with low-level execution. Something analogous to
the schematic molecular simulations that I developed for ribosome builder.
</p>

<p>
However, today I'm starting on a lua program to drive the gserver/gclient tools
to record a sequence of execution steps through lua code.
</p>

<h2>2011-12-16</h2>

<p>
Friday again, Hallelule. Yesterday I started on the gtrace.lua program, which
will drive the gclient app to step through lua source code. Continuing that
this morning, beginning with parsing out the .c files from info sources ret:
</p>

<pre>
(gdb) info sources
Source files for which symbols have been read in:



Source files for which symbols will be read in on demand:

/System/Library/Frameworks/System.framework/PrivateHeaders/i386/cpu_capabilities.h, /System/Library/Frameworks/System.framework/PrivateHeaders/machine/cpu_capabilities.h, <command line>, <built-in>, /SourceCache/Libsystem/Libsystem-111.1.7//, /SourceCache/Libsystem/Libsystem-111.1.7/CommPageSymbols.st, /var/tmp//cc6o3sx0.s, lcode.c, lparser.c, lundump.c, lbaselib.c, ltablib.c, lopcodes.c, ldblib.c, lmem.c, loslib.c, lstrlib.c, lmathlib.c, loadlib.c, liolib.c, lzio.c, llex.c, lgc.c, ldump.c, lvm.c, ltable.c, lstring.c, ldo.c, ltm.c, /usr/include/ctype.h, lobject.c, lfunc.c, ldebug.c, linit.c, lstate.c, lauxlib.c, lapi.c, lua.c
(gdb) 
</pre>

<p>
Finished code to parse source files. Next: parse 'start' response:
</p>
<pre>
(gdb) start
Breakpoint 1 at 0x2daf: file lua.c, line 380.
Starting program: /Users/williamknight/proj/git/vblend/dist/lua 
Reading symbols for shared libraries +++.. done

Breakpoint 1, main (argc=1, argv=0xbffff674) at lua.c:380
380  lua_State *L = lua_open();  /* create state */
(gdb) 
</pre>

<h2>2011-12-17</h2>

<p>
Maybe will get some coding time in tonight before going to a party. Nope.
</p>

<p>
Next parse tasks:
</p>
<pre>
(gdb) info source
Current source file is lua.c
Compilation directory is /Users/williamknight/proj/git/vblend/lua
Located in /Users/williamknight/proj/git/vblend/lua/lua.c
Contains 392 lines.
Source language is c.
Compiled with DWARF 2 debugging format.
Does not include preprocessor macro info.
(gdb)
</pre>

<pre>
(gdb) info line
Line 380 of "lua.c" starts at address 0x2daf <main+13> and ends at 0x2db7 <main+21>.
(gdb) 
</pre>

<p>
Should be easy enough.
</p>

<p>
Debugging, adding printout of line code to debugger.lua, makes it much easier to use.
</p>

<p>
Crap, must have broken backtrace. Fixed.
</p>

<p>
Finally got it working:
</p>
<pre>
mhackslab:dist $ r
lua.c:380
lauxlib.c:648
lstate.c:147
lauxlib.c:630
lauxlib.c:635
lauxlib.c:636
lstate.c:148
lstate.c:149
lstate.c:150
lstate.c:151
lstate.c:152
mhackslab:dist $ 
</pre>

<h2>2011-12-18</h2>

<p>
Created test/ape project (annotated program execution), which will contain scripts
and data to do annotated display of lua program execution in vim. The main annotation
definitions are in xml format in file ape_lua.xml. Downloaded and tested simple
xml parser by Roberto Ierusalimschy, it works.
<ul>
<li>xml element name: in string with key 'label'
<li>attributes: in table with key 'xarg'
<li>text and child nodes: in table with numeric keys 
</ul>
</p>

<h2>2011-12-19</h2>

<p>
This morning, will start learning some vim scripting to setup the narrative windows.
</p>

<p>
Started using some basic vim scripting code and functions to open, size and move around
windows, need to define the 'nav/narrative/source/detail' layout. Need to read
about 'redefine/detect' existing functions in vim.
</p>

<h2>2011-12-20</h2>

<p>
Slept in late, not much time for actual work this morning, so instead, ran 'mkid' on
lua source dir and using 'gid' to troll around the lua code.
</p>

<h2>2011-12-21</h2>

<p>
Up very early, back on vim scripting. Finished creating code to open and close ape
windows. The vim scripting is starting to sink in and should take my vimitude
to a whole new level.
</p>

<p>
After reading a little about lua 5.2 changes on very interesting corsix.org blog,
back to vim to see if it provides event hooks for updating ape display. Started
reading about autocommands and was very please to note 'CursorMoved' event and
also amazed at the huge unsuspected world of autocommand definitions revealed
just by typing ':au'.
</p>

<p>
Next, I've decided to create a lua script to read the ape xml file and generate
a vim script that defines the ape data in vim data structures. Next: read
up on vim data structures.
</p>

<h2>2011-12-22</h2>

<p>
It's a Friday Thursday for me, a little time this morning for reading lua and
working on ape. A brief look at vim data structures yesterday and a 10-second
test this morning indicates they will be easy to use, I just did:
</p>

<pre>
let l1=[1, 2, 3]
echo l1
-&gt;[1, 2, 3]
let t1 = {'name': 'test table', 'content': l1}
echo t1
-&gt;{'name': 'test table', 'content': [1, 2, 3]}
</pre>

<p>
So now to write some lua code that defines a vim dictionary from a lua table.
</p>

<p>
Whipped up a quick function to do that, it appears to work. Next, need to
re-work the raw lua-from-xml table into something that just has the desired
xml content (not 'xargs' and 'labels').
</p>

<h2>2011-12-23</h2>

<p>
Program with six ape steps created.
</p>

<p>
"From an early age, Kim Jong-un liked to wear a military uniform and displayed
hostility toward Japan, Korea’s former colonial ruler, the chef said. "
</p>

<p>
Hello second Pacific War. Hawaii. North-Korean agents detonate nuclear weapons
in Tokyo and Hawaii.
</p>

<p>
</p>

<p>
In the mean time, pf inc.
</p>

<p>
So must get the modeling working in lua.
</p>

<p>
How about just a vim script to do program step-by-step execution and just
describe each step in a separate window, using vim commands?
Could even be prompted. "Step-by-step instructions on how to use this
tool".
</p>

<p>
Created .vgape.vim
</p>

<p>
IHYFYGBAIWCWGJIYP
</p>

<p>
new business: audo-record-digitization, w/o requiring delivery of disk (just sell
recording device?)
</p>

<h2>2011-12-30</h2>

<p>
I have 4 more glorious days of time off, continuing work on vim scripts to support
creation of lua ape. Currently, the test/ape/ape.vim script is displaying
multiple windows with working initialization of gdb and stepping through code,
with highlighting of current source file and line.
</p>

<p>
Next, I need to resolve the best way to support interactive annotation of the
program execution. The first version will be simple, with each file:line 
appended in the nav window at each program step and content of narrative
window updates corresponding step item in list of steps in ape data.
</p>

<p>
Later, some kind of support for intra-step narratives will need to be added.
</p>

<p>
First though, need to add step-driven appending of file:line to nav window and ape 
list.
</p>

<p>
Got ape Init() working the way I want, and :redraw works as desired!
</p>

<h2>2012-01-01</h2>

<p>
A new year dawns. Continuing ape.vim script, saving step info with function
WriteSteps(). Need to learn vim debugging methods now, there are errors that
are only briefly display, need to get the script to halt there.
</p>

<p>
Got WriteSteps() working, but weird line-ending on narrative text:
</p>
<pre>
<step src_file="/Users/williamknight/proj/git/vblend/lua/lua.c" src_line="380">
<narrative>
prog start. 
</narrative>
</step>
</pre>

<p>
xxd reveals it to be a null byte (0x00). Is this somehow a consequence of the 'get()' return
value? Will debug to investigate.
</p>

<p>
It's the newline, from 'writefile()' docs:
</p>
<blockquote>
...
All NL characters are replaced with a NUL character.
...
</blockquote>

<p>
Fixed.
</p>

<h2>2012-01-02</h2>

<p>
Starting on reading steps.xml file in vim. Already have lua code to do most of
the work.
</p>

<p>
Grr, keep getting burned on '_' not being a valid xml attribute name, at least 
according to the lua xml parser code that I'm currently using.
</p>

<p>
I fixed it by adding '_' to the attr pattern.
</p>

<h2>2012-01-03</h2>

<p>
Vacation sadly at an end, must go to work in minutes. This morning, I've decided
to keep vim steps data in vim data format, not xml, avoiding need for lua
script to parse and reconvert. This works for multi-line vim strings:
</p>
<pre>
let g:ape_steps = [
\{
\'narr' : "Program start.\nCall internal func.",
\'src_file' : "/Users/williamknight/proj/git/vblend/lua/lua.c",
\'src_line' : "380"
\},
\{
\'narr' : "Internal call.\n",
\'src_file' : "/Users/williamknight/proj/git/vblend/lua/lauxlib.c",
\'src_line' : "648"
\},
\{
\'narr' : "init state objs",
\'src_file' : "/Users/williamknight/proj/git/vblend/lua/lstate.c",
\'src_line' : "147"
\}
\]
</pre>

<p>
Kinda ugly, but no worse than xml really.
</p>

<h2>2012-01-04</h2>

<p>
Got ape_steps.vim export working, next: implement ReadSteps().
</p>

<h2>2012-01-05</h2>

<p>
Up early, another day of vim-scripting to learn lua internals to finish
text editor to use in graphics tool to create 3D game worlds.
</p>

<p>
Need to replace s:cur_src_file/s:cur_src_line with s:cur_step_pos
</p>

<h2>2012-01-07</h2>
<p>
Get img and sound libs working.
</p>

<p>
Add tanks and Romney robots.
</p>

<h2>2012-01-14</h2>

<p>
Took a break, will do some more work on ape today. Two index vars have been
defined, nav_pos and exe_pos.
</p>

<p>
Did a little more work throughout the day, nav movement is working, but need
to sync it with exe pos.
</p>

<h2>2012-01-17</h2>

<p>
A little more work this morning. I need to clearly define what is intended to
happen with navigation and execution. When a previously saved file is loaded,
the execution position is at program start. What determines how the execution
position is incremented? Should it be linked to the nav position? Or must
it be incremented with a separate command?
</p>

<p>
On the bus, created ape-doc.txt help file, this will help with defining the
program specifications.
</p>

<h2>2012-01-18</h2>

<p>
Will take the car today, so a little more time for work. In writing the
help doc, I defined a 'continue-execute-type' data member for the saved
steps, just need a catchy attribute name for it ... Will just go
with 'continue' for now.
</p>

<h2>2012-01-19</h2>

<p>
Another day, another line of code.
</p>

<p>
I'm currently confused by the association of the 'nav_pos' variable with the '&gt;' prefix
in the nav window. Seems like the 'exe' pos should be associated with it instead.
</p>

<p>
I'm going to get rid of the nav_pos var, the vim cursor line will represent that position.
</p>

<p>
Yeah, the deal is, the '&gt;' ALWAYS shows the current exe position in gdb, that's all.
Furthermore, f8 and f9 ONLY step the exe position.
</p>

<h2>2012-01-20</h2>

<p>
Friday again, hooray.
</p>

<p>
Currently working on bug where after the 2nd step in a new run, it doesn't append 3rd line
in nav window. Instead, it moves cursor to 1st line.
</p>

<p>
I would really like to find a way to echo script variables after the script has stopped 
running. An alternative would be to temporarily change all s:vars to g:vars.
</p>

<p>
Based on this in the vim help docs, I conclude you can't access them, so will do the
alternative for now:
</p>
<blockquote>
                                                *script-variable* *s:var*
  In a Vim script variables starting with "s:" can be used.  They cannot be
  accessed from outside of the scripts, thus are local to the script.
</blockquote>

<p>
Now, need to carefully define/understand the desired initial state of steps list and exe_pos var
for a new run:
</p>
<ul>
<li>prog start: steps list empty, exe_pos == -1
<li>after gdb init: prog 'start' line added to steps list, exe_pos == 0
</ul>

<p>
That was the next piece I was missing.
</p>

<p>
No, it currently is supposed to do that. I think all that is needed is
to init exe_pos to -1.
</p>

<h2>2012-01-21</h2>

<p>
Glorious Saturday, off to a slow start. Will add code to set cursor line on step
and continue, working on file save.
</p>

<p>
That works, but now window sizes are wrong and some script line is flashing.
</p>

<p>
Fixed window sizes, but screen size is still hopping up and down during stepping.
</p>

<p>
Tracked it down to 'GotoSrcLine()' call in NewStep(). Ah, it's because I call
redraw in there.
</p>

<p>
Elminated the redraw call, just need to apply a scroll offset and should be good.
</p>

<p>
Got it all displaying nicely again.
</p>

<p>
WriteSteps() appears to be working as expected, next will see how logic 
works after ReadSteps().
</p>

<h2>2012-01-22</h2>

<p>
Sunday morning. Continuing, reading steps, there is a bug where the 2nd step
is displayed on load instead of the first.
</p>

<p>
Set breakpoint in Init, stepped through vim debugger, it's happening in
ReadSteps(). Love being able to debug vim scripts.
</p>

<p>
Found the bug, UpdateNar() relies on an ill-defined cursor pos in some 
current window:
</p>
<pre>
  "build new content
  let cursor_pos = line(".")
  let nav_step = g:ape_steps[cursor_pos]
  let narr = nav_step['narr']
</pre>

<p>
To fix this, I must determine if anything changes the cursor pos in
the nav window.
</p>

<p>
For now, I will just fix it by setting the nav cursor pos to the
exe pos on init and step.
</p>

<p>
Duh, code above shows that the cursor_pos is in narr window and
will always be 1. Need some function like GetNavPos().
</p>

<p>
Ok, finally fixed that trivial bug. Next: add update of cursor
pos with exe pos on step.
</p>

<p>
Ok, did it. Exe playback appears to finally be working as expected.
</p>

<h2>2012-01-23</h2>

<p>
A little time before leaving for work today, I will try to start using
ape to actually annotate for reals now.
</p>

<p>
Need to add updating of step info from modified narrative content.
</p>

<p>
Not working, here is current definition of SaveNarrative():
</p>
<pre>
function! SaveNarrative()
let step_info = g:ape_steps[len(g:ape_steps) - 1]
call GotoNarWin()
:sil 1,$y n
let step_info['narr'] = @n
endfunction
</pre>

<p>
After step, and presumably call to above function, the modified narrative
isn't in g:ape_steps. I'm guessing it's because step_info is not
actually a reference to the list item in g:ape_steps but instead
is a copy.
</p>

<p>
No, duh, it's the pos that is wrong.
</p>

<p>
Fixed, that's all for now! :P  Next: add save of narr of current step
in WriteSteps().
</p>

<h2>2012-01-24</h2>

<p>
On the bus, almost no time to code. Next tasks include:
</p>
<ul>
<li>define an autocmd to update narr window with cursor movement in nav win
<li>create 'run to final step' function to automatically step through a loaded steps list
</ul>

<h2>2012-01-25</h2>

<p>
To bed too late last night, up too late this morning, only a little time. Starting
on DefineAutoNav() function.
</p>

<p>
Did it, it works. Next, need to add saving of edited Narr window to steps.
</p>

<p>
There is a problem with current method of determining the current nav position.
I believe I fixed a previous bug by using the g:exe_pos, but of course that
isn't always correct.
</p>

<p>
Will try this now:
</p>
<pre>
function! SaveNarrative()
"let pos = g:exe_pos
let pos = GetNavPos()
let step_info = g:ape_steps[pos]
call GotoNarWin()
:sil 1,$y n
let step_info['narr'] = @n
endfunction
</pre>

<p>
Nope, that doesn't work, I suspect current nav pos is lost updating the nav win.
We will actually need an explicit var to hold the current cursor pos in nav win
I think.
</p>

<p>
Another thing I'll determine first is if the autocommand firing is recursive,
that would naturally mess things up.
</p>

<p>
Added recursion check, doesn't appear to be happening. More debugging 
needed. I might add a debug output window to better track what's going on.
</p>

<p>
Will resurrect the details window for this purpose.
</p>

<p>
Did it, there doesn't appear to be any vim function to load content into
a buffer that isn't the current buffer. This is little unfortunate as
it means I must make the debug window 'current' in order to append text
to it, which may change the behavior of the script. Hopefully won't matter
too much. Anyhow, my time is up this morning, must begin work at final
days at Modwest.
</p>

<h2>2012-01-27</h2>

<p>
Starting a new project, but I _will_ keep working on this one as well, it
will certainly be complementary.
</p>

<p>
Added DbOut(), it works. Using it to debug the OnNavCursorMoved() problem.
</p>

<p>
The DbOut() calls show the bug:
</p>
<pre>
BEG OnNavCursorMoved()
---g:ape_steps: [{'src_file': '/Users/williamknight/proj/git/vblend/lua/lua.c', 'continue': 'step', 'narr': 'Lua entry point. Creates new lua_State.     ', 'src_line': '380'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lauxlib.c', 'continue': 'step', 'narr': 'Calls internal func to create new lua_State. ', 'src_line': '648'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lstate.c', 'continue': 'step', 'narr': 'Allocates memory for lua_State struct. ', 'src_line': '147'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lauxlib.c', 'continue': 'step', 'narr': 'if empty alloc, just free.  ', 'src_line': '630'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lauxlib.c', 'continue': 'step', 'narr': 'Allocates through call to Clib func. ', 'src_line': '635'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lauxlib.c', 'continue': 'step', 'narr': ' ', 'src_line': '636'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lstate.c', 'continue': 'step', 'narr': 'If no mem avail, return NULL. ', 'src_line': '148'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lstate.c', 'continue': '', 'narr': ' ', 'src_line': '149'}
]
BEF SaveNarrative()
BEF UpdateNar()
---g:ape_steps: [{'src_file': '/Users/williamknight/proj/git/vblend/lua/lua.c', 'continue': 'step', 'narr': 'Lua entry point. Creates new lua_State.     ', 'src_line': '380'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lauxlib.c', 'continue': 'step', 'narr': 'Calls internal func to create new lua_State. ', 'src_line': '648'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lstate.c', 'continue': 'step', 'narr': 'Lua entry point. Creates new lua_State.      ', 'src_line': '147'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lauxlib.c', 'continue': 'step', 'narr': 'if empty alloc, just free.  ', 'src_line': '630'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lauxlib.c', 'continue': 'step', 'narr': 'Allocates through call to Clib func. ', 'src_line': '635'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lauxlib.c', 'continue': 'step', 'narr': ' ', 'src_line': '636'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lstate.c', 'continue': 'step', 'narr': 'If no mem avail, return NULL. ', 'src_line': '148'}
, {'src_file': '/Users/williamknight/proj/git/vblend/lua/lstate.c', 'continue': '', 'narr': ' ', 'src_line': '149'}
]
BEF GotoNavWin()
END OnNavCursorMoved()
</pre>

<p>
Will have a clear starting point next time, now it's time to walk to work.
</p>

<h2>2012-02-01</h2>

<p>
A little more work on this today, fit in among other projects.
</p>

<p>
The debug output allows me to clearly describe the actual current buggy behavior,
which I will then contrast with the desired one. The process begins with the
cursor on the first line in the nav window, and the associated first narrative
in the narrative window.
</p>

<p>
When the 'down' key is hit, the cursor moves to the second line. Then the OnNavCursorMoved()
function is called. In this function, the SaveNarrative() function is called. In that function,
the GetNavPos() function is called, which returns the value '2', because the cursor is on
the 2nd line.
</p>

<p>
Next in SaveNarrative(), the value '2' is incorrectly used as an index to the
current nav pos, because the index is 0-based. This causes the narrative value
of the 3rd step in the array to be overwritten with the current narrative text,
which is actually the narrative text of the first step.
</p>

<p>
The desired behavior is to get the correct 0-based index of the nav
cursor position _before_ the move and save the current narrative text
in that step, before it gets updated with the text of the new position.
</p>

<p>
So the first question is, how do we get the previous cursor position when 
execution lands in OnNavCursorMoved()? Also, the SaveNarrative() function
is currently called in other places and is intended to save for the current
cursor position in the nav window. This is at odds with the behavior
of the cursor event-handling, which only fires after the cursor has moved.
</p>

<p>
One possibility, which I like, is to pass the position to be saved to 
SaveNarrative() instead, because this reduces mysterious behavior/dependence
of the function on implicit program state. The simpler and more predictable
functions are, the better. So that is how I will proceed.
</p>

<p>
Did that, but still need a variable to track the nav cursor position.
Adding it.
</p>

<p>
Made the changes, test it, there are still problems with the steps content
when it's saved. I think it's because the narr content isn't being updated
correct after cursor moved.
</p>

<p>
Made some more changes, think I'm close, but still not there. Now the
narrative content is being emptied on cursor move. I suspect one more
debugging run will fix it, but I'm done for now.
</p>

<h2>2012-02-02</h2>

<p>
Up early, have other things to do, but would really like to get this
project to the point of being usable, I think it's close.
</p>

<p>
Found the problem, cursor(".") appears to return -1 at beginning of
OnNavCursorMoved(). Omg, that's because cursor() is a setter, not
a getter dumbkopf!
</p>

<p>
Ok, that works. Continuing.
</p>

<p>
Still fixing off-by-one errors in mismatch between the 0-based indices
of the arrays and the 1-based indices of line nums. Source win is
now tracking nav pos, but losing syntax highlighting, and 2nd narr
pos still gets messed up, overwritten by 1st one.
</p>

<p>
No, that 2nd prob is because the ape_steps.vim file got overwritten
somehow.
</p>

<p>
Grrr, another bug, now it's dumping detail output into the source win!
</p>

<p>
Hmm, that bug isn't repro, but disturbing. Now everything seems to
work except for losing syntax highlighting in the source win, wtf
is up with that?
</p>

<p>
I'm guessing it's because I'm calling redraw() to update the cursor
pos in src win. All this wrangling is making me weary. Love vim and
feel I'm close, but also feel like I'm trying to force it to be
a special-purpose gui which might be easier to implement with some
other code/tool. But of course, that would set back my progress
even further.
</p>

<p>
Since one of my goals is to have a built-in vim-style debugger in
vblend anyway, I may consider just trying to bootstrap it from there.
</p>

<p>
Hmm, spotted the source-win overwrite bug, wasn't checking for
enabled DetailWin in DbOut(), will fix that and see what happens.
</p>

<p>
Naw, I was currently showing the detail win anyway.
</p>

<h2>2012-03-17</h2>

<p>
Hiatus. But time is coming.
</p>

<p>
Starting porting to linux. Need to find the lua script that converts Makefile.osx to mingw and
add similar for linux. Why, it looks like this is the one:
</p>
<pre>
./util/gen_mingw_from_osx_makefile.lua:  ['SO=so'] = 'SO=dll',
</pre>

<h2>2012-03-18</h2>

<p>
Resume linux port of vblend. Working on Makefile.linux for libglfw, it's not as straightforward
because the distributed Makefiles are complicated and ugly. I'll just redo largely from scratch,
adding stuff as needed.
</p>

<p>
Finished, it built. Now must test.
</p>

<h2>2012-03-19</h2>

<p>
Early Monday morning, back for a little testing of libglfw. Built the test app and now trying
to link it, I want to find some reference docs on the undefined X functions it's reporting:
</p>
<pre>
wknight@johnny:~/proj/git/vblend/test/glfw$ m
cc -o howdy howdy.o -L../../glfw/libglfw -lglfw
../../glfw/libglfw/libglfw.so: undefined reference to `glXMakeCurrent'
../../glfw/libglfw/libglfw.so: undefined reference to `XFree'
../../glfw/libglfw/libglfw.so: undefined reference to `XMoveWindow'
../../glfw/libglfw/libglfw.so: undefined reference to `XFreeCursor'
../../glfw/libglfw/libglfw.so: undefined reference to `glXGetConfig'
../../glfw/libglfw/libglfw.so: undefined reference to `XStoreName'
../../glfw/libglfw/libglfw.so: undefined reference to `XFreeColormap'
...
</pre>


<h2>2012-03-21</h2>

<p>
Got the test program linked yesterday (just needed to add -lX11). Adding
the rest of the test code.
</p>

<p>
In trying to get it to run, I learned how to use the '$ORIGIN' link option:
<p>
<pre>
howdy: howdy.o
  $(CC) -o $@ howdy.o $(libs) -Wl,-rpath='$$ORIGIN'/$(libglfw_dir)
</pre>

<h2>2012-03-22</h2>

<p>
Continue porting to linux. Will call the libglfw build good for now,
even though I haven't fully tested it because I can't open a remote
X display from my macbook and don't feel like walking over to my
linux box right now.
</p>

<p>
Finished creating all linux makefiles, committed, tried to push,
got error:
</p>
<pre>
wknight@johnny:~/proj/git/vblend$ git push
Enter passphrase for key '/home/wknight/.ssh/id_rsa': 
Password:
To ssh://williamknight@mhackslab/~/proj/git/vblend
 ! [rejected]        master -&gt; master (non-fast-forward)
 error: failed to push some refs to 'ssh://williamknight@mhackslab/~/proj/git/vblend'
 To prevent you from losing history, non-fast-forward updates were rejected
 Merge the remote changes before pushing again.  See the 'Note about
 fast-forwards' section of 'git push --help' for details.
 wknight@johnny:~/proj/git/vblend$ 
</pre>

<p>
Time to learn more about git.
</p>

<p>
Attempted to run howdy demo, got error:
</p>
<pre>
  wknight@johnny:~/proj/git/vblend/dist$ ./hello 
  ./lua: error loading module 'lua_glfw' from file './lua_glfw.so':
  ../util/sys.so: cannot open shared object file: No such file or directory
  stack traceback:
  [C]: ?
  [C]: in function 'require'
  ./gamelib.lua:9: in main chunk
  [C]: in function 'require'
  hello.lua:7: in main chunk
  [C]: ?
  wknight@johnny:~/proj/git/vblend/dist$ ls
</pre>

<p>
So, looks like I should build with fixed so paths.
</p>
<pre>
  wknight@johnny:~/proj/git/vblend/dist$ ldd lua_glfw.so
  linux-gate.so.1 =&gt;  (0x001e8000)
  ../util/sys.so =&gt; not found
  libglfw/libglfw.so =&gt; not found
  libGL.so.1 =&gt; /usr/lib/nvidia-current/libGL.so.1 (0x004c9000)
  libGLU.so.1 =&gt; /usr/lib/libGLU.so.1 (0x002ba000)
  libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0x00ccb000)
  libGLcore.so.1 =&gt; /usr/lib/nvidia-current/libGLcore.so.1 (0x00e24000)
  libnvidia-tls.so.1 =&gt; /usr/lib/nvidia-current/tls/libnvidia-tls.so.1 (0x00275000)
  libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0x00110000)
  libXext.so.6 =&gt; /usr/lib/libXext.so.6 (0x00206000)
  libX11.so.6 =&gt; /usr/lib/libX11.so.6 (0x0058e000)
  libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0x009e4000)
  libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0x0032b000)
  libgcc_s.so.1 =&gt; /lib/libgcc_s.so.1 (0x00136000)
  /lib/ld-linux.so.2 (0x00424000)
  libxcb.so.1 =&gt; /usr/lib/libxcb.so.1 (0x00b25000)
  libXau.so.6 =&gt; /usr/lib/libXau.so.6 (0x0021c000)
  libXdmcp.so.6 =&gt; /usr/lib/libXdmcp.so.6 (0x0083d000)
  wknight@johnny:~/proj/git/vblend/dist$ 
</pre>

<h2>2012-03-23</h2>

<p>
Friday! And a good Friday it is. Read a little of the ld man page on the bus yesterday
and a little this morning and I decided to just remove the referenced shared 
libraries from the link line for lua_glfw.so and it builds just fine and ldd reports
they are no longer referenced. So unlike osx, apparently you don't even need to
mention these when producing shared libraries in GNU/Linux. We'll see, after 
creating the final executables.
</p>

<p>
But before going through and removing all those in the Makefiles, I need to get the
current code checked in, so a little more reading of git.
</p>

<h2>2012-03-24</h2>

<p>
More reading about git, I learned to use the git diff
tool with -t vimdiff to display the diffs of a file
between two commits in vim, this is something I've
been wanting to figure out for a while. It's a lot
more convenient than what I've had to do with svn
in the past, where I had to export a file from an
older revision and then compare the diffs in vim 
manually.
</p>

<p>
Now, just need to read a little more about branches
and repositories in order to figure out how to commit
these changes from my johnny repository to either
mhackslab or the modwest remote.
</p>

<p>
Added remote repository modwest, finally pushed:
</p>
<pre>
$ git remote add modwest mmmmhack@shell.modwest.com:git/vblend
$ git push modwest
</pre>

<p>
Now, on to removing dependent libs from link lines of linux makefiles.
</p>

<p>
I need to generate 2 lists: 
<ul>
<li>linux makefiles generated from Makefile.osx
<li>hand-crafted linux makefiles
</ul>

<p>
Ok, removed all shared lib refs from shared lib link lines, but now
get:
</p>
<pre>
wknight@johnny:~/proj/git/vblend/dist$ ./hello
./lua: error loading module 'lua_glfw' from file './lua_glfw.so':
./lua_glfw.so: undefined symbol: glfwInit
stack traceback:
[C]: ?
[C]: in function 'require'
./gamelib.lua:9: in main chunk
[C]: in function 'require'
hello.lua:7: in main chunk
[C]: ?
wknight@johnny:~/proj/git/vblend/dist$ 
</pre>

<p>
So, looks like you must provide a ref to routines in other shared libs after
all? Or maybe just need to specify them all when linking the executable?
No, because we aren't producing an executable!
</p>

<p>
Need to read about rpath again...
</p>

<p>
--rpath-link works IF the shared lib already exists, but gives an error if it 
doesn't (contrary to what the man page says):
</p>
<pre>
make[1]: Leaving directory `/home/wknight/proj/git/vblend/glfw/libglfw'
gcc -o lua_glfw.so -shared lua_glfw.o   -Wl,--rpath-link /home/wknight/proj/git/vblend/dist/libglfw.so  -lGL -lGLU
gcc: /home/wknight/proj/git/vblend/dist/libglfw.so: No such file or directory
make: *** [lua_glfw.so] Error 1
wknight@johnny:~/proj/git/vblend/glfw$ 
</pre>

<p>
A little SO reading, next I'll try using this in conjunction with the build location and
see what happens.
</p>

<p>
No, it still bitches about the missing file.
</p>

<p>
Ok, I think I have one way that works. May not be the best but also not the worst,
which was to install the dependent shared lib in PREFIX dir before linking
the depender lib. By setting 'soname' of dependent lib to PREFIX dir,
I can then build depender lib with just '-L dependent_lib_build_dir' -ldependent_lib'
and after copying both of them to the PREFIX dir, the dependency resolves
according to ldd.
</p>

<h2>2012-03-25</h2>

<p>
I will apply the solution found yesterday to try to get the linux build working.
<p>

<h2>2012-03-26</h2>

<p>
Made a start on Makefile work yesterday, created script to systematically
generate all the generated linux Makefiles, continuing.
</p>

<p>
grr, running into a problem where I'm defining an env variable, but
make isn't seeing it, wtf?
</p>
<pre>
--- in Makefile:
$(info bef error: PREFIX: [$(PREFIX)])
ifndef $(PREFIX)
$(error "PREFIX env var not defined")
endif
$(info aft error: PREFIX: [$(PREFIX)])

--- make:
wknight@johnny:~/proj/git/vblend/util$ PREFIX=~/proj/git/vblend/dist make -f Makefile.linux 
bef error: PREFIX: [/home/wknight/proj/git/vblend/dist]
Makefile.linux:7: *** "PREFIX env var not defined".  Stop.
wknight@johnny:~/proj/git/vblend/util$ 
</pre>

<p>
I'm thinking that the 'ifndef' conditional isn't working the way I think it should.
</p>

<p>
Ok, reading the docs always helps:
</p>
<pre>
`ifdef VARIABLE-NAME'
     The `ifdef' form takes the _name_ of a variable as its argument,
      not a reference to a variable.  The value of that variable has a
     non-empty value, the TEXT-IF-TRUE is effective; otherwise, the
      TEXT-IF-FALSE, if any, is effective.  Variables that have never
     been defined have an empty value.  The text VARIABLE-NAME is
      expanded, so it could be a variable or function that expands to
     the name of a variable.  For example:

           bar = true
           foo = bar
           ifdef $(foo)
           frobozz = yes
           endif
</pre>

<p>
Ok, drop the '$()' around it, back on track.
</p>

<p>
Finished makefile work, after new build, no shared lib issues running
'hello' demo, but it fails in call to gamelib.open_window()
</p>

<h2>2012-03-27</h2>

<p>
A little more debugging this morning, stepped through in gdb: '$ gdb --args lua hello'
and set breakpoint in lw_openWindow() (don't know why I never did that before, instead
of weird C wrapper funcs, totally not necessary) and found it failing here, in
glfw/libglfw/window.c:
</p>
<pre>
    if( _glfwWin.glMajor &gt; 2 )
    {
        _glfwWin.GetStringi = (PFNGLGETSTRINGIPROC) glfwGetProcAddress( "glGetStringi" );
        if( !_glfwWin.GetStringi )
        {
            // This is a very common problem among people who compile GLFW
            // on X11/GLX using custom build systems, as it needs explicit
            // configuration in order to work
            //
            // See readme.html section 2.2 for details

            glfwCloseWindow();
            return GL_FALSE;
        }
    }
</pre>

<p>
That looks promising. One other thing: need to recompile with -O0 because stepping in
gdb showed weird sequences.
</p>

<h2>2012-03-28</h2>

<p>
Another day, another line of code. I looked at the Makefile for glfw and noted to
my consteration that it was already compiling with -O0. ???
</p>

<p>
Duh, that's for glfw, not libglfw.
</p>

<p>
Checked out the glfw readme, then I started looking at compile.sh, and then did:
</p>
<pre>
wknight@johnny:~/proj/git/vblend/dev/glfw-2.7.2$ ./compile.sh 
Checking what kind of system this is... Linux
Checking for X11 libraries location... unknown (assuming linker will find them)
Checking whether we are using GNU C... yes
Checking for X11 RandR support... yes
Checking for pthread support... yes
Checking for sched_yield... yes
Checking for glXGetProcAddress variants... glXGetProcAddress
Checking for sysconf... yes
Checking for sysctl support... no
Creating ./lib/x11/Makefile.x11
Creating ./examples/Makefile.x11
Creating ./tests/Makefile.x11
Creating ./lib/x11/libglfw.pc.in
wknight@johnny:~/proj/git/vblend/dev/glfw-2.7.2$ 
</pre>

<p>
Added the CFLAGS and LFLAGS from the compile.sh script, built again, got error
</p>
<pre>
cc -o libglfw.so -lXrandr -lXrandr -lX11 -lGL -pthread -lm enable.o fullscreen.o glext.o image.o init.o input.o joystick.o stream.o tga.o thread.o time.o window.o x11_enable.o x11_fullscreen.o x11_glext.o x11_init.o x11_joystick.o x11_keysym2unicode.o x11_thread.o x11_time.o x11_window.o -Wl,-soname,/home/wknight/proj/git/vblend/dist/libglfw.so
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 0 has invalid symbol index 12
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 1 has invalid symbol index 13
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 2 has invalid symbol index 2
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 3 has invalid symbol index 2
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 4 has invalid symbol index 12
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 5 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 6 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 7 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 8 has invalid symbol index 2
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 9 has invalid symbol index 2
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 10 has invalid symbol index 13
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 11 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 12 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 13 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 14 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 15 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 16 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 17 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 18 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 19 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 20 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 21 has invalid symbol index 14
/usr/bin/ld: /usr/lib/debug/usr/lib/crt1.o(.debug_info): relocation 22 has invalid symbol index 22
/usr/lib/gcc/i486-linux-gnu/4.4.3/../../../../lib/crt1.o: In function `_start':
(.text+0x18): undefined reference to `main'
collect2: ld returned 1 exit status
make: *** [libglfw.so] Error 1
wknight@johnny:~/proj/git/vblend/glfw/libglfw$ 
</pre>

<p>
Ah, I had left off the -shared flag. Rebuilt everything, trying hello demo again...
</p>

<p>
It works! We have achieved triple platform!! Finally!!!
</p>

<p>
Home from work, compiled with optimizations (this morning it worked, but pong
demo was slooow, 14 fps). Hopefully with opt it will be much faster.
</p>

<h2>2012-04-02</h2>

<p>
At Break, programming on Mac, now I'll have some good working time on this project.
What's next? Maybe some tests to check the state of the project on the various platforms.
</p>

<p>
No, I don't want to create tests right now, I want to do some cool 3D design. Will
work on that.
</p>

<p>
Gonnna have to get the editor working, and combine it with nav from gridcam3d.
</p>

<p>
I've re-identified the current bug in the editor app, I want to formally add it
to a bug tracking system, so I'm moving the project to github.
</p>

<p>
Added to git hub, and also added README, INSTALL and LICENSE files.
</p>

<p>
Creating issues in github and fixing them! I had a feeling that would help.
</p>

<p>
Finally working again on h-scroll bug, just doing printfs for now, here is win_pos before
auto-scroll calc (at buffer.lua:82):
</p>
<pre>
before scroll calc:
buffer.set_cursor(): cursor_pos[0]: 0, win_pos[0]: -1, b.scroll_pos[0]: 1
after:
b.scroll_pos[0]: 2
</pre>

<p>
So, how the hell is buffer.scroll_pos used again? Ok, used in buf2win
</p>

<pre>
buffer.set_cursor(): cursor_pos[0]: 0, win_pos[0]: -1, b.scroll_pos[0]: 1
after calc scroll: b.scroll_pos[0]: 2
after buf2win(): win_pos[0]: -2
</pre>

<h2>2012-04-03</h2>

<p>
Another day, time to get on this freakin scroll problem, don't know why
I'm having such a hard time with it.
</p>

<p>
Holy smokes, finally got the lil beyotch working.
</p>

<p>
Next: get 'o' command working (open new line)
</p>

<p>
Hmm, for row insertion, maybe need to change buffer lines from array to
linked list?
</p>

<p>
Yeah, shouldn't be a big deal at this point, not many refs to b.lines yet.
Will probably start by creating a buf_line module.
</p>

<h2>2012-04-04</h2>

<p>
Up later, not much time to program this morning but got buffer.lines replaced
with linked list without too much trouble, it's working. Next will finish
'open new line' command.
</p>

<p>
Continuing work at the UC, got the buffer.insert_line() function working,
but display still isn't right, cursor moves to new lower line, but text
is still getting written in line above.
</p>

<p>
Created another test in test/edit/buffer_insert_line.lua, it shows 
expected behavior, so need to debug the editor app directly again.
</p>

<p>
At home, a little more printf-debugging, I've found the flaw:
if b.update_all isn't set, then the first row of the display buffer
is set to the cursor_pos row of the text buffer, which obviously is
not correct. For simplicity, I might just ditch that optimization for
now and consider it later after the editor is more functional.
</p>

<p>
Ok, did that, finally can enter multiple lines, but after entering
4 lines, lua segfaulted! :(
</p>

<p>
Actually, crash appears to happen by just fast char input in insert mode,
so this is presumably not a new bug.
</p>

<p>
repro'd in gdb:
</p>
<pre>

Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_INVALID_ADDRESS at address: 0x6b65657a
luaH_getstr (t=0x6b656573, key=0x1006c0) at ltable.c:456
456  Node *n = hashstr(t, key);
(gdb) 
</pre>

<p>
Guess we're back to diving into lua internals.... :O
</p>

<pre>
gdb) bt
#0  luaH_getstr (t=0x6b656573, key=0x1006c0) at ltable.c:456
#1  0x000123e3 in call_binTM (L=0x100180, p1=0x800198, p2=0x8001a4, res=0x800198, event=TM_CONCAT) at lvm.c:163
#2  0x00012817 in luaV_concat (L=0x100180, total=3, last=5) at lvm.c:283
#3  0x000134a1 in luaV_execute (L=0x100180, nexeccalls=1) at lvm.c:533
#4  0x00008d60 in luaD_call (L=0x100180, func=0x80015c, nResults=1) at ldo.c:377
#5  0x0001201f in callTMres (L=0x1, res=<value temporarily unavailable, due to optimizations>, f=<value temporarily unavailable, due to optimizations>, p1=0xbffff2e4, p2=0x106214) at lvm.c:88
#6  0x00012e92 in luaV_execute (L=0x100180, nexeccalls=3) at lvm.c:433
#7  0x00008d60 in luaD_call (L=0x100180, func=0x800030, nResults=-1) at ldo.c:377
#8  0x000047c1 in f_call (L=0x1, ud=0x6b656573) at lapi.c:800
#9  0x0000823b in luaD_rawrunprotected (L=0x100180, f=0x47a0 <f_call>, ud=0xbffff438) at ldo.c:116
#10 0x00009082 in luaD_pcall (L=0x100180, func=0x1, u=0x1, old_top=48, ef=1) at ldo.c:463
#11 0x00004835 in lua_pcall (L=0x100180, nargs=0, nresults=-1, errfunc=2) at lapi.c:821
#12 0x000026b3 in docall (L=0x24, narg=0, clear=0) at lua.c:102
#13 0x00002e67 in handle_script [inlined] () at lua.c:250
#14 0x00002e67 in pmain (L=0x100180) at lua.c:362
#15 0x00008923 in luaD_precall (L=0x100180, func=0x80000c, nresults=0) at ldo.c:319
#16 0x00008d03 in luaD_call (L=0x100180, func=0x80000c, nResults=0) at ldo.c:376
#17 0x00004900 in f_Ccall (L=0x100180, ud=0x0) at lapi.c:846
#18 0x0000823b in luaD_rawrunprotected (L=0x100180, f=0x4890 <f_Ccall>, ud=0xbffff6b8) at ldo.c:116
#19 0x00009082 in luaD_pcall (L=0x100180, func=0x1, u=0x1, old_top=12, ef=1) at ldo.c:463
#20 0x00004957 in lua_cpcall (L=0x6b656573, func=0x1, ud=0x1) at lapi.c:856
#21 0x00003235 in main (argc=2, argv=0xbffff734) at lua.c:387
(gdb) 
</pre>

<p>
Rebuilt w/o optimizations, still crashes:
</p>

<pre>
rogram received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_INVALID_ADDRESS at address: 0x6b656583
0x00014d37 in luaH_getstr (t=0x6b656573, key=0x1006c0) at ltable.c:456
456  Node *n = hashstr(t, key);
(gdb) bt
#0  0x00014d37 in luaH_getstr (t=0x6b656573, key=0x1006c0) at ltable.c:456
#1  0x00015359 in luaT_gettmbyobj (L=0x100180, o=0x800198, event=TM_CONCAT) at ltm.c:73
#2  0x00016664 in call_binTM (L=0x100180, p1=0x800198, p2=0x8001a4, res=0x800198, event=TM_CONCAT) at lvm.c:163
#3  0x00016e30 in luaV_concat (L=0x100180, total=3, last=5) at lvm.c:283
#4  0x000188f7 in luaV_execute (L=0x100180, nexeccalls=1) at lvm.c:533
#5  0x0000a2bf in luaD_call (L=0x100180, func=0x80015c, nResults=1) at ldo.c:377
#6  0x00016167 in callTMres (L=0x100180, res=0x80012c, f=0x10a154, p1=0xbffff068, p2=0x106214) at lvm.c:88
#7  0x00016428 in luaV_gettable (L=0x100180, t=0xbffff068, key=0x106214, val=0x80012c) at lvm.c:125
#8  0x000176a0 in luaV_execute (L=0x100180, nexeccalls=3) at lvm.c:433
#9  0x0000a2bf in luaD_call (L=0x100180, func=0x800030, nResults=-1) at ldo.c:377
#10 0x0000497f in f_call (L=0x100180, ud=0xbffff3ec) at lapi.c:800
#11 0x00009516 in luaD_rawrunprotected (L=0x100180, f=0x4955 <f_call>, ud=0xbffff3ec) at ldo.c:116
#12 0x0000a652 in luaD_pcall (L=0x100180, func=0x4955 <f_call>, u=0xbffff3ec, old_top=48, ef=36) at ldo.c:463
#13 0x00004a1c in lua_pcall (L=0x100180, nargs=0, nresults=-1, errfunc=2) at lapi.c:821
#14 0x00001f18 in docall (L=0x100180, narg=0, clear=0) at lua.c:102
#15 0x0000282e in handle_script (L=0x100180, argv=0xbffff710, n=1) at lua.c:250
#16 0x00002d1a in pmain (L=0x100180) at lua.c:362
#17 0x0000a049 in luaD_precall (L=0x100180, func=0x80000c, nresults=0) at ldo.c:319
#18 0x0000a2a8 in luaD_call (L=0x100180, func=0x80000c, nResults=0) at ldo.c:376
#19 0x00004b03 in f_Ccall (L=0x100180, ud=0xbffff684) at lapi.c:846
#20 0x00009516 in luaD_rawrunprotected (L=0x100180, f=0x4a50 <f_Ccall>, ud=0xbffff684) at ldo.c:116
#21 0x0000a652 in luaD_pcall (L=0x100180, func=0x4a50 <f_Ccall>, u=0xbffff684, old_top=12, ef=0) at ldo.c:463
#22 0x00004b5a in lua_cpcall (L=0x100180, func=0x2b86 <pmain>, ud=0xbffff6cc) at lapi.c:856
#23 0x00002e05 in main (argc=2, argv=0xbffff710) at lua.c:387
(gdb) 
</pre>

<h2>2012-04-05</h2>

<p>
Up in the morning at the normal time before work, started reading lua src code again.
It's going to take a little while.
</p>

<p>
Looking through luaconf.h, I saw LUA_USE_APICHECK and recompiled with it, then on
running again, happens right after 'o' command:
</p>
<pre>
mhackslab:dist $ r
Assertion failed: (-(idx+1) &lt;= (L-&gt;top - L-&gt;base)), function lua_settop, file lapi.c, line 173.
Abort trap
mhackslab:dist
</pre>

<p>
Will try with hello.lua app to see if it's more general.
</p>

<p>
Doesn't happen with hello.lua. Or pong.lua. So that's hopeful.
</p>

<p>
In gdb:
</p>
<pre>
Assertion failed: (-(idx+1) &lt;= (L-&gt;top - L-&gt;base)), function lua_settop, file lapi.c, line 173.

Program received signal SIGABRT, Aborted.
0x93339d52 in __kill ()
(gdb) bt
#0  0x93339d52 in __kill ()
#1  0x93339d44 in kill$UNIX2003 ()
#2  0x933ac242 in raise ()
#3  0x933b8681 in abort ()
#4  0x933ad3e3 in __assert_rtn ()
#5  0x00003d23 in lua_settop (L=0x100180, idx=-2) at lapi.c:173
#6  0x0008fdb3 in keyCallback (key=79, action=1) at lua_setKeyCallback.c:19
#7  0x0009dadf in _glfwInputKey (key=79, action=1) at window.c:167
#8  0x000a0a89 in -[GLFWContentView keyDown:] (self=0x1715f0, _cmd=0x95368590, event=0x16900b40) at cocoa/cocoa_window.m:361
#9  0x9139e731 in -[NSWindow sendEvent:] ()
#10 0x9136a6a5 in -[NSApplication sendEvent:] ()
#11 0x0009f25c in -[GLFWApplication sendEvent:] (self=0x13ccc0, _cmd=0x952cf4b8, event=0x16900b40) at cocoa/cocoa_init.m:62
#12 0x000a20b7 in _glfwPlatformPollEvents () at cocoa/cocoa_window.m:847
#13 0x0009edf8 in glfwPollEvents () at window.c:987
#14 0x0009ea07 in glfwSwapBuffers () at window.c:822
#15 0x0008face in lw_swapBuffers (L=0x100180) at lua_glfw_func_def.c:99
#16 0x0000bbc9 in luaD_precall (L=0x100180, func=0x800120, nresults=0) at ldo.c:319
#17 0x0001ab1f in luaV_execute (L=0x100180, nexeccalls=3) at lvm.c:587
#18 0x0000be3f in luaD_call (L=0x100180, func=0x800030, nResults=-1) at ldo.c:377
#19 0x00006046 in f_call (L=0x100180, ud=0xbffff3ec) at lapi.c:800
#20 0x0000b096 in luaD_rawrunprotected (L=0x100180, f=0x601c &lt;f_call&gt;, ud=0xbffff3ec) at ldo.c:116
#21 0x0000c1d2 in luaD_pcall (L=0x100180, func=0x601c &lt;f_call&gt;, u=0xbffff3ec, old_top=48, ef=36) at ldo.c:463
#22 0x000061ef in lua_pcall (L=0x100180, nargs=0, nresults=-1, errfunc=2) at lapi.c:821
#23 0x00002680 in docall (L=0x100180, narg=0, clear=0) at lua.c:102
#24 0x00002f96 in handle_script (L=0x100180, argv=0xbffff710, n=1) at lua.c:250
#25 0x00003482 in pmain (L=0x100180) at lua.c:362
#26 0x0000bbc9 in luaD_precall (L=0x100180, func=0x80000c, nresults=0) at ldo.c:319
#27 0x0000be28 in luaD_call (L=0x100180, func=0x80000c, nResults=0) at ldo.c:376
#28 0x00006368 in f_Ccall (L=0x100180, ud=0xbffff684) at lapi.c:846
#29 0x0000b096 in luaD_rawrunprotected (L=0x100180, f=0x6224 &lt;f_Ccall&gt;, ud=0xbffff684) at ldo.c:116
#30 0x0000c1d2 in luaD_pcall (L=0x100180, func=0x6224 &lt;f_Ccall&gt;, u=0xbffff684, old_top=12, ef=0) at ldo.c:463
#31 0x000063c3 in lua_cpcall (L=0x100180, func=0x32ee &lt;pmain&gt;, ud=0xbffff6cc) at lapi.c:856
#32 0x0000356d in main (argc=2, argv=0xbffff710) at lua.c:387
(gdb) 
</pre>

<p>
The assert happens on any key input, but still maybe related as the previous crash occurs on
multiple key input.
</p>

<p>
Really need to see if this repros on other platforms.
</p>

<p>
Jesus, I don't even remember writing this code, but I did, and look at this:
</p>
<pre>
// lua_setKeyCallback.c:custom implementation for glfwSetKeyCallback()
#include &lt;string.h&gt;
#include "sys.h"
static char lua_keyCallbackFuncName[256] = "";
static lua_State* LL = NULL;
static void keyCallback(int key, int action) {
  // TODO: add reentrant guard?
  if(!strlen(lua_keyCallbackFuncName)) 
  return;
  lua_getglobal(LL, lua_keyCallbackFuncName);
  lua_pushnumber(LL, key);
  lua_pushnumber(LL, action);
  int rc = lua_pcall(LL, 2, 0, 0);
  if(rc) {
    const char* err = lua_tostring(LL, -1);
    fprintf(stderr, "failed calling lua keydown handler: %s\n", err);
    sys_err("keyCallback");
  }
  lua_pop(LL, 1);
}
</pre>

<p>
This is definitely looking hopeful.
</p>

<p>
After work and lunch, back on it. Looking at the code in lua_setKeyCallback.c,
first thing that jumps out at me is that the lua state is stored in a static
var, is that problematic ever? Next, I need to look more closely at the
traceback to see if I can identify what is asserting and why.
</p>

<pre>
LUA_API void lua_settop (lua_State *L, int idx) {
  lua_lock(L);
  if (idx &gt;= 0) {
    api_check(L, idx &lt;= L-&gt;stack_last - L-&gt;base);
    while (L-&gt;top &lt; L-&gt;base + idx)
      setnilvalue(L-&gt;top++);
    L-&gt;top = L-&gt;base + idx;
  }
  else {
    api_check(L, -(idx+1) &lt;= (L-&gt;top - L-&gt;base));
    L-&gt;top += idx+1;  /* `subtract' index (index is negative) */
  }
  lua_unlock(L);
}
</pre>

<P>
So, the assert happens in the lua_pop(), so I'm probably just popping wrong
number of items from stack.
</p>

<p>
ftfm:
</p
<blockquote>
Like [`lua_call`][60], [`lua_pcall`][35] always removes the
function and its arguments from the stack.
</pre>

<p>
So, seems like the pop is a mistake? Why did I add it then?
</p>

<p>
Wow, looking back in the devlog, I discover that I ran into this on 2011-12-12, right
before I dived into ape, and even mentioned trying LUA_USE_APICHECK, which I don't
think I ever did!! I don't remember any of that crap. Thank God for logs.
</p>

<p>
So, further back, I see I added that pop for a reason, to fix growing stack,
back on 2011-09-19. Ok, I am going to write some simple test apps that use
lua_pcall() and do stack checks, so I can really understand what is going on
instead of poking at shit with pointy sticks. But first, time to hit the M.
</p>

<p>
Back from the hike, starting on test_pcall app.
</p>

<h2>2012-04-06</h2>

<p>
A new Friday, up early, back at it.
</p>

<p>
Read some more lua book, chaps 24 and 25, wrote a simple C program
using lua_pcall() and dump_stack, it is more clear now. Commented out
the lua_pop() in lua_setKeyCallback.c.
</p>

<p>
Rebuilt, ran editor, bug is gone. We are back on track.
</p>

<p>
Next: 'j' and 'k' commands.
</p>

<P>
Did it, works, except need 'at-end-of-line' flag like in vim, but will add that later.
next: add 'd(move)' command.
</p>

<p>
Friday afternoon! Time to code.
</p>

<h2>2012-04-07</h2>

<p>
Saturday morning, after much revelry last night. Working on bug introduced
by implementing new line on ASC_RET in insert mode, inserts the new line
but cursor gets shifted to the left for some reason. Created test
app 'test/edit/buffer_insert_newline.lua', but no enlightenment there.
Next, looking at set_cursor code.
</p>

<p>
Just for fun, I might try turning on code-tracing in the debugger again,
now that presumably the bug is fixed that busted it.
</p>

<p>
Adding triggered debug code in edit app, this isn't right:
</p>

<pre>
mhackslab:dist $ r
buffer.draw(): editor.debug_state: b.cursor_pos: (0, 1)
buffer.draw(): editor.debug_state: b.cursor_pos: (-1, 1)
buffer.draw(): editor.debug_state: b.cursor_pos: (0, 0)
buffer.draw(): editor.debug_state: b.cursor_pos: (0, 0)
</pre>

<p>
My first thought is that exposure of the b.cursor_pos var
is causing some external code to improperly change the refs to
it, so first up I will rename with prepended '_' to signify
privacy.
</p>

<p>
This is another indicator:
</p>
<pre>
    -- move cursor back to prev pos
--    buffer.set_cursor(M.buf, cursor.saved_pos)
    local b = editor.active_buf()
    buffer.set_cursor(b, b.cursor_pos)
</pre>

<p>
Ok, -1 cursor_pos is fixed, but still weird diff between
reported b._cursor_pos and screen cursor.
</p>

<p>
Cleaned up some stuff, looks good now. Next: handle row scrolling.
</p>

</body>

</html>
